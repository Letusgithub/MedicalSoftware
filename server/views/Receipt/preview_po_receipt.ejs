<%- include('../partials/headercode.ejs') %>

    <head>

        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js"></script>
        <script type="text/javascript" src="https://html2canvas.hertzen.com/dist/html2canvas.js"></script>
        <link href='https://fonts.googleapis.com/css?family=Poppins' rel='stylesheet'>
        <style>
            .frame1 {
                width: 46.875rem;
                height: 39rem;
                background: #FFF;
            }

            .container {
                position: relative;
                width: 44.2365rem;
                height: 37.0663rem;
                flex-shrink: 0;
                border: 0.2px solid #1E1E1E;

                padding-right: 15px;
                padding-left: 15px;
                margin-right: auto;
                margin-left: auto;
            }

            .shop-name {
                position: relative;
                display: flex;
                width: 16.20863rem;
                height: 1.2455rem;
                flex-direction: column;
                flex-shrink: 0;

                /* top: 0.05rem;
                left: 0.98rem; */

                color: #1E1E1E;
                font-size: 1.25rem;
                font-family: Poppins;
                font-style: normal;
                font-weight: 500;
                line-height: normal;
            }

            .logo-container {
                display: flex;
                width: 7.625rem;
                height: 3.5rem;
                gap: 0.13638rem;
                flex-shrink: 0;

                color: #00ACC1;
            }

            .shop-info {
                margin-top: 0.48rem;
                width: 34.413rem;
                color: #000;
                font-size: 0.625rem;
                font-family: Poppins;
                font-style: normal;
                font-weight: 400;
                line-height: 1rem;
            }

            .shop-info-child1 {
                display: flex;
                width: 12.21775rem;
                height: 2.80238rem;
                flex-direction: column;
                flex-shrink: 0;
            }

            .shop-info-child2 {
                width: 13.933rem;

                flex-shrink: 0;
            }

            .customer-details {
                width: 11.61225rem;
                height: 3.89913rem;
                flex-shrink: 0;

                color: #1E1E1E;
                font-size: 0.625rem;
                font-family: Poppins;
                font-style: normal;
                font-weight: 500;
                line-height: normal;

            }

            .customer-details p {
                display: flex;
                width: 11.61225rem;
                height: 0.78725rem;
                flex-direction: column;
                flex-shrink: 0;
                margin-top: 0.1rem;
                margin-bottom: 0;
            }

            .receipt-type {
                display: flex;
                width: 19.58875rem;
                height: 1.625rem;
                flex-direction: column;
                flex-shrink: 0;
                text-align: center;
                margin: auto;
                margin-top: 0.2rem;

                color: #1E1E1E;
                font-size: 1.25rem;
                font-family: Poppins;
                font-style: normal;
                font-weight: 500;
                line-height: normal;
            }

            .receipt-details {
                width: 11.61225rem;
                height: 2.77413rem;
                flex-shrink: 0;

                color: #1E1E1E;
                font-size: 0.75rem;
                font-family: Poppins;
                font-style: normal;
                font-weight: 400;
                line-height: normal;
            }

            .receipt-details p {
                display: flex;
                width: 11.61225rem;
                height: 0.78725rem;
                flex-direction: column;
                flex-shrink: 0;
                margin-top: 0.2rem;
                margin-bottom: 0;
            }

            .cart-table {
                position: relative;
                left: -1rem;
                width: 44.23000rem;
                height: 14.56863rem;
                border: 0.05rem solid #1E1E1E;

                margin-top: 0.75rem;
            }

            .cart-table thead th {
                color: #000;
                font-size: 0.75rem;
                font-family: Poppins;
                font-style: normal;
                font-weight: 600;
                line-height: normal;
                margin: auto;

                border: 0.05rem solid #1E1E1E;
            }

            .cart-table tbody td {
                border-left: 1px solid #000;
                border-right: 1px solid #000;
                border-top: none !important;

                color: #000;
                font-size: 0.625rem;
                font-family: Poppins;
                font-style: normal;
                font-weight: 400;
                line-height: 0.875rem;
                text-transform: uppercase;
            }

            .footer-1 {
                position: relative;
                left: -1rem;
                top: -0.05rem;
                width: 28.9rem;
                height: 10.15rem;
                border: 0.05rem solid #1E1E1E;

                color: #000;
                font-size: 0.75rem;
                font-family: Poppins;
                font-style: normal;
            }

            .receipt-msg {
                border-bottom: 0.05rem solid #1E1E1E;
                height: 1.76rem;
                font-weight: 300;
                line-height: normal;
            }

            .receipt-tnc {
                font-weight: 600;
                line-height: normal;
                text-decoration-line: underline;
                margin-left: 0.34rem;
                margin-top: 0.47rem;

                height: 5.95rem;
            }

            .receipt-sign {
                border-top: 0.05rem solid #1E1E1E;
                width: 9.03875rem;
                font-weight: 600;
                line-height: normal;
                text-align: center;

                margin-left: auto;
                margin-bottom: 1rem;
            }

            .footer-2 {
                width: 13.25rem;
                height: 10.15rem;

                color: #000;
                font-size: 0.75rem;
                font-family: Poppins;
                font-style: normal;
            }

            .cart-summary {
                height: 7.32rem;
                border-bottom: 0.05rem solid #1E1E1E;
            }

            .cart-summary .label {
                font-weight: 600;
            }

            .cart-total {
                font-size: 1rem;
                font-weight: 600;
            }

            .line-1 {
                left: -1rem;
                width: 42.11925rem;
                height: 0rem;
                flex-shrink: 0;
                color: #1E1E1E;
                margin: 0.15rem 0rem 0.2rem 0rem;
            }

            .watermark,
            .watermark-receipt {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: rgba(255, 0, 0, 0.3);
                font-size: 5rem;
                z-index: 2;
                pointer-events: none;
            }

            @media (max-width: 768px) {
                .watermark {
                    font-size: 3rem;
                }
            }

            @media (max-width: 576px) {
                .watermark {
                    font-size: 2rem;
                }
            }
        </style>

    </head>

    <body>
        <!-- Layout wrapper -->
        <div class="layout-wrapper layout-content-navbar" style="background-image:url(/images/receipt-bg3.png);">
            <div class="layout-container">
                <!-- sidebar imported -->
                <%- include('../partials/sidebar.ejs') %>

                    <!-- Layout container -->
                    <div class="layout-page">
                        <!-- navbar imported -->
                        <%- include('../partials/navbar.ejs') %>

                            <!-- Content wrapper -->
                            <div class="content-wrapper">
                                <!-- Content -->

                                <div class="container-xxl flex-grow-1 container-p-y">
                                    <div class="row invoice-preview">

                                        <!-- Invoice responsive template -->

                                        <div class="col-xl-9 col-md-8 col-12 mb-md-0 mb-4">
                                            <div class="watermark" style="display: none;"></div>
                                            <div class="card invoice-preview-card">
                                                <div class="card-body pb-0 text-center">
                                                    <h3 class="text-body fw-bold">Purchase Order</h3>
                                                    <hr class="my-0">
                                                </div>
                                                <div class="card-body">
                                                    <div
                                                        class="row flex-xl-row flex-md-column flex-sm-row flex-column p-sm-3 p-0">
                                                        <div class="col-xl-6 col-md-12 col-sm-5 col-12 mb-xl-0 mb-4">
                                                            <div class="d-flex mb-3 gap-2">
                                                                <span class="orgname fs-4 text-body fw-bold"></span>
                                                            </div>
                                                            <p class="mb-1 orgaddress"></p>
                                                        </div>
                                                        <div class="col-xl-6 col-md-12 col-sm-5 col-12">
                                                            <div class="mb-2">
                                                                <span class="fw-medium gstin"></span>
                                                            </div>
                                                            <div class="mb-2">
                                                                <span class="fw-medium dlno1"></span>
                                                            </div>
                                                            <div class="mb-2">
                                                                <span class="fw-medium dlno2"></span>
                                                            </div>
                                                            <div class="mb-2">
                                                                <span class="fw-medium flno"></span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <hr class="my-0">
                                                <div class="card-body">
                                                    <div class="row p-sm-3 p-0">
                                                        <div
                                                            class="col-xl-4 col-md-12 col-sm-4 col-12 mb-xl-0 mb-md-4 mb-sm-0 mb-4">
                                                            <p class="mb-1 vendorname fw-bold"></p>
                                                            <p class="mb-1 vendormobile"></p>
                                                            <p class="mb-1 vendoremail"></p>
                                                            <p class="mb-0 vendoradd"></p>
                                                        </div>
                                                        <div
                                                            class="col-xl-4 col-md-12 col-sm-4 col-12 mb-xl-0 mb-md-4 mb-sm-0 mb-4">
                                                            <p class="mb-1 vendorgst"></p>
                                                            <p class="mb-1 vendordl"></p>
                                                            <p class="mb-1 vendorFssai"></p>
                                                            <p class="mb-1 paymentMethod"></p>
                                                        </div>
                                                        <div class="col-xl-4 col-md-12 col-sm-4 col-12">
                                                            <p class="mb-1 orderdate"></p>
                                                            <p class="mb-1 pono"></p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="table-responsive">
                                                    <table class="table border-top m-0">
                                                        <thead>
                                                            <tr>
                                                                <th>S.N.</th>
                                                                <th>Item</th>
                                                                <th>Brand</th>
                                                                <th>QTY</th>
                                                                <th>Unit</th>
                                                                <th>PTR(₹)</th>
                                                                <th>MRP(₹)</th>
                                                                <th>Amount(₹)</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody class="cartitems">

                                                        </tbody>
                                                    </table>
                                                </div>

                                                <div class="row card-body">
                                                    <div
                                                        class="col-xl-8 col-md-12 col-sm-5 col-12 mb-xl-0 mb-md-4 mb-sm-0 mb-4">

                                                    </div>
                                                    <div class="col-xl-4 col-md-12 col-sm-7 col-12">
                                                        <table>
                                                            <tbody>
                                                                <tr class="pb-3">
                                                                    <td class="pe-3">Total Amount(₹):</td>
                                                                    <td class="grandtotal"></td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>

                                                <div class="card-body">
                                                    <div class="d-flex justify-content-between">
                                                        <div>
                                                            <span>“GET WELL SOON BY DAWA.AI”</span>
                                                        </div>
                                                        <div>
                                                            <button type="button" class="btn btn-label-danger"
                                                                id="cancelReceipt">Cancel Receipt</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- /Invoice responsive template -->


                                        <!-- Invoice -->

                                        <div class="frame1" id="html-content" style="display: none;">
                                            <div class="container">
                                                <div class="watermark-receipt" style="display: none;"></div>
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <div class="shop-name orgname">

                                                        </div>
                                                        <div class="shop-info d-flex justify-content-between">
                                                            <div class="shop-info-child1 orgaddress">

                                                            </div>
                                                            <div class="shop-info-child2" style="width: 41vw;">
                                                                <p class="my-0 flno">F.L. no.:</p>
                                                                <p class="my-0 gstin">GSTIN:</p>
                                                                <p class="my-0 dlno1">DL No 1:</p>
                                                                <p class="my-0 dlno2">DL No 2:</p>

                                                            </div>
                                                        </div>

                                                    </div>
                                                    <div class="logo-container">
                                                        <img src="/images/logo.svg"></img>
                                                    </div>
                                                </div>
                                                <hr class="line-1">
                                                <div class="receipt-type">
                                                    Purchase Order
                                                </div>
                                                <div class="d-flex justify-content-between">
                                                    <div class="customer-details">
                                                        <p style="font-weight: 600;" class="vendorname">
                                                            Name:
                                                        </p>
                                                        <p class="vendormobile">
                                                            Mobile:
                                                        </p>
                                                        <p class="vendoremail">
                                                            Email:
                                                        </p>
                                                        <p class="vendoradd">
                                                            Address:
                                                        </p>

                                                    </div>
                                                    <div class="receipt-details">
                                                        <p class="vendorgst">
                                                            GSTIN:
                                                        </p>
                                                        <p class="vendordl">
                                                            D.L.no.:
                                                        </p>
                                                        <!-- <p id="vendorfl">
                                                            F.L. no.:
                                                        </p> -->
                                                    </div>
                                                    <div class="receipt-details">
                                                        <p class="orderdate">
                                                            Date:
                                                        </p>
                                                        <p class="pono">
                                                            P.O. No.:
                                                        </p>
                                                    </div>

                                                </div>
                                                <table class="cart-table">
                                                    <thead>
                                                        <tr>
                                                            <th style="width: 2.27rem;">S.N.</th>
                                                            <th style="width: 12.8rem;">Item</th>
                                                            <th style="width: 14.8rem;">Brand</th>
                                                            <th style="width: 6.82rem;">QTY</th>
                                                            <th style="width: 6.75rem;">Unit</th>
                                                            <th style="width: 5.98rem;">PTR(₹)</th>
                                                            <th style="width: 5.98rem;">MRP(₹)</th>
                                                            <th style="width: 6.21rem;">Amount(₹)</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody class="cartitems">
                                                        <!-- <tr>
                                                            <td style="width: 2.27rem; height: 1rem;">1</td>
                                                            <td style="width: 12.8rem; height: 1rem;">wyx</td>
                                                            <td style="width: 14.8rem; height: 1rem;">wyx</td>
                                                            <td style="width: 6.82rem; height: 1rem;">wyx</td>
                                                            <td style="width: 6.75rem; height: 1rem;">wyx</td>
                                                            <td style="width: 5.98rem; height: 1rem;">wyx</td>
                                                            <td style="width: 6.21rem; height: 1rem;">wyx</td>
                                                            <td style="width: 5.98rem; height: 1rem;">wyx</td>
                                                        </tr> -->

                                                    </tbody>
                                                </table>
                                                <div class="d-flex flex-row">
                                                    <div class="footer-1">
                                                        <div class="receipt-msg">
                                                            <p>
                                                                Purchase Order generated by DAWA.AI
                                                            </p>
                                                        </div>
                                                        <div class="receipt-info">
                                                            <div class="receipt-tnc">
                                                                <p>Terms & Conditions</p>
                                                            </div>
                                                            <div class="receipt-sign">
                                                                Authorised Signature
                                                            </div>

                                                        </div>
                                                    </div>
                                                    <div class="footer-2">
                                                        <div class="cart-summary">



                                                        </div>
                                                        <div class="cart-total">
                                                            <div class="d-flex justify-content-between my-2">
                                                                <div>
                                                                    Amount(₹):
                                                                </div>
                                                                <div class="grandtotal"> </div>
                                                            </div>
                                                        </div>


                                                    </div>
                                                </div>

                                            </div>




                                        </div>

                                        <!-- /Invoice -->

                                        <!-- Invoice Actions -->
                                        <div class="col-xl-3 col-md-4 col-12 invoice-actions">
                                            <div class="card">
                                                <div class="card-body">
                                                    <button
                                                        class="btn btn-primary btn-label-secondary d-grid w-100 mb-3"
                                                        type="button" onclick="CreatePDFfromHTML()">
                                                        Download
                                                    </button>
                                                    <!-- <button class="btn btn-label-secondary d-grid w-100" type="button"
                                                        onclick="history.back()">
                                                        Back
                                                    </button> -->
                                                </div>
                                            </div>
                                        </div>
                                        <!-- /Invoice Actions -->
                                    </div>

                                </div>
                                <!-- / Content -->
                            </div>
                    </div>
            </div>
        </div>

        <%- include('../partials/footercode.ejs') %>

            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>

            <script>
                $(document).ready(function () {
                    var id = '<%=id%>';

                    $.get(`/api/getpoininvoice?id=${id}`, function (data, status) {
                        //var podata= data.result[0];
                        console.log('inside the po invoice', data);

                        var podata = data.data[0];

                        // Check if receipt is cancelled
                        if (podata.po_status === "cancelled") {
                            $(".watermark, .watermark-receipt").text("CANCELLED").show();
                            $("#cancelReceipt").hide();
                        }

                        var options = { year: 'numeric', month: 'long', day: 'numeric' };
                        var invoiceDate = new Date(podata.po_created_date);
                        var formattedDate = invoiceDate.toLocaleDateString('en-US', options);
                        $(".orderdate").text(`Date: ${formattedDate}`);

                        $(".pono").text(`P.O.:${podata.po_id_main}`)
                        $(".vendorname").text(`Name: ${podata.vendor_name ? podata.vendor_name : 'NA'}`)
                        $(".vendormobile").text(`Mobile: ${podata.vendor_contact ? podata.vendor_contact : 'NA'}`)
                        $(".vendoremail").text(`Email: ${podata.vendor_email ? podata.vendor_email : 'NA'}`)
                        $(".vendoradd").text(`Address: ${podata.vendor_address ? podata.vendor_address : 'NA'}`)
                        $(".vendorgst").text(`GSTIN: ${podata.vendor_gstin ? podata.vendor_gstin : 'NA'}`)
                        $(".vendordl").text(`DL.no: ${podata.vendor_dl_no_1 ? podata.vendor_dl_no_1 : 'NA'}, ${podata.vendor_dl_no_2 ? podata.vendor_dl_no_2 : 'NA'}`)
                        var items = data.data;

                        var totalAmt = 0;
                        for (var i = 0; i < items.length; i++) {

                            totalAmt += parseFloat(items[i].amount);

                            //var total = items[i].mrp * items[i].quantity - items[i].mrp * items[i].quantity * (items[i].unit_discount) / 100;
                            cartHtml =
                                `<tr>
                                    <td style="width: 2.27rem; height: 1rem;">${i + 1}</td>
                                    <td style="width: 12.8rem; height: 1rem;">${items[i].med_name}</td>
                                    <td style="width: 14.8rem; height: 1rem;">${items[i].mfd_mkt}</td>
                                    <td style="width: 6.82rem; height: 1rem;">${items[i].quantity}</td>
                                    <td style="width: 6.75rem; height: 1rem;">${items[i].unit}</td>
                                    <td style="width: 5.98rem; height: 1rem;">${items[i].ptr}</td>
                                    <td style="width: 5.98rem; height: 1rem;">${items[i].mrp}</td>
                                    <td style="width: 6.21rem; height: 1rem;">${items[i].amount}</td>
                                </tr>`;
                            $(".cartitems").append(cartHtml);

                        }
                        $(".grandtotal").text((totalAmt * 1).toFixed(2));
                    })

                    $.get(`/api/org/<%=orgId%>`, function (data, status) {
                        var org = data.data
                        var orgName = org.org_name;
                        var orgNumber = org.org_telephone;
                        var orgAdd = org.org_address;

                        $(".orgname").html(`${orgName}`);

                        $(".orgaddress").html(`
                            ${orgAdd}</br>
                            ${org.org_city}( ${org.org_state} ), ${org.org_pincode}</br>
                            ${org.org_telephone}
                        `)
                        $(".gstin").text(`GSTIN: ${org.org_gstin ? org.org_gstin : 'NA'}`);
                        $(".dlno1").text(`DL No 1: ${data.data.org_dl_no_1 ? data.data.org_dl_no_1 : 'NA'}`)
                        $(".dlno2").text(`DL No 2: ${data.data.org_dl_no_2 ? data.data.org_dl_no_2 : 'NA'}`)
                        $(".flno").text(`FSSAI: ${org.org_fssai_no ? org.org_fssai_no : 'NA'}`)
                    })

                    //Order cancellation button
                    $('#cancelReceipt').on('click', function (e) {
                        e.preventDefault(); // Prevent the default action
                        Swal.fire({
                            title: 'Are you sure?',
                            text: "You won't be able to revert this!",
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Yes, cancel it!'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                // Perform the cancellation action here
                                $.get(`/api/cancelPurchaseorder?poId=${id}&orgId=<%=orgId%>`, function (data) {
                                    if (data.success == 1) {
                                        Swal.fire(
                                            'Cancelled!',
                                            'The receipt has been cancelled.',
                                            'success'
                                        ).then(() => {
                                            location.reload();
                                        })
                                    } else {
                                        Swal.fire(
                                            'Error!',
                                            'There was an error cancelling the receipt.',
                                            'error'
                                        )
                                    }
                                })
                            }
                        })
                    });

                })
            </script>


            <script>
                function CreatePDFfromHTML() {
                    $("#html-content").show();
                    var HTML_Width = $("#html-content").width();
                    var HTML_Height = $("#html-content").height();
                    var top_left_margin = 15;
                    var PDF_Width = HTML_Width + (top_left_margin * 2);
                    var PDF_Height = (PDF_Width * 1.5) + (top_left_margin * 2);
                    var canvas_image_width = HTML_Width;
                    var canvas_image_height = HTML_Height;

                    var totalPDFPages = Math.ceil(HTML_Height / PDF_Height) - 1;

                    html2canvas($("#html-content")[0]).then(function (canvas) {
                        var imgData = canvas.toDataURL("image/jpeg", 1.0);
                        var pdf = new jsPDF('p', 'pt', [PDF_Width, PDF_Height]);
                        pdf.addImage(imgData, 'JPG', top_left_margin, top_left_margin, canvas_image_width, canvas_image_height);
                        for (var i = 1; i <= totalPDFPages; i++) {
                            pdf.addPage(PDF_Width, PDF_Height);
                            pdf.addImage(imgData, 'JPG', top_left_margin, -(PDF_Height * i) + (top_left_margin * 4), canvas_image_width, canvas_image_height);
                        }
                        pdf.save("invoice.pdf");
                        $("#html-content").hide();
                    });
                }
            </script>

    </body>

    </html>