<%- include('../partials/headercode.ejs') %>

    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js"></script>
        <script type="text/javascript" src="https://html2canvas.hertzen.com/dist/html2canvas.js"></script>
        <link href='https://fonts.googleapis.com/css?family=Poppins' rel='stylesheet'>
        <style>



            /* ------------------------------------------------- */

                /* Default width for larger screens */
                #html-content {
                    
                    margin: 0; /* Center align */
                }

            /* Adjustments for mobile devices */
            @media (max-width: 767px) {
                #html-content {
                    width: 92%;
                    margin: 0 0; /* Center align */
                }
            }

                .table-bordered th, .table-bordered td {
                    padding: 3px; /* Adjust padding as needed */
                    /*padding-left: 5px;*/
                    /*padding-right: 5px;*/
                    text-align: center; /* Center align text */
                }
                .table-bordered th {
                    background-color: #f8f9fa; /* Optional: Add background color for headers */
                    border-top: none;
                }
                .table-of-receipt th, .table-of-receipt td{
                    padding: 0px; /* Adjust padding as needed */
                    padding-left: 1px;
                    padding-right: 1px;
                    text-align: center; /* Center align text */
                    margin: 0;
                    padding-top: -5px;
                    margin-top: -10px;

                }

                .cartitems tr, td{
                    margin-top:0 !important;
                    margin-bottom: 0 !important;
                    padding-top: 0 !important;
                    padding-bottom: 0 !important;
                }
            /* ------------------------------------------------- */
            .frame1 {
                width: 55rem;
                height: 39rem;
                background: #FFF;
                padding: 15px;
            }

            .receipt-container {
                /* background-image: url("/images/receipt-bg3.png"); */
                padding-right: 15px;
                padding-left: 15px;
                margin-right: auto;
                margin-left: auto;

                position: relative;
                width: 50.2365rem;
                height: 31.97663rem;
                flex-shrink: 0;
                border: 0.2px solid #1E1E1E;
            }

            .shop-name {
                position: relative;
                display: flex;
                width: 16.20863rem;
                height: 1.2455rem;
                flex-direction: column;
                flex-shrink: 0;

                color: #1E1E1E;
                font-size: 1.25rem;
                font-family: Poppins;
                font-style: normal;
                font-weight: 500;
                line-height: normal;
            }

            .logo-container {
                display: flex;
                width: 7.625rem;
                height: 3.5rem;
                gap: 0.13638rem;
                flex-shrink: 0;

                color: #00ACC1;
            }

            .shop-info {
                margin-top: 0.48rem;
                width: 34.413rem;
                color: #000;
                font-size: 0.625rem;
                font-family: Poppins;
                font-style: normal;
                font-weight: 400;
                line-height: 1rem;
            }

            .shop-info-child1 {
                display: flex;
                width: 12.21775rem;
                height: 2.80238rem;
                flex-direction: column;
                flex-shrink: 0;
            }

            .shop-info-child2 {
                width: 13.933rem;
                height: 2.86188rem;
                flex-shrink: 0;
            }

            .customer-details {
                width: 11.61225rem;
                height: 3.89913rem;
                flex-shrink: 0;

                color: #1E1E1E;
                font-size: 0.625rem;
                font-family: Poppins;
                font-style: normal;
                font-weight: 500;
                line-height: normal;

            }

            .customer-details p {
                display: flex;
                width: 11.61225rem;
                height: 0.78725rem;
                flex-direction: column;
                flex-shrink: 0;
                margin-top: 0.1rem;
                margin-bottom: 0;
            }

            .receipt-type {
                display: flex;
                width: 8.40925rem;
                height: 1.2455rem;
                flex-direction: column;
                flex-shrink: 0;

                color: #1E1E1E;
                font-size: 1.25rem;
                font-family: Poppins;
                font-style: normal;
                font-weight: 500;
                line-height: normal;
            }

            .receipt-details {
                width: 11.61225rem;
                height: 2.77413rem;
                flex-shrink: 0;

                color: #1E1E1E;
                font-size: 0.75rem;
                font-family: Poppins;
                font-style: normal;
                font-weight: 400;
                line-height: normal;
            }

            .receipt-details p {
                display: flex;
                width: 11.61225rem;
                height: 0.78725rem;
                flex-direction: column;
                flex-shrink: 0;
                
                margin-bottom: 0;
            }

            .cart-table {
                position: relative;
                width: 50.2365rem;
                height: 10.56863rem;
                border: 0.05rem solid #1E1E1E;
                left: -1rem;
                margin-top: 0.75rem;
            }

            .cart-table thead th {
                color: #000;
                font-size: 0.75rem;
                font-family: Poppins;
                font-style: normal;
                font-weight: 600;
                line-height: normal;
                margin: auto;

                border: 0.05rem solid #1E1E1E;
                
            }

            .cart-table tbody td {
                border-left: 1px solid #000;
                border-right: 1px solid #000;
                border-top: none !important;
                height: 0;
                color: #000;
                font-size: 0.625rem;
                font-family: Poppins;
                font-style: normal;
                font-weight: 400;
                line-height: 0.875rem;
                text-transform: uppercase;
                margin-top:0 !important;
                margin-bottom: 0 !important;
                padding-top: 0 !important;
                padding-bottom: 0 !important;
            }

            .footer-gst-distribution {
                position: relative;
                left: -1rem;
                width: 19.03875rem;
                height: 10rem;

                color: #000;
                font-size: 0.625rem;
                font-family: Poppins;
                font-style: normal;
                font-weight: 400;
                line-height: 0.875rem;
                text-transform: uppercase;
            }

            .footer-gst-distribution thead th {
                color: #000;
                line-height: normal;
                margin: auto;
                border: 0.05rem solid #1E1E1E;
            }

            .footer-gst-distribution tbody td {
                border: 1px solid #000;
                color: #000;
                font-size: 0.625rem;
                font-family: Poppins;
                font-style: normal;
                font-weight: 400;
                line-height: 0.875rem;
                text-transform: uppercase;
                padding-right: 0rem;
            }


            .footer-1 {
                position: relative;
                left: -1rem;
                top: -0.05rem;
                width: 20.2rem;
                height: 10.10rem;
                border: 0.05rem solid #1E1E1E;

                color: #000;
                font-size: 0.75rem;
                font-family: Poppins;
                font-style: normal;
            }

            .receipt-msg {
                border-bottom: 0.05rem solid #1E1E1E;
                height: 1.76rem;
                font-weight: 300;
                line-height: normal;
            }

            .receipt-tnc .header {
                font-weight: 600;
                line-height: normal;
                text-decoration-line: underline;
                margin-left: 0.34rem;
                margin-top: 0.47rem;

                height: 5.95rem;
            }

            .receipt-tnc {
                font-weight: 300;
                line-height: normal;
                margin-left: 0.34rem;
                margin-top: 0.47rem;

                height: 5.95rem;
            }


            .receipt-sign {
                border-top: 0.05rem solid #1E1E1E;
                width: 9.03875rem;
                font-weight: 600;
                line-height: normal;
                text-align: center;

                margin-left: auto;
                margin-bottom: 1rem;
            }

            .footer-2 {
                width: 13.25rem;
                height: 10.15rem;

                color: #000;
                font-size: 0.75rem;
                font-family: Poppins;
                font-style: normal;
            }

            .cart-summary {
                height: 7.32rem;
                border-bottom: 0.05rem solid #1E1E1E;
            }

            .cart-summary .label {
                font-weight: 600;
            }

            .cart-total {
                font-size: 1rem;
                font-weight: 600;
            }

            .watermark,
            .watermark-receipt {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: rgba(255, 0, 0, 0.3);
                font-size: 5rem;
                z-index: 2;
                pointer-events: none;
            }

            @media (max-width: 768px) {
                .watermark {
                    font-size: 3rem;
                }
            }

            @media (max-width: 576px) {
                .watermark {
                    font-size: 2rem;
                }
            }
        </style>
    </head>

    <body>
        <!-- Layout wrapper -->
        <div class="layout-wrapper layout-content-navbar" style="background-image:url(/images/receipt-bg3.png);">
            <div class="layout-container">
                <!-- sidebar imported -->
                <%- include('../partials/sidebar.ejs') %>

                    <!-- Layout container -->
                    <div class="layout-page">
                        <!-- navbar imported -->
                        <%- include('../partials/navbar.ejs') %>

                            <!-- Content wrapper -->
                            <div class="content-wrapper">
                                <!-- Content -->
                                <div class="container-xxl flex-grow-1 container-p-y">


                                    <div class="row invoice-preview justify-content-center">

                                        <!-- Invoice responsive template -->

                                        <div class="col-xl-10 col-md-10 col-12 mb-md-0 mb-4 ml-4">
                                            <div class="watermark" style="display: none;"></div>
                                            <div class="card invoice-preview-card">
                                                <div class="card-body pb-0 text-center">
                                                    <h3 class="text-body fw-bold">Sales Invoice</h3>
                                                    <hr class="my-0 pb-0">
                                                </div>
                                                <div class="card-body">
                                                    <div
                                                        class="row flex-xl-row flex-md-column flex-sm-row flex-column p-sm-3 p-0">
                                                        <div class="col-xl-6 col-md-12 col-sm-5 col-12 mb-xl-0 mb-4">
                                                            <div class="d-flex mb-2 gap-2">
                                                                <span
                                                                    class="pharmacyName fs-4 text-body fw-bold"></span>
                                                            </div>
                                                            <p class="mb-0 shopaddress pb-0"></p>
                                                        </div>
                                                        <div class="col-xl-6 col-md-12 col-sm-5 col-12 mt-2">
                                                            <div class="mb-0 ">
                                                                <span class="fw-medium dlno1"></span>
                                                            </div>
                                                            <div class="mb-0 ">
                                                                <span class="fw-medium dlno2"></span>
                                                            </div>
                                                            <div class="mb-0 ">
                                                                <span class="fw-medium flno"></span>
                                                            </div>
                                                            <div class="mb-0 ">
                                                                <span class="fw-medium gstin"></span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <hr class="my-0 py-0">
                                                <div class="card-body">
                                                    <div class="row p-sm-3 p-0">
                                                        <div
                                                            class="col-xl-6 col-md-12 col-sm-5 col-12 mb-xl-0 mb-md-4 mb-sm-0 mb-4">
                                                            <h6 class="pb-1">Invoice To:</h6>
                                                            <p class="mb-0 customername fw-bold"></p>
                                                            <p class="mb-0 shippingadd"></p>
                                                            <p class="mb-0 mobilenumber"></p>
                                                            <p class="mb-0 doctorname"></p>
                                                        </div>
                                                        <div class="col-xl-6 col-md-12 col-sm-7 col-12 ">
                                                            <h6 class="pb-1">Invoice Details:</h6>
                                                            <p class="mb-0 fw-bold invoicenumber"></p>
                                                            <p class="mb-0 orderdate"></p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="table-responsive">
                                                    <table class="table border-top m-0">
                                                        <thead>
                                                            <tr>
                                                                <th>Item</th>
                                                                <th>Quantity</th>
                                                                <th>HSN</th>
                                                                <th>Batch</th>
                                                                <th>Expiry</th>
                                                                <th>MRP(₹)</th>
                                                                <th>GST%</th>
                                                                <th>Discount%</th>
                                                                <th>Total(₹)</th>

                                                            </tr>
                                                        </thead>
                                                        <tbody class="cartitems">
                                                            <!-- <tr>
                                                                <td class="text-nowrap">Vuexy Admin </td>
                                                                <td class="text-nowrap">HTML </td>
                                                                <td>$32</td>
                                                                <td>1</td>
                                                                <td>$32.00</td>
                                                                <td></td>
                                                                <td></td>
                                                                <td></td>
                                                                <td>$32.00</td>
                                                            </tr> -->


                                                        </tbody>
                                                    </table>
                                                </div>
                                                <div class="row card-body">
                                                    <div
                                                        class="col-xl-8 col-md-12 col-sm-5 col-12 mb-xl-0 mb-md-4 mb-sm-0 mb-4">
                                                        <table class="table-bordered mb-0 pb-0">
                                                            <thead>
                                                                <tr>
                                                                    <th>GST%</th>
                                                                    <th>Taxable Amt</th>
                                                                    <th>CGST</th>
                                                                    <th>SGST</th>
                                                                    <th>Total GST</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody class="p-0">
                                                                <tr>
                                                                    <td>0%</td>
                                                                    <td class="taxAmt0"></td>
                                                                    <td class="cgst-0"></td>
                                                                    <td class="sgst-0"></td>
                                                                    <td class="totalGst0"></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>5%</td>
                                                                    <td class="taxAmt5"></td>
                                                                    <td class="cgst-5"></td>
                                                                    <td class="sgst-5">
                                                                    </td>
                                                                    <td class="totalGst5"></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>12%</td>
                                                                    <td class="taxAmt12"></td>
                                                                    <td class="cgst-12"></td>
                                                                    <td class="sgst-12">
                                                                        <!-- </tdid> -->
                                                                    <td class="totalGst12"></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>18%</td>
                                                                    <td class="taxAmt18"></td>
                                                                    <td class="cgst-18"></td>
                                                                    <td class="sgst-18">
                                                                        <!-- </tdid> -->
                                                                    <td class="totalGst18"></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>Total</td>
                                                                    <td class="taxAmtTotal"></td>
                                                                    <td class="cgstTotal"></td>
                                                                    <td class="sgstTotal"></td>
                                                                    <td class="totalGst"></td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    <div class="col-xl-4 col-md-12 col-sm-7 col-12 mt-3">
                                                        <table>
                                                            <tbody>

                                                                <tr class="pb-3">
                                                                    <td class="pe-3">Sub Total (₹):</td>
                                                                    <td class="subtotal"></td>
                                                                </tr>
                                                                <tr class="pb-3">
                                                                    <td class="pe-3">Add Discount (₹):</td>
                                                                    <td class="additionaldisc"></td>
                                                                </tr>
                                                                <tr class="pb-3">
                                                                    <td class="pe-3">Payment:</td>
                                                                    <td class="mop"></td>
                                                                </tr>
                                                                <tr class="pb-3">
                                                                    <td class="pe-3">Total(₹):</td>
                                                                    <td class="grandtotal"></td>
                                                                </tr>

                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>


                                                <div class="card-body ">
                                                    <div class="d-flex justify-content-between">
                                                        <div class="justify-content-center">
                                                            <span>“GET WELL SOON BY DAWA.AI”</span>
                                                        </div>
                                                        <div>
                                                            <button type="button" class="btn btn-label-danger"
                                                                id="cancelReceipt">Cancel Receipt</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- /Invoice responsive template -->


                                        <!-- Invoice -->


                                        <div class="frame1" id="html-content" style="display: none;">
                                            <div class="receipt-container">
                                                <div class="watermark-receipt" style="display: none;"></div>
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <div class="shop-name pharmacyName"></div>
                                                        <div class="shop-info d-flex justify-content-between">
                                                            <div class="shop-info-child1 shopaddress"></div>
                                                            <div class="shop-info-child2">
                                                                <p class="my-0 dlno1" id="">DL No 1:</p>
                                                                <p class="my-0 dlno2" id="">DL No 2:</p>
                                                                <p class="my-0 flno" id="">FSSAI :</p>
                                                                <p class="my-0 gstin" id="">GSTIN :</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="logo-container">
                                                        <img src="/images/logo.svg">
                                                    </div>
                                                </div>
                                                <hr class="px-0">
                                                <div class="d-flex justify-content-between">
                                                    <div class="customer-details">
                                                        <p class="customername" style="font-weight: 600;">
                                                            Patient name:
                                                        </p>
                                                        <p class="mobilenumber">
                                                            Mobile:
                                                        </p>
                                                        <p class="shippingadd">
                                                            Shipping Address:
                                                        </p>
                                                        <p class="doctorname">
                                                            Dr name:
                                                        </p>

                                                    </div>
                                                    <div class="receipt-type">
                                                        Sales Invoice
                                                    </div>
                                                    <div class="receipt-details">
                                                        <p class="orderdate">
                                                            Date:
                                                        </p>
                                                        <p class="invoicenumber">
                                                            Invoice no.:
                                                        </p>
                                                    </div>

                                                </div>
                                                <table class="cart-table table-of-receipt">
                                                    <thead>
                                                        <tr>
                                                            <th style="width: 11.29rem;">Item</th>
                                                            <th style="width: 3.1rem;">Quantity</th>
                                                            <th style="width: 4.59rem;">HSN</th>
                                                            <th style="width: 4.4rem;">Batch</th>
                                                            <th style="width: 3.25rem;">Expiry</th>
                                                            <th style="width: 3.62rem;">MRP(₹)</th>
                                                            <th style="width: 3.61rem;">GST%</th>
                                                            <th style="width: 3.91rem;">Discount%</th>
                                                            <th style="width: 4.2rem;">Total(₹)</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody class="cartitems py-0 my-0">



                                                    </tbody>
                                                </table>
                                                <div class="d-flex flex-row">
                                                    <table class="footer-gst-distribution table-bordered">
                                                        <thead>
                                                            <tr>
                                                                <th>GST%</th>
                                                                <th>Taxable Amt</th>
                                                                <th>CGST</th>
                                                                <th>SGST</th>
                                                                <th>Total GST</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody class="p-0 px-1">
                                                            <tr>
                                                                <td>0%</td>
                                                                <td class="taxAmt0"></td>
                                                                <td class="cgst-0"></td>
                                                                <td class="sgst-0"></td>
                                                                <td class="totalGst0"></td>
                                                            </tr>
                                                            <tr>
                                                                <td>5%</td>
                                                                <td class="taxAmt5"></td>
                                                                <td class="cgst-5"></td>
                                                                <td class="sgst-5">
                                                                </td>
                                                                <td class="totalGst5"></td>
                                                            </tr>
                                                            <tr>
                                                                <td>12%</td>
                                                                <td class="taxAmt12"></td>
                                                                <td class="cgst-12"></td>
                                                                <td class="sgst-12">
                                                                </td>
                                                                <td class="totalGst12"></td>
                                                            </tr>
                                                            <tr>
                                                                <td>18%</td>
                                                                <td class="taxAmt18"></td>
                                                                <td class="cgst-18"></td>
                                                                <td class="sgst-18">
                                                                </td>
                                                                <td class="totalGst18"></td>
                                                            </tr>
                                                            <tr>
                                                                <td>Total</td>
                                                                <td class="taxAmtTotal"></td>
                                                                <td class="cgstTotal"></td>
                                                                <td class="sgstTotal"></td>
                                                                <td class="totalGst"></td>
                                                            </tr>
                                                        </tbody style="border-collapse: collapse;">
                                                    </table>

                                                    <div class="footer-1">
                                                        <div class="receipt-msg mx-5">
                                                            <p class="justify-content-center mx-auto">
                                                                “GET WELL SOON BY DAWA.AI”
                                                            </p>
                                                        </div>
                                                        <div class="receipt-info">
                                                            <div class="receipt-tnc">
                                                                <div class="mx-5">
                                                                    <div>Terms & Conditions</div>
                                                                    <p >Confirm Medicines from your Doctor before
                                                                        use
                                                                    </p>
                                                                        
                                                                        <!-- <p>I/We declare that this invoice shows
                                                                            actual
                                                                            price of goods and services and that all
                                                                            particulars are true and correct.</p> -->
                                                
                                                                </div>
                                                                


                                                            </div>
                                                            <div class="receipt-sign">
                                                                Authorised Signature
                                                            </div>

                                                        </div>
                                                    </div>
                                                    <div class="footer-2">
                                                        <div class="cart-summary">
                                                            <div class="d-flex justify-content-between">
                                                                <div class="label">
                                                                    Sub Total (₹):
                                                                </div>
                                                                <div class="subtotal">
                                                                </div>
                                                            </div>
                                                            <div class="d-flex justify-content-between">
                                                                <div class="label">
                                                                    Add Discount (₹):
                                                                </div>
                                                                <div class="additionaldisc">

                                                                </div>
                                                            </div>
                                                            <div class="d-flex justify-content-between mb-2">
                                                                <div class="label">
                                                                    Payment:
                                                                </div>
                                                                <div class="mop">
                                                                </div>
                                                            </div>

                                                        </div>
                                                        <div class="cart-total">
                                                            <div class="d-flex justify-content-between my-2">
                                                                <div>
                                                                    Amount(₹):
                                                                </div>
                                                                <div class="grandtotal">

                                                                </div>
                                                            </div>
                                                        </div>


                                                    </div>
                                                </div>

                                            </div>

                                        </div>



                                        <!-- /Invoice -->

                                        <!-- Invoice Actions -->
                                        <div class="col-xl-3 col-md-4 col-12 invoice-actions">
                                            <div class="pt-3">
                                                <div class="d-flex justify-content-center">
                                                    <!-- <button class="btn btn-primary d-grid w-100 mb-3" data-bs-toggle="offcanvas" data-bs-target="#sendInvoiceOffcanvas">
                                                    <span class="d-flex align-items-center justify-content-center text-nowrap"><i class="bx bx-paper-plane bx-xs me-1"></i>Send Invoice</span>
                                                  </button> -->
                                                    <button
                                                        class="btn btn-primary btn-label-secondary d-grid w-100 mb-3 mx-1"
                                                        type="button" onclick="CreatePDFfromHTML()">
                                                        Download
                                                    </button>
                                                    <button class="btn btn-success d-grid w-100 mb-3 mx-1" type="button"
                                                        id="whatsappLink">
                                                        WhatsApp
                                                    </button>
                                                    <!-- <button class="btn btn-label-secondary d-grid w-100" type="button"
                                                        onclick="history.back()">
                                                        Back
                                                    </button> -->
                                                </div>
                                            </div>
                                        </div>
                                        <!-- /Invoice Actions -->
                                    </div>

                                </div>
                                <!-- / Content -->
                            </div>
                    </div>
            </div>
        </div>

        <%- include('../partials/footercode.ejs') %>

            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>

            <script>

                $(document).ready(function () {

                    var id = '<%=id%>';
                    var orgId = '<%=orgId%>'
                    let customerName;
                    let customerNumber;
                    let customerAdd;
                    var addDisc;
                    var subTotal;


                    $.get(`/api/invoice?invoiceid=${id}&org=<%= orgId %>`, function (data, status) {
                        var customer = data.result[0];
                        console.log('inside the invoice template', customer);

                        // Check if receipt is cancelled
                        if (customer.status === "cancelled") {
                            $(".watermark, .watermark-receipt").text("CANCELLED").show();
                            $("#cancelReceipt").hide();
                        }

                        var todayDate = new Date(customer.sales_created_date);
                        var options = { year: 'numeric', month: 'long', day: 'numeric' };
                        var formattedDate = todayDate.toLocaleDateString('en-US', options);
                        $(".orderdate").text(`Date: ${formattedDate}`);
                        var mop = customer.mop || 'NA';
                        $(".mop").text(mop.toUpperCase());

                        customerName = customer.cust_name;
                        customerNumber = customer.cust_telephone || 'NA';
                        customerAdd = customer.cust_address || 'NA';

                        $(".customername").text(`Patient Name: ${customerName}`);
                        $(".mobilenumber").text(`Mobile: ${customerNumber}`);

                        $(".shippingadd").text(`Address: ${customerAdd}`);
                        $("#shippedcustomerdetails .shippedcustomernumber").html(`${customerNumber} <br> `);
                        $(".invoicenumber").text(`Invoice no: ${customer.invoice_id_main}`);

                        $(".subtotal").text(customer.subtotal);
                        $(".additionaldisc").text(customer.total_dist);
                        $(".grandtotal").text(customer.grand_total);
                        $(".doctorname").text(`Doctor : ${customer.doctor_name ? customer.doctor_name : 'NA'}`);

                        addDisc = customer.total_dist;
                        subTotal = customer.subtotal;
                    })

                    $.get(`/api/org/<%=orgId%>`, function (data, status) {
                        console.log(data);

                        $(".pharmacyName").text(data.data.org_name);

                        $(".shopaddress").html(`
                        ${data.data.org_address}</br>
                        ${data.data.org_city} (${data.data.org_state}), ${data.data.org_pincode}</br>
                        ${data.data.org_telephone}
                    `)

                        $(".gstin").text(`GSTIN : ${data.data.org_gstin ? data.data.org_gstin : 'NA'}`);
                        $(".dlno1").text(`DL No 1: ${data.data.org_dl_no_1 ? data.data.org_dl_no_1 : 'NA'}`);
                        $(".dlno2").text(`DL No 2: ${data.data.org_dl_no_2 ? data.data.org_dl_no_2 : 'NA'}`)
                        $(".flno").text(`FSSAI : ${data.data.org_fssai_no ? data.data.org_fssai_no : 'NA'}`);

                    })

                    var product = [];
                    $.get(`/api/getcartitemsininvoice/${id}`, function (data, status) {

                        var items = data.data;
                        console.log("items in data", items);

                        var totalGross = 0;
                        var totalGST = 0;
                        var addDiscPercent = (addDisc / subTotal) * 100;
                        console.log(addDisc)
                        var transactions = [];


                        for (var i = 0; i < items.length; i++) {
                            var datetime = items[i].exp_date;
                            console.log(datetime);
                            var date = moment(datetime).format('MM/YYYY');

                            var grossValue = ((items[i].saled_pri_qty_cart * items[i].unit_mrp + items[i].saled_sec_qty_cart * (items[i].unit_mrp / items[i].conversion)) * (1 - (items[i].unit_discount / 100))) / (1 + (items[i].gst / 100));
                            var gstValue = grossValue * items[i].gst / 100;

                            var transaction = {
                                grossAmount: grossValue * (1 - (addDiscPercent / 100)),
                                gstRate: items[i].gst,
                            }

                            // Append the object to the transactions array
                            transactions.push(transaction);

                            cartHtml =
                                `<tr style="padding-top: 0px; padding-bottom: 0px; margin-top:0px; margin-bottom:0px">
                                    <td style="width: 11.29rem; height: 0rem; padding-top: 0px; padding-bottom: 0px; margin-top:0px; margin-bottom:0px">${items[i].product_name}</td>
                                    <td style="width: 3.1rem; height: 0rem; padding-top: 0px; padding-bottom: 0px; margin-top:0px; margin-bottom:0px">${items[i].saled_pri_qty_cart}:${items[i].saled_sec_qty_cart}</td>
                                    <td style="width: 4.59rem; height: 0rem; padding-top: 0px; padding-bottom: 0px; margin-top:0px; margin-bottom:0px">${items[i].hsn}</td>
                                    <td style="width: 4.4rem; height: 0rem; padding-top: 0px; padding-bottom: 0px; margin-top:0px; margin-bottom:0px">${items[i].batch_name}</td>
                                    <td style="width: 3.25rem; height: 0rem; padding-top: 0px; padding-bottom: 0px; margin-top:0px; margin-bottom:0px">${date}</td>
                                    <td style="width: 3.62rem; height: 0rem; padding-top: 0px; padding-bottom: 0px; margin-top:0px; margin-bottom:0px">${items[i].unit_mrp}</td>
                                    <td style="width: 3.61rem; height: 0rem; padding-top: 0px; padding-bottom: 0px; margin-top:0px; margin-bottom:0px">${items[i].gst}</td>
                                    <td style="width: 3.91rem; height: 0rem; padding-top: 0px; padding-bottom: 0px; margin-top:0px; margin-bottom:0px">${items[i].unit_discount}</td>
                                    <td style="width: 4.2rem; height: 0rem; padding-top: 0px; padding-bottom: 0px; margin-top:0px; margin-bottom:0px">${items[i].saled_mrp}</td>
                                </tr>`
                            $(".cartitems").append(cartHtml);

                            totalGross += grossValue;
                            totalGST += gstValue;
                        }

                        $(".cgst").text((totalGST / 2).toFixed(2));
                        $(".sgst").text((totalGST / 2).toFixed(2));

                        // Initialize totals
                        var totals = {
                            0: { taxAmt: 0, cgst: 0, sgst: 0, totalGst: 0 },
                            5: { taxAmt: 0, cgst: 0, sgst: 0, totalGst: 0 },
                            12: { taxAmt: 0, cgst: 0, sgst: 0, totalGst: 0 },
                            18: { taxAmt: 0, cgst: 0, sgst: 0, totalGst: 0 },
                            total: { taxAmt: 0, cgst: 0, sgst: 0, totalGst: 0 },
                            grandTotal: { taxAmt: 0, cgst: 0, sgst: 0, totalGst: 0 }
                        };

                        // Calculate totals
                        transactions.forEach(function (transaction) {
                            // If this GST rate hasn't been seen before, add it to totals
                            if (!(transaction.gstRate in totals)) {
                                totals[transaction.gstRate] = { taxAmt: 0, cgst: 0, sgst: 0, totalGst: 0 };
                            }

                            var gstAmount = transaction.grossAmount * transaction.gstRate / 100;
                            var cgst = gstAmount / 2;
                            var sgst = gstAmount / 2;

                            totals[transaction.gstRate].taxAmt += transaction.grossAmount;
                            totals[transaction.gstRate].cgst += cgst;
                            totals[transaction.gstRate].sgst += sgst;
                            totals[transaction.gstRate].totalGst += gstAmount;

                            totals.total.taxAmt += transaction.grossAmount;
                            totals.total.cgst += cgst;
                            totals.total.sgst += sgst;
                            totals.total.totalGst += gstAmount;

                            totals.grandTotal.taxAmt += transaction.grossAmount;
                            totals.grandTotal.cgst += cgst;
                            totals.grandTotal.sgst += sgst;
                            totals.grandTotal.totalGst += gstAmount;
                        });

                        // Display totals
                        for (var gstRate in totals) {
                            $('.taxAmt' + gstRate).text((totals[gstRate].taxAmt).toFixed(2));
                            $('.cgst-' + gstRate).text((totals[gstRate].cgst).toFixed(2));
                            $('.sgst-' + gstRate).text((totals[gstRate].sgst).toFixed(2));
                            $('.totalGst' + gstRate).text((totals[gstRate].totalGst).toFixed(2));
                        }

                        // Display grand totals
                        $('.taxAmtTotal').text((totals.grandTotal.taxAmt).toFixed(2));
                        $('.cgstTotal').text((totals.grandTotal.cgst).toFixed(2));
                        $('.sgstTotal').text((totals.grandTotal.sgst).toFixed(2));
                        $('.totalGst').text((totals.grandTotal.totalGst).toFixed(2));

                    })

                    //Order cancellation button
                    $('#cancelReceipt').on('click', function (e) {
                        e.preventDefault(); // Prevent the default action
                        Swal.fire({
                            title: 'Are you sure?',
                            text: "You won't be able to revert this!",
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Yes, cancel it!'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                // Perform the cancellation action here
                                $.get(`/api/cancelSalesInvoice?orderId=${id}&orgId=<%=orgId%>`, function (data) {
                                    if (data.success == 1) {
                                        $.get(`/api/updatebatchoncancelsalesinvoice?orderId=${id}`, function (updateData) {
                                            if (updateData.success == 1) {
                                                Swal.fire(
                                                    'Cancelled!',
                                                    'The receipt has been cancelled.',
                                                    'success'
                                                ).then(() => {
                                                    location.reload();
                                                })
                                            } else {
                                                Swal.fire(
                                                    'batch Error!',
                                                    'There was an error cancelling the receipt.',
                                                    'error'
                                                )
                                            }
                                        });
                                    } else {
                                        Swal.fire(
                                            'Error!',
                                            'There was an error cancelling the receipt.',
                                            'error'
                                        )
                                    }
                                })
                            }
                        })
                    });


                    // Whatsapp Chat with customer
                    $("#whatsappLink").click(function () {
                        var protocol = window.location.protocol;
                        var host = window.location.host;
                        window.open(`https://api.whatsapp.com/send/?phone=91${customerNumber}&text=Thanks%20for%20your%20purchase%21%21%0AFind%20your%20sales%20invoice%20here%3A${protocol}%2F%2F${host}%2Fsales_invoice%3Finvoice_id%3D${id}%26org_id%3D${orgId}`, '_blank');
                    })

                    // Send Invoice functionality
                    $('#sendInvoice').click(function () {
                        $.ajax({
                            url: `/api/whatsapp/pharmacy?invoiceid=${id}&org=<%= orgId %>`,
                            type: 'POST',
                            contentType: 'application/json',
                            success: function (response) {
                                console.log('Invoice sent', response)
                            },
                            error: function (error) {
                                console.log('error in sending invoice', error);
                            }
                        })
                    })

                    $('#sendInvoiceToCustomer').on('click', function () {

                        // Get the element you want to convert to PDF
                        var element = document.getElementById('html-content');

                        // Use html2pdf to convert it
                        html2pdf().from(element).outputPdf('blob').then(function (pdfData) {

                            // Convert the Uint8Array to a Blob
                            var pdfBlob = new Blob([pdfData], { type: 'application/pdf' });

                            var formData = new FormData();
                            formData.append('file', pdfBlob);

                            console.log(formData);

                            $.ajax({
                                url: `/api/whatsapp/customer?invoiceid=${id}&org=<%= orgId %>`,
                                type: 'POST',
                                data: formData,
                                contentType: false,
                                processData: false,
                                success: function (response) {
                                    console.log(response);
                                },
                                error: function (error) {
                                    console.error(error);
                                }
                            });

                        });
                    });



                    //Create PDf from HTML...
                    // $("#download").click(function () {
                    //     CreatePDFfromHTML();
                    // });

                    // function CreatePDFfromHTML() {
                    //     var HTML_Width = $("#html-content").width();
                    //     var HTML_Height = $("#html-content").height();
                    //     var top_left_margin = 30;
                    //     var PDF_Width = HTML_Width + (top_left_margin * 2);
                    //     var PDF_Height = (PDF_Width * 1.5) + (top_left_margin * 2);
                    //     var canvas_image_width = HTML_Width;
                    //     var canvas_image_height = HTML_Height;

                    //     var totalPDFPages = Math.ceil(HTML_Height / PDF_Height) - 1;

                    //     html2canvas($("#html-content")[0]).then(function (canvas) {
                    //         var imgData = canvas.toDataURL("image/jpeg", 1.0);
                    //         var pdf = new jsPDF('p', 'pt', [PDF_Width, PDF_Height]);
                    //         pdf.addImage(imgData, 'JPG', top_left_margin, top_left_margin, canvas_image_width, canvas_image_height);
                    //         for (var i = 1; i <= totalPDFPages; i++) {
                    //             pdf.addPage(PDF_Width, PDF_Height);
                    //             pdf.addImage(imgData, 'JPG', top_left_margin, -(PDF_Height * i) + (top_left_margin * 4), canvas_image_width, canvas_image_height);
                    //         }
                    //         pdf.save("HTML-Document.pdf");

                    //         // Convert the Uint8Array to a Blob
                    //         var pdfBlob = new Blob([pdf], { type: 'application/pdf' });

                    //         var formData = new FormData();
                    //         formData.append('file', pdfBlob);

                    //         console.log(pdf);
                    //         console.log(pdfBlob);
                    //         console.log(formData);

                    //         $.ajax({
                    //             url: `/api/whatsapp/customer?invoiceid=${id}&org=<%= orgId %>`,
                    //             type: 'POST',
                    //             data: formData,
                    //             contentType: false,
                    //             processData: false,
                    //             success: function (response) {
                    //                 console.log(response);
                    //             },
                    //             error: function (error) {
                    //                 console.error(error);
                    //             }
                    //         });
                    //     });
                    // }
                })

                // Function to create PDF using html2pdf
                function createPDF() {
                    // Get the HTML element you want to convert
                    var element = document.getElementById('html-content');

                    // Use html2pdf to generate the PDF
                    return html2pdf(element)
                        .from(element)
                        .outputPdf();
                }

            </script>
            <script>
                function CreatePDFfromHTML() {
                    $("#html-content").show();
                
                    // Adjust the content width for PDF generation
                    var originalWidth = $("#html-content").width();
                    var isMobile = window.innerWidth <= 767;
                    if (isMobile) {
                        $("#html-content").css("width", "100%");
                    }
                
                    var HTML_Width = $("#html-content").width();
                    var HTML_Height = $("#html-content").height();
                    var top_left_margin = 30;
                    var PDF_Width = HTML_Width + (top_left_margin * 2);
                    var PDF_Height = (PDF_Width * 1.7) + (top_left_margin * 2);
                    var canvas_image_width = HTML_Width;
                    var canvas_image_height = HTML_Height;
                
                    var totalPDFPages = Math.ceil(HTML_Height / PDF_Height) - 1;
                
                    html2canvas($("#html-content")[0]).then(function (canvas) {
                        var imgData = canvas.toDataURL("image/jpeg", 1.0);
                        var pdf = new jsPDF('p', 'pt', [PDF_Width, PDF_Height]);
                        pdf.addImage(imgData, 'JPG', top_left_margin, top_left_margin, canvas_image_width, canvas_image_height);
                        for (var i = 1; i <= totalPDFPages; i++) {
                            pdf.addPage(PDF_Width, PDF_Height);
                            pdf.addImage(imgData, 'JPG', top_left_margin, -(PDF_Height * i) + (top_left_margin * 4), canvas_image_width, canvas_image_height);
                        }
                        pdf.save("Invoice.pdf");
                
                        // Reset the width after PDF generation
                        if (isMobile) {
                            $("#html-content").css("width", originalWidth);
                        }
                
                        $("#html-content").hide();
                    });
                }
                
            </script>

    </body>

    </html>