<%- include('../partials/headercode.ejs') %>

    <head>
        <!-- Vendors CSS -->
        <link rel="stylesheet" href="/vendor/libs/perfect-scrollbar/perfect-scrollbar.css">
        <link rel="stylesheet" href="/vendor/libs/typeahead-js/typeahead.css">
        <link rel="stylesheet" href="/vendor/libs/datatables-bs5/datatables.bootstrap5.css">
        <link rel="stylesheet" href="/vendor/libs/datatables-responsive-bs5/responsive.bootstrap5.css">
        <link rel="stylesheet" href="/vendor/libs/datatables-checkboxes-jquery/datatables.checkboxes.css">
        <link rel="stylesheet" href="/vendor/libs/datatables-buttons-bs5/buttons.bootstrap5.css">
        <link rel="stylesheet" href="/vendor/libs/flatpickr/flatpickr.css">

    </head>

    <body>

        <!-- Layout wrapper -->
        <div class="layout-wrapper layout-content-navbar  ">
            <div class="layout-container">

                <!-- sidebar imported -->
                <%- include('../partials/sidebar.ejs') %>

                    <!-- Layout container -->
                    <div class="layout-page">

                        <!-- navbar imported -->
                        <%- include('../partials/navbar.ejs') %>

                            <!-- Content wrapper -->
                            <div class="content-wrapper">

                                <!-- Content -->

                                <div class="container-xxl flex-grow-1 container-p-y">

                                    <div class="d-flex justify-content-between m-0 p-0">
                                        <h4 class="fw-bold py-3 mb-1">Near Expiry Products</h4>
                                        <a type="button" class="btn btn-icon btn-danger my-2 mx-3"
                                            href="/product_stock">
                                            <i class='bx bx-x bx-sm'></i>
                                        </a>
                                    </div>


                                    <!-- <div class="d-flex justify-content-between m-0 p-0">
                                        <div class="input-group input-group-merge">
                                            <span class="input-group-text" id="basic-addon-search31"><i
                                                    class="bx bx-search"></i></span>
                                            <input type="text" class="form-control" placeholder="Search Product..."
                                                onkeyup="var value = $(this).val().toLowerCase();$('#nearExpiryData tbody tr').filter(function() {$(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)});">
                                        </div>

                                    </div> -->


                                    <hr class="mb-4">

                                    <div class="card" id="nearExpiryData">
                                        <div class="card-header row">
                                            <h5 class="col-md-9 mb-0">Product List</h5>
                                            <div class="col-md-3">
                                                <div class="form-check form-check-inline mt-3">
                                                    <input class="form-check-input" type="radio" name="filter"
                                                        id="allRadio" value="all" checked>
                                                    <label class="form-check-label" for="allRadio">All</label>
                                                </div>
                                                <div class="form-check form-check-inline mt-3">
                                                    <input class="form-check-input" type="radio" name="filter"
                                                        id="thisMonthRadio" value="thisMonth">
                                                    <label class="form-check-label" for="thisMonthRadio">This
                                                        Month</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="table-responsive text-nowrap">
                                            <table class="table table-hover dataTable" id="DataTables_Table_1">
                                                <thead>
                                                    <tr>
                                                        <th>
                                                            Product Name

                                                        </th>
                                                        <th>
                                                            Batch No.
                                                        </th>
                                                        <th>
                                                            Expiry
                                                        </th>
                                                        <th>
                                                            Pack Units
                                                        </th>
                                                        <th>
                                                            Rem Qty (Pri: Sec)
                                                        </th>
                                                        <th>
                                                            Rate/P.Unit
                                                        </th>
                                                        <th>
                                                            Cost
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody class="table-border-bottom-0" id="additems">

                                                </tbody>
                                                <tfoot>
                                                    <tr class="table-danger">
                                                        <td class="h5 ps-5" colspan="6">Total</td>
                                                        <td class="h5" id="totalCost"></td> <!-- Total cost here -->
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    </div>

                                </div>
                                <!-- / Content -->

                                <div class="content-backdrop fade"></div>
                            </div>
                            <!-- Content wrapper -->
                    </div>
                    <!-- / Layout page -->
            </div>

            <!-- Overlay -->
            <div class="layout-overlay layout-menu-toggle"></div>

        </div>
        <!-- / Layout wrapper -->

        <%- include('../partials/footercode.ejs') %>
            <!-- Page JS -->
            <script src="/js/tables-datatables-basic.js"></script>
            <script>
                $(document).ready(function () {

                    var orgId = "<%=orgId%>"
                    console.log(orgId);

                    var selectedFilter = $("input[name='filter']:checked").val();
                    console.log(selectedFilter);

                    function displayTable(filter) {
                        $.get(`/api/getNearExpiryProducts/${orgId}`, function (data, status) {
                            var items = data.data;
                            console.log('in product stock', items);

                            // Get the current year and month
                            var currentYear = new Date().getFullYear();
                            var currentMonth = new Date().getMonth() + 1;
                            console.log(currentYear, currentMonth)

                            // Filter the items based on the selected filter
                            var filteredItems;
                            if (filter === 'thisMonth') {
                            filteredItems = items.filter(item => {
                                var expiryYear = new Date(item.exp_date).getFullYear();
                                var expiryMonth = new Date(item.exp_date).getMonth() + 1;
   
                                return expiryYear === currentYear && expiryMonth === currentMonth;
                            });
                            } else if (filter === 'all') {
                            filteredItems = items; // No filter
                            }

                            var totalCost = 0;
                            for (let i = 0; i < filteredItems.length; i++) {
                                var date = new Date(items[i].exp_date);
                                var options = { year: 'numeric', month: 'long' };
                                var expdate = date.toLocaleDateString('en-US', options);

                                var totalQty = parseInt(items[i].batch_qty);
                                var saledPri = parseInt(items[i].saled_pri_qty);
                                var saledSec = parseInt(items[i].saled_sec_qty);
                                var conversion = parseInt(items[i].conversion);

                                var remPriQty = totalQty - saledPri;
                                var remSecQty = (conversion - saledSec) == conversion ? 0 : conversion - saledSec;

                                var cost = items[i].purchase_rate * remPriQty + (items[i].purchase_rate / conversion) * remSecQty;

                                totalCost += cost;
                                var html = `
                                        <tr>
                                            <td><i class="fab fa-angular fa-lg text-danger me-3"></i><strong>${items[i].med_name}</strong></td>
                                            <td>${items[i].batch_name}</td>
                                            <td>${expdate}</td>
                                            <td>${items[i].primary_unit} of ${items[i].secondary_unit}</td>
                                            <td>${remPriQty} : ${remSecQty}</td>
                                            <td>₹${items[i].purchase_rate}</td>
                                            <td>₹${cost.toFixed(2)}</td>
                                        </tr>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               `

                                $("#additems").append(html);
                            }

                            $("#totalCost").text(`₹${totalCost.toFixed(2)}`);
                        });

                    }
                    displayTable(selectedFilter);

                    $("input[name='filter']").change(function () {
                        selectedFilter = $("input[name='filter']:checked").val();
                        $("#additems").empty();
                        displayTable(selectedFilter);
                    });
                })
            </script>


    </body>


    </html>