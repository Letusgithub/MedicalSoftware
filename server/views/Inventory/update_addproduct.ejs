<%- include('../partials/headercode.ejs') %>
    <!-- Atharv -->

    <body>

        <!-- Layout wrapper -->
        <div class="layout-wrapper layout-content-navbar  ">
            <div class="layout-container">

                <!-- sidebar imported -->
                <%- include('../partials/sidebar.ejs') %>

                    <!-- Layout container -->
                    <div class="layout-page">

                        <!-- navbar imported -->
                        <%- include('../partials/navbar.ejs') %>

                            <!-- Content wrapper -->
                            <div class="content-wrapper">

                                <!-- Content -->

                                <div class="container-xxl flex-grow-1 container-p-y">


                                    <div class="d-flex justify-content-between m-0 p-0">
                                        <h4 class="fw-bold py-3 mb-1"> Update Product</h4>
                                        <button type="button" class="btn btn-icon btn-danger my-2 mx-3"
                                            onclick="history.back()">
                                            <i class='bx bx-x bx-sm'></i>
                                        </button>
                                    </div>
                                    <hr class="mb-4">

                                    <div class="card mb-4 mx-auto col-md-8">
                                        <!-- <form> -->
                                        <div class="card-body ">

                                            <div class="row mb-3">
                                                <label class="col-sm-2 col-form-label"
                                                    for="basic-icon-default-fullname">Product Name</label>
                                                <div class="col-sm-10">
                                                    <div class="input-group input-group-merge">
                                                        <input type="text" class="form-control" name="productname"
                                                            value="<%=data[0].med_name%>" disabled>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <label class="col-sm-2 col-form-label"
                                                    for="basic-icon-default-fullname">Mfg/Mkt</label>
                                                <div class="col-sm-10">
                                                    <div class="input-group input-group-merge">
                                                        <input type="text" class="form-control" name="brand"
                                                            value="<%= data[0].mfd_mkt%>" disabled>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <label class="col-sm-2 col-form-label"
                                                    for="basic-icon-default-fullname">Salt Comp.</label>
                                                <div class="col-sm-10">
                                                    <div class="input-group input-group-merge">
                                                        <input type="text" class="form-control" name="salt"
                                                            value="<%=data[0].salt_composition%>" disabled>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row mb-3">

                                                <label class="col-sm-2 col-form-label"
                                                    for="basic-icon-default-companyname">GST (%)</label>
                                                <div class="col-sm-4 mb-3">
                                                    <div class="input-group has-validation">
                                                        <select class="form-select" name="gst" id="gst" required>
                                                            <option value="default" selected>Select GST %</option>
                                                            <option value="0">0%</option>
                                                            <option value="5">5%</option>
                                                            <option value="12">12%</option>
                                                            <option value="18">18%</option>
                                                        </select>
                                                        <div class="invalid-feedback">
                                                            Please select GST.
                                                        </div>
                                                    </div>
                                                </div>


                                                <label class="col-sm-2 col-form-label ps-4"
                                                    for="basic-icon-default-companyname">HSN Code</label>
                                                <div class="col-sm-4">
                                                    <div class="input-group has-validation">
                                                        <input type="text" class="form-control"
                                                            placeholder="Eg- 30049047"
                                                            onkeypress="javascript: if (!/[0-9]/.test(String.fromCharCode(event.charCode))) return false;"
                                                            maxlength="8" minlength="4" required name="hsn"
                                                            value="<%=data[0].hsn%>">
                                                        <div class="invalid-feedback">
                                                            Please enter HSN code.
                                                        </div>
                                                    </div>
                                                </div>

                                            </div>


                                            <!-- <div class="row mb-2">
                                                    <label class="col-sm-2 col-form-label"
                                                        for="basic-icon-default-address">Unit</label>
                                                    <div class="col-sm-4 me-0">
                                                        <div class="input-group input-group-merge">
                                                            <select class="form-select" id="exampleFormControlSelect1" name="primary"
                                                                aria-label="Default select example">
                                                                <option selected><%=data[0].primary_unit%></option>
                                                                <option value="1">Stp</option>
                                                                <option value="1">AMP (Ampoules)</option>
                                                                <option value="1">Box</option>
                                                                <option value="1">BTL (Bottle)</option>
                                                                <option value="1">BALM</option>
                                                                <option value="1">CAP (Capsule)</option>
                                                                <option value="1">CREAM</option>
                                                                <option value="1">DROP</option>
                                                                <option value="1">DRSP (Dry Syrup)</option>
                                                                <option value="1">E/D (Eye Drop)</option>
                                                                <option value="1">EAR/D (Ear Drop)</option>
                                                                <option value="1">FW (Face Wash)</option>
                                                                <option value="1">GEL</option>
                                                                <option value="1">GM</option>
                                                                <option value="1">INJ (Injection)</option>
                                                                <option value="1">INH (Inhaler)</option>
                                                            </select>
                                                        </div>

                                                    </div>

                                                    <div class="col-sm-1 text-center mx-0 p-0">
                                                        <p class="fs-4">-</p>
                                                    </div>

                                                    <div class="col-sm-4 ms-0">
                                                        <div class="input-group input-group-merge">
                                                            <select class="form-select" id="exampleFormControlSelect1" name="secondary"
                                                            disabled
                                                                aria-label="Default select example">
                                                                <option selected><%=data[0].secondary_unit %></option>
                                                                <option value="1">Tbl</option>
                                                                <option value="1">AMP (Ampoules)</option>
                                                                <option value="1">Box</option>
                                                                <option value="1">BTL (Bottle)</option>
                                                                <option value="1">BALM</option>
                                                                <option value="1">CAP (Capsule)</option>
                                                                <option value="1">CREAM</option>
                                                                <option value="1">DROP</option>
                                                                <option value="1">DRSP (Dry Syrup)</option>
                                                                <option value="1">E/D (Eye Drop)</option>
                                                                <option value="1">EAR/D (Ear Drop)</option>
                                                                <option value="1">FW (Face Wash)</option>
                                                                <option value="1">GEL</option>
                                                                <option value="1">GM</option>
                                                                <option value="1">INJ (Injection)</option>
                                                                <option value="1">INH (Inhaler)</option>
                                                                <option value="1"></option>
                                                                <option value="1"></option>

                                                            </select>
                                                        </div>

                                                    </div>
                                                </div> -->

                                            <!-- <div class="row mb-3">

                                                    <label class="col-sm-2 col-form-label"
                                                        for="basic-icon-default-companyname">Conversion</label>

                                                    <div class="col-sm-4">
                                                        <div class="input-group input-group-merge">
                                                            <span class="input-group-text" id="primarypopulate"><%=data[0].primary_unit %></span>
                                                            <span class="input-group-text">=</span>
                                                            <input type="number" class="form-control" placeholder=""
                                                                aria-label="" name="conversion" value="<%=data[0].conversion%>"/>
                                                            <span class="input-group-text" id="secondarypopulate"><%=data[0].secondary_unit %></span>
                                                        </div>
                                                    </div>

                                                </div> -->

                                            <div class="row mb-3">

                                                <label class="col-sm-2 col-form-label" for="category">Category</label>
                                                <div class="col-sm-4">
                                                    <div class="input-group has-validation">
                                                        <select class="form-select" name="category" id="categorySelect"
                                                            required>
                                                        </select>
                                                        <div class="invalid-feedback">
                                                            Please select category.
                                                        </div>
                                                    </div>
                                                </div>

                                                <label class="col-sm-2 col-form-label ps-4"
                                                    for="basic-icon-default-companyname">Reorder Level</label>

                                                <div class="col-sm-4">
                                                    <div class="input-group has-validation">
                                                        <input type="text" class="form-control"
                                                            onkeypress="javascript: if (!/[0-9]/.test(String.fromCharCode(event.charCode))) return false;"
                                                            id="threshold" placeholder="Minimum stock quantity"
                                                            name="threshold" value="<%=data[0].threshold%>" required>
                                                        <div class="invalid-feedback">
                                                            Please enter reorder level.
                                                        </div>
                                                    </div>
                                                </div>

                                            </div>

                                            <div class="text-center mx-auto">
                                                <button type="submit" class="btn btn-primary"
                                                    id="submitproduct">Update</button>
                                            </div>
                                        </div>

                                        <!-- </form> -->
                                    </div>


                                </div>
                                <!-- / Content -->

                                <div class="content-backdrop fade"></div>
                            </div>
                            <!-- Content wrapper -->
                    </div>
                    <!-- / Layout page -->
            </div>



            <!-- Overlay -->
            <div class="layout-overlay layout-menu-toggle"></div>


        </div>
        <!-- / Layout wrapper -->

        <%- include('../partials/footercode.ejs') %>
            <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
            <script>
                $(document).ready(function () {
                    // Hide validation messages on input
                    $('input').each(function () {
                        $(this).on('input', function () {
                            if ($(this).val() == '') {
                                $(this).addClass('is-invalid');
                            } else {
                                $(this).removeClass('is-invalid');
                            }
                        });
                    });
                    $('select:required').each(function () {
                        $(this).on('input', function () {
                            if ($(this).val() == 'default' || $(this).val() == null) {
                                $(this).addClass('is-invalid');
                            } else {
                                $(this).removeClass('is-invalid');
                            }
                        });
                    });
                    var productId = '<%=data[0].product_id%>';
                    var orgID = '<%=orgId%>';

                    var categoryId = '<%=data[0].category_id%>';
                    var categoryName = '<%=data[0].category_name%>';

                    var gst = '<%=data[0].gst%>';
                    $("select[name='gst']").val(gst);
                    $("#categorySelect").append(`<option selected value="${categoryId}">${categoryName}</option>`);

                    // Fetch categories from the API using jQuery
                    $.get("/api/all-category", function (response) {
                        // Get the select element
                        var categorySelect = $("#categorySelect");

                        // Populate the dropdown with options
                        $.each(response.data, function (index, category) {
                            if (category.category_id != categoryId) {
                                categorySelect.append($('<option>', {
                                    value: category.category_id,
                                    text: category.category_name
                                }));
                            }
                        });
                    })
                        .fail(function (error) {
                            console.error("Error fetching categories:", error);
                        });

                    $("#submitproduct").click(function (e) {

                        // Validations
                        e.preventDefault();
                        var isValid = true;
                        $('input:required').each(function () {
                            if ($(this).val() == '') {
                                $(this).addClass('is-invalid');
                                $(this).focus();
                                isValid = false;
                            } else {
                                $(this).removeClass('is-invalid');
                            }
                        });

                        $('select:required').each(function () {
                            if ($(this).val() == 'default' || $(this).val() == null) {
                                $(this).addClass('is-invalid');
                                isValid = false;
                            } else {
                                $(this).removeClass('is-invalid');
                            }
                        });

                        if (isValid) {
                            var productDetails = {
                                product_id: productId,
                                org_id: orgID,
                                category_id: $("select[name='category']").val(),
                                gst: $("select[name='gst']").val(),
                                hsn: $("input[name='hsn']").val(),
                                threshold: $("input[name='threshold']").val()
                            }
                            console.log(productDetails);
                            $.ajax({
                                url: `/api/updateinventory/${productId}`,
                                type: 'POST',
                                data: JSON.stringify(productDetails),
                                contentType: 'application/json',
                                success: function (response) {
                                    console.log('inside stock', response);
                                    window.location.href = '/product_stock'
                                },
                                error: function (error) {
                                    console.log(error);
                                }
                            })
                        }
                    })
                })
            </script>



    </body>


    </html>