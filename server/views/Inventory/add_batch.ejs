<%- include('../partials/headercode.ejs') %>
    <!-- Atharv -->

    <body>

        <!-- Layout wrapper -->
        <div class="layout-wrapper layout-content-navbar  ">
            <div class="layout-container">

                <!-- sidebar imported -->
                <%- include('../partials/sidebar.ejs') %>

                    <!-- Layout container -->
                    <div class="layout-page">

                        <!-- navbar imported -->
                        <%- include('../partials/navbar.ejs') %>

                            <!-- Content wrapper -->
                            <div class="content-wrapper">

                                <!-- Content -->

                                <div class="container-xxl flex-grow-1 container-p-y">

                                    <!-- Loader GIF -->
                                    <div id="loader"
                                        style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
                                        <div class="spinner-border spinner-border-lg text-primary" role="status"
                                            style="position: absolute; top: 50%; left: 50%;">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>


                                    <div class="d-flex justify-content-between m-0 p-0">
                                        <h4 class="fw-bold py-3 mb-1"> Add Batches</h4>
                                        <a type="button" class="btn btn-icon btn-danger my-2 mx-3"
                                            href="/product_stock">
                                            <i class='bx bx-x bx-sm'></i>
                                        </a>
                                    </div>
                                    <hr class="mb-4">

                                    <div class="card mb-4 mx-auto col-md-10">

                                        <div class="card-body ">

                                            <div class="row mb-3">
                                                <label class="col-sm-2 col-form-label"
                                                    for="basic-icon-default-fullname">Product Name</label>
                                                <div class="col-sm-10">
                                                    <div class="input-group input-group-merge">
                                                        <input type="text" class="form-control"
                                                            id="basic-icon-default-fullname" placeholder=""
                                                            aria-label="John Doe"
                                                            aria-describedby="basic-icon-default-fullname2"
                                                            name="productname" value="<%=data[0].med_name%>" disabled>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <label class="col-sm-2 col-form-label"
                                                    for="basic-icon-default-fullname">Mfg/Mkt</label>
                                                <div class="col-sm-10">
                                                    <div class="input-group input-group-merge">
                                                        <input type="text" class="form-control"
                                                            id="basic-icon-default-fullname" placeholder=""
                                                            aria-label="John Doe"
                                                            aria-describedby="basic-icon-default-fullname2" name="brand"
                                                            disabled value="<%=data[0].mfd_mkt%>">
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <label class="col-sm-2 col-form-label"
                                                    for="basic-icon-default-fullname">Salt Comp.</label>
                                                <div class="col-sm-10">
                                                    <div class="input-group input-group-merge">
                                                        <input type="text" class="form-control"
                                                            id="basic-icon-default-fullname" placeholder=""
                                                            aria-label="John Doe"
                                                            aria-describedby="basic-icon-default-fullname2" name="salt"
                                                            disabled value="<%=data[0].salt_composition%>">

                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <label class="col-sm-2 col-form-label"
                                                    for="basic-icon-default-address">Unit</label>
                                                <div class="col-sm-4 me-0">
                                                    <div class="input-group input-group-merge">
                                                        <input type="text" class="form-control" name="hsn" disabled
                                                            value="<%=data[0].primary_unit%>">
                                                    </div>
                                                </div>

                                                <div class="col-sm-2 text-center mx-0 p-0">
                                                    <p class="fs-4"></p>
                                                </div>

                                                <div class="col-sm-4 ms-0">
                                                    <div class="input-group input-group-merge">
                                                        <input type="text" class="form-control" name="hsn" disabled
                                                            value="<%=data[0].secondary_unit%>">
                                                    </div>

                                                </div>
                                            </div>

                                            <div class="row mb-3">

                                                <label class="col-sm-2 col-form-label"
                                                    for="basic-icon-default-companyname">GST (%)</label>
                                                <div class="col-sm-4">
                                                    <div class="input-group input-group-merge">
                                                        <input type="text" class="form-control" id="gst" name="gst"
                                                            disabled value="<%=data[0].gst%>">
                                                    </div>
                                                </div>

                                                <label class="col-sm-2 col-form-label"
                                                    for="basic-icon-default-companyname">HSN Code</label>
                                                <div class="col-sm-4">
                                                    <div class="input-group input-group-merge">
                                                        <input type="text" class="form-control" id="hsn" name="hsn"
                                                            disabled value="<%=data[0].hsn%>">
                                                    </div>
                                                </div>


                                            </div>

                                            <div class="row mb-3">

                                                <label class="col-sm-2 col-form-label" for="category">Category</label>
                                                <div class="col-sm-4">
                                                    <div class="input-group input-group-merge">
                                                        <input type="text" class="form-control" name="category" disabled
                                                            value="<%=data[0].category_name%>">
                                                    </div>
                                                </div>

                                                <label class="col-sm-2 col-form-label"
                                                    for="basic-icon-default-companyname">Reorder Level</label>

                                                <div class="col-sm-4">
                                                    <div class="input-group input-group-merge">
                                                        <input type="text" class="form-control" name="threshold"
                                                            disabled value="<%=data[0].threshold%>">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="card mb-4 mx-auto col-md-10">

                                        <div class="card-body ">
                                            <h4 class="fs-5">Batch Details</h4>
                                            <hr>

                                            <div class="row mb-3">


                                                <label class="col-sm-2 col-form-label"
                                                    for="basic-icon-default-companyname">Batch No.</label>
                                                <div class="col-sm-4">
                                                    <div class="input-group has-validation">
                                                        <input type="text" class="form-control" id="batchname"
                                                            placeholder="Eg- B6AEW8852" required />
                                                        <div class="invalid-feedback">
                                                            Please enter batch number.
                                                        </div>
                                                    </div>
                                                </div>

                                                <label class="col-sm-2 col-form-label ps-4"
                                                    for="basic-icon-default-address">Exp Date</label>
                                                <div class="col-sm-4">
                                                    <div class="input-group has-validation">
                                                        <input class="form-control expiry-date-mask" type="text"
                                                            name="addexp" placeholder="MM/YY" required />
                                                        <div class="invalid-feedback">
                                                            Please enter valid expiry date.
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <label class="col-sm-2 col-form-label"
                                                    for="basic-icon-default-companyname">Conversion</label>

                                                <div class="col-sm-4">
                                                    <div class="input-group has-validation">
                                                        <span class="input-group-text" id="primarypopulate">
                                                            <%=data[0].primary_unit%>
                                                        </span>
                                                        <span class="input-group-text">=</span>
                                                        <input type="text" class="form-control rounded-0"
                                                            onkeypress="javascript: if (!/[0-9]/.test(String.fromCharCode(event.charCode))) return false;"
                                                            id="conversion" placeholder="Enter conversion" required />
                                                        <span class="input-group-text" id="secondarypopulate">
                                                            <%=data[0].secondary_unit%>
                                                        </span>
                                                        <div class="invalid-feedback">
                                                            Please enter conversion.
                                                        </div>
                                                    </div>
                                                </div>

                                                <label class="col-sm-2 col-form-label ps-4"
                                                    for="basic-icon-default-companyname">Quantity</label>
                                                <div class="col-sm-4">
                                                    <div class="input-group input-group-merge">
                                                        <div class="input-group has-validation">
                                                            <input type="text" class="form-control" name="addqty" id="addqty"
                                                                placeholder="Enter quantity"
                                                                onkeypress="javascript: if (!/[0-9]/.test(String.fromCharCode(event.charCode))) return false;"
                                                                required /> <span class="input-group-text"
                                                                id="getprimaryunit">
                                                                <%=data[0].primary_unit%>
                                                            </span>
                                                            <div class="invalid-feedback">
                                                                Please enter quantity.
                                                            </div>
                                                        </div>

                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row mb-3">

                                                <label class="col-sm-2 col-form-label">MRP</label>
                                                <div class="col-sm-4">
                                                    <div class="input-group  has-validation">
                                                        <input type="text" class="form-control" name="addmrp" id="price"
                                                            onkeypress="javascript: if (!/[0-9.]/.test(String.fromCharCode(event.charCode))) return false;"
                                                            placeholder="Enter MRP Rate" required />
                                                        <div class="invalid-feedback">
                                                            Please enter MRP.
                                                        </div>
                                                    </div>
                                                </div>

                                                <label class="col-sm-2 col-form-label ps-4"
                                                    for="basic-icon-default-companyname">PTR</label>
                                                <div class="col-sm-4">
                                                    <div class="input-group has-validation">
                                                        <input type="text" class="form-control" name="addpur"
                                                            onkeypress="javascript: if (!/[0-9.]/.test(String.fromCharCode(event.charCode))) return false;"
                                                            id="addpur" placeholder="Enter Purchase rate" required />
                                                        <div class="invalid-feedback">
                                                            Please enter PTR.
                                                        </div>
                                                    </div>
                                                    <div style="font-size: smaller; color:blue; margin-top: 5px; display: none;"
                                                        id="r_margin">
                                                        Retailer Margin: <span id="retailer_margin">20</span>%
                                                    </div>
                                                </div>

                                            </div>

                                            <!-- <div class="row mb-3">

                                                <label class="col-sm-2 col-form-label" for="free_scheme">Free</label>
                                                <div class="col-sm-4">
                                                    <div class="input-group input-group-merge">
                                                        <input type="text" class="form-control" name="free_scheme"
                                                            id="free_scheme">
                                                    </div>
                                                </div>

                                                <label class="col-sm-2 col-form-label ps-4"
                                                    for="bulk_discount">Discount(%)</label>
                                                <div class="col-sm-4">
                                                    <div class="input-group input-group-merge">
                                                        <input type="text" class="form-control" name="bulk_discount"
                                                            id="bulk_discount">
                                                    </div>
                                                </div>

                                            </div> -->

                                            <!-- <div class="row mb-3">

                                                <label class="col-sm-2 col-form-label"
                                                    for="basic-icon-default-email">Shelf Label</label>
                                                <div class="col-sm-4">
                                                    <div class="input-group input-group-merge">
                                                        <span class="input-group-text"></span>
                                                        <input type="text" id="basic-icon-default-email"
                                                            class="form-control" placeholder="" name="addshelf">

                                                    </div>
                                                </div>

                                            </div> -->

                                            <!-- <div class="row justify-content-end">
                                                <div class="col-sm-10">
                                                    <button type="submit" class="btn btn-primary"
                                                        id="submitbatch">Add</button>
                                                </div>
                                            </div> -->

                                            <div class="col-sm-12 text-center">
                                                <button type="submit" class="btn btn-primary"
                                                    id="submitbatch">Add</button>
                                            </div>


                                        </div>

                                    </div>


                                </div>
                                <!-- / Content -->

                                <div class="content-backdrop fade"></div>
                            </div>
                            <!-- Content wrapper -->
                    </div>
                    <!-- / Layout page -->
            </div>



            <!-- Overlay -->
            <div class="layout-overlay layout-menu-toggle"></div>


        </div>
        <!-- / Layout wrapper -->

        <%- include('../partials/footercode.ejs') %>
            <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
            <script>

                $(document).ready(function () {

                    var orgID = '<%= orgId %>';
                    var productId = '<%=data[0].product_id%>';
                    var inventoryId = '<%=data[0].inventory_id%>';
                    console.log(inventoryId);

                    // Hide validation messages on input
                    $('input').each(function () {
                        $(this).on('input', function () {
                            if ($(this).val() == '') {
                                $(this).addClass('is-invalid');
                            } else {
                                $(this).removeClass('is-invalid');
                            }
                        });
                    });
                    $('select:required').each(function () {
                        $(this).on('input', function () {
                            if ($(this).val() == 'default' || $(this).val() == null) {
                                $(this).addClass('is-invalid');
                            } else {
                                $(this).removeClass('is-invalid');
                            }
                        });
                    });

                    // Formatted expiry date input
                    var cleave = new Cleave('.expiry-date-mask', {
                        date: true,
                        datePattern: ['m', 'y']
                    });

                    // Expiry date validation
                    $("[name='addexp']").on('change', function () {
                        var input = $(this);
                        var exp_date = input.val();

                        var year = parseInt(exp_date.split('/')[1], 10);
                        year = year < 70 ? 2000 + year : 1900 + year;
                        var expiryDate = new Date(year, exp_date.split('/')[0] - 1);

                        // Get the current year and month
                        var today = new Date();
                        var currentYear = today.getFullYear();
                        var currentMonth = today.getMonth();

                        if (expiryDate.getFullYear() < currentYear ||
                            (expiryDate.getFullYear() === currentYear && expiryDate.getMonth() < currentMonth)  ||
                            expiryDate.getFullYear() > currentYear + 5) {
                            $("[name='addexp']").val(null);
                            $("[name='addexp']").addClass('is-invalid');
                        } else {
                            $(".invalid-feedback").hide();
                        }
                    });

                    //PTR < MRP Validation
                    $("input[name='addpur']").on('change', function () {
                        var ptr = parseFloat($("input[name='addpur']").val());
                        var mrp = parseFloat($("input[name='addmrp']").val());

                        if (ptr >= mrp) {
                            $("input[name='addpur']").val(null);
                            $("input[name='addpur']").addClass('is-invalid');
                        } else {
                            $(".invalid-feedback").hide();
                        }
                    });

                    // Calculate PTR
                    function calcuatePTR(mrp, gst, retailerMargin) {
                        return (mrp - (mrp * (retailerMargin / 100))) / (1 + (gst / 100));
                    }

                    $("input[name='addmrp']").on("keyup", function () {
                        $("#r_margin").show();

                        var mrp = parseFloat($("input[name='addmrp']").val());
                        var gst = parseFloat($("input[name='gst']").val());
                        var retailerMargin = parseFloat($("#retailer_margin").text());

                        // Corrected PTR formula
                        var ptr = (mrp - (mrp * (retailerMargin / 100))) / (1 + (gst / 100));

                        $("input[name='addpur']").val(ptr.toFixed(2))
                    });

                    $("input[name='addpur']").on("keyup", function () {
                        var mrp = parseFloat($("input[name='addmrp']").val());
                        var gst = parseFloat($("input[name='gst']").val());
                        var ptr = parseFloat($("input[name='addpur']").val());

                        var retailerMargin = (((mrp - ptr) / mrp) * 100) - ((ptr / mrp) * gst);

                        $("#retailer_margin").text(retailerMargin.toFixed(2));
                    });



                    //submit process after adding batch
                    $("#submitbatch").click(function (e) {

                        // Validations
                        e.preventDefault();
                        var isValid = true;
                        $('input:required').each(function () {
                            if ($(this).val() == '') {
                                $(this).addClass('is-invalid');
                                $(this).focus();
                                isValid = false;
                            } else {
                                $(this).removeClass('is-invalid');
                            }
                        });

                        $('select:required').each(function () {
                            if ($(this).val() == 'default' || $(this).val() == null) {
                                $(this).addClass('is-invalid');
                                isValid = false;
                            } else {
                                $(this).removeClass('is-invalid');
                            }
                        });

                        if (parseInt($("#addqty").val()) == 0) {
                            $("#addqty").addClass('is-invalid');
                            $("#addqty").focus();
                            isValid = false;
                        } else {
                            $("#addqty").removeClass('is-invalid');
                        }

                        if (parseFloat($("#price").val()) == 0) {
                            $("#price").addClass('is-invalid');
                            $("#price").focus();
                            isValid = false;
                        } else {
                            $("#price").removeClass('is-invalid');
                        }

                        if (isValid) {


                            // Convert expdate to yyyy-mm-dd format
                            var exp = $("[name='addexp']").val();
                            var year = parseInt(exp.split('/')[1], 10);
                            year = year < 70 ? 2000 + year : 1900 + year;
                            var firstDayOfNextMonth = new Date(year, exp.split('/')[0]);
                            firstDayOfNextMonth.setDate(firstDayOfNextMonth.getDate() - 1);
                            var exp = firstDayOfNextMonth.toISOString().slice(0, 10);

                            var batchDetails = {
                                productId: "<%=data[0].product_id%>",
                                orgId: orgID,
                                inventoryId: inventoryId,
                                batchName: $("#batchname").val(),
                                expDate: exp,
                                conversion: $("#conversion").val(),
                                quantity: parseFloat($("input[name='addqty']").val()),
                                ptr: $("input[name='addpur']").val(),
                                mrp: $("input[name='addmrp']").val(),
                                free: 0,
                                bulkDiscount: 0,
                                basePrice: $("input[name='addpur']").val(),
                                shelfLabel: $("input[name='addshelf']").val()
                            }
                            console.log(batchDetails);

                            $('#loader').show();
                            $.ajax({
                                url: `/api/v2/batches`,
                                type: 'POST',
                                data: JSON.stringify(batchDetails),
                                contentType: 'application/json',
                                success: function (response) {

                                    $('#loader').hide();

                                    window.location.href = `/product_batch/${productId}`
                                    console.log(response);

                                },
                                error: function (error) {
                                    $('#loader').hide();
                                    console.log(error);
                                }
                            })

                        }

                    })
                });
            </script>

    </body>


    </html>