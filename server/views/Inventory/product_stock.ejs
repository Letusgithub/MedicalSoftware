<%- include('../partials/headercode.ejs') %>
    <!-- Atharv -->

    <body>

        <!-- Layout wrapper -->
        <div class="layout-wrapper layout-content-navbar  ">
            <div class="layout-container">

                <!-- sidebar imported -->
                <%- include('../partials/sidebar.ejs') %>

                    <!-- Layout container -->
                    <div class="layout-page">

                        <!-- navbar imported -->
                        <%- include('../partials/navbar.ejs') %>

                            <!-- Content wrapper -->
                            <div class="content-wrapper">

                                <!-- Content -->

                                <div class="container-xxl flex-grow-1 container-p-y">

                                    <div class="d-flex justify-content-between m-0 p-0">
                                        <h4 class="fw-bold py-3 mb-1">Product Stock</h4>
                                        <div class=" text-center mt-3 ">
                                            <a class="btn btn-primary mx-4" style="color: white;" href="/add_product">+
                                                Add Product</a>
                                        </div>
                                    </div>


                                    <div class="d-flex justify-content-between m-0 p-0">
                                        <div class="input-group input-group-merge">
                                            <span class="input-group-text" id="basic-addon-search31"><i
                                                    class="bx bx-search"></i></span>
                                            <input type="text" class="form-control" placeholder="Search Product..."
                                            onkeyup="var value = $(this).val().toLowerCase();$('#inventoryData tbody tr').filter(function() {$(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)});" >
                                        </div>
                                        <!-- <div class="input-group px-3">
                                            <button class="btn btn-primary" type="button">Sort By</button>
                                            <select class="form-select" id="inputGroupSelect03"
                                                aria-label="Example select with button addon">
                                                <option selected="">Choose...</option>
                                                <option value="1">One</option>
                                                <option value="2">Two</option>
                                                <option value="3">Three</option>
                                            </select>
                                        </div> -->
                                    </div>


                                    <hr class="mb-4">

                                    <div class="card" id="inventoryData">
                                        <h5 class="card-header">Product List</h5>
                                        <div class="table-responsive text-nowrap">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>
                                                            <div>Product Name</div>

                                                        </th>

                                                        <th>
                                                            <div>Pack Units</div>

                                                        </th>
                                                        <th>
                                                            <div>HSN</div>

                                                        </th>
                                                        <th>
                                                            <div>Rem Stock</div>

                                                        </th>
                                                        <!-- <th>
                                                            <div>Stock</div>

                                                        </th> -->
                                                        <!-- <th>
                                                            <div>Total Cost</div>

                                                        </th> -->
                                                        <th>
                                                            <div>Status</div>

                                                        </th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="table-border-bottom-0" id="additems">
                                                    
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                </div>
                                <!-- / Content -->

                                <div class="content-backdrop fade"></div>
                            </div>
                            <!-- Content wrapper -->
                    </div>
                    <!-- / Layout page -->
            </div>

            <!-- Overlay -->
            <div class="layout-overlay layout-menu-toggle"></div>

        </div>
        <!-- / Layout wrapper -->

        <%- include('../partials/footercode.ejs') %>

        <script>
            $(document).ready(function(){
                if ('caches' in window) {
                    caches.keys().then(name=>{
                      if(name.length == 0){
                        console.log('do something');
                        caches.open('productCache').then((cache) => {
                          cache.add('/api/allsample');
                        })
                      }
                      else{
                        console.log('do nothing');
                      } 
                    })    
                }

                var orgId = "<%=orgId%>"
                console.log(orgId);


                //for later use
                //

                $.get(`/api/getallinventory?orgID=${orgId}`, function(data, status){
                    var lowHtml = `<td><span class="badge bg-label-danger me-1">LOW</span></td>`;
                    var okHtml = `<td><span class="badge bg-label-success me-1">OK</span></td>`;
                    var items =data.data;
                    console.log('in product stock', items);
                    
                    for(let i=0;i<items.length;i++){
                        var inStock = items[i].batch_qty!=0?items[i].batch_qty:"ADD BATCH";
                        //var totalCost = items[i].purchase_rate*items[i].batch_qty?'â‚¹'+items[i].purchase_rate*items[i].batch_qty:"ADD BATCH";
                        var status = items[i].batch_qty >= items[i].threshold?okHtml:lowHtml;

                        var html= `
                                <tr>
                                    <td id="selectedproduct"><i
                                            class="fab fa-angular fa-lg text-danger me-3"></i><strong>${items[i].med_name}</strong></td>
                                    <td>${items[i].primary_unit} of ${items[i].secondary_unit}</td>
                                    <td>${items[i].hsn}</td>
                                    <td>${inStock}</td>
                                    
                                    ${status}
                                    <td>
                                        <div class="dropdown">
                                            <button type="button"
                                                class="btn p-0 dropdown-toggle hide-arrow"
                                                data-bs-toggle="dropdown"><i
                                                    class="bx bx-dots-vertical-rounded"></i></button>
                                            <div class="dropdown-menu">
                                                <button class="dropdown-item"
                                                     id="addbatch"><i
                                                        class='bx bx-customize me-1'></i>Add
                                                    Batch</button>
                                                <a class="dropdown-item"
                                                    href="/product_batch" id="viewbatches"><i
                                                        class="bx bx-show me-1"></i> View Batches</a>
                                                <button class="dropdown-item" id="editproduct" ><i
                                                        class="bx bx-edit-alt me-1"></i> Edit Product</button>
                                                <a class="dropdown-item" href="javascript:void(0);"><i class="bx bx-trash me-1"></i> Delete</a>
                                                
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            `

                        $("#additems").append(html);
                    }
                })

                
                $("#additems").on('click', "#viewbatches", function(){
                    var item = $(this).closest("tr");
                    var  productName= item.find("#selectedproduct strong").text();
                    var productId;

                    if('caches' in  window){
                        caches.match(`/api/allsample`).then(res=>{
                            if(res){
                                res.json().then(data=>{
                                    let searchTerm = productName;
                                    let results = data.result.filter(item =>item.med_name.toLowerCase().includes(searchTerm.toLowerCase()));
                                    productId = results[0].sample_id;
                                    console.log(productId)
                                    localStorage.setItem('addbatchid', JSON.stringify(productId));
                                })
                            }
                        });
                    }

                })

                $("#additems").on('click', "#addbatch", function(){
                    var item = $(this).closest("tr");
                    var  productName= item.find("#selectedproduct strong").text();
                    var productId;

                    if('caches' in  window){
                        caches.match(`/api/allsample`).then(res=>{
                            if(res){
                                res.json().then(data=>{
                                    let searchTerm = productName;
                                    let results = data.result.filter(item =>item.med_name.toLowerCase().includes(searchTerm.toLowerCase()));
                                    productId = results[0].sample_id;
                                    localStorage.setItem('addbatchid', JSON.stringify(productId));
                                    window.location.href = `/add_batch/${productId}`
                                })
                            }
                        });
                    }

                })

                $("#additems").on('click', "#editproduct",function(){
                    var item = $(this).closest("tr");
                    var  productName= item.find("#selectedproduct strong").text();
                    console.log(productName);
                    var productId;

                    if('caches' in  window){
                        caches.match(`/api/allsample`).then(res=>{
                            if(res){
                                res.json().then(data=>{
                                    let searchTerm = productName;
                                    let results = data.result.filter(item =>item.med_name.toLowerCase().includes(searchTerm.toLowerCase()));
                                    productId = results[0].sample_id;
                                    window.location.href = `/update_addproduct/${productId}`;
                                })
                            }
                        });
                    }
                })

                

               
                
            })
        </script>
    </body>



    </html>