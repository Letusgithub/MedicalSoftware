<%- include('../partials/headercode.ejs') %>
    <!-- Atharv -->

    <body>

        <!-- Layout wrapper -->
        <div class="layout-wrapper layout-content-navbar  ">
            <div class="layout-container">

                <!-- sidebar imported -->
                <%- include('../partials/sidebar.ejs') %>

                    <!-- Layout container -->
                    <div class="layout-page">

                        <!-- navbar imported -->
                        <%- include('../partials/navbar.ejs') %>

                            <!-- Content wrapper -->
                            <div class="content-wrapper">

                                <!-- Content -->

                                <div class="container-xxl flex-grow-1 container-p-y">


                                    <div class="d-flex justify-content-between m-0 p-0">
                                        <h4 class="fw-bold py-3 mb-1"> Add Product</h4>
                                        <button type="button" class="btn btn-icon btn-danger my-2 mx-3"
                                            onclick="history.back()">
                                            <i class='bx bx-x bx-sm'></i>
                                        </button>
                                    </div>
                                    <hr class="mb-4">

                                    <div class="card mb-4 mx-auto col-md-8">
                                        <!-- <form> -->
                                            <div class="card-body ">

                                                <div class="row mb-3">
                                                    <label class="col-sm-2 col-form-label"
                                                        for="basic-icon-default-fullname">Product Name</label>
                                                    <div class="col-sm-10">
                                                        <div class="input-group input-group-merge">
                                                            <span id="basic-icon-default-fullname2"
                                                                class="input-group-text"></span>
                                                            <input type="text" class="form-control"
                                                                id="basic-icon-default-fullname" placeholder=""
                                                                aria-label="John Doe"
                                                                aria-describedby="basic-icon-default-fullname2"
                                                                name="productname"
                                                                >
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="row mb-3">
                                                    <label class="col-sm-2 col-form-label"
                                                        for="basic-icon-default-fullname">Mfg/Mkt</label>
                                                    <div class="col-sm-10">
                                                        <div class="input-group input-group-merge">
                                                            <span id="basic-icon-default-fullname2"
                                                                class="input-group-text"></span>
                                                            <input type="text" class="form-control"
                                                                id="basic-icon-default-fullname" placeholder=""
                                                                aria-label="John Doe"
                                                                aria-describedby="basic-icon-default-fullname2"
                                                                name="brand">
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="row mb-3">
                                                    <label class="col-sm-2 col-form-label"
                                                        for="basic-icon-default-fullname">Salt Comp.</label>
                                                    <div class="col-sm-10">
                                                        <div class="input-group input-group-merge">
                                                            <span id="basic-icon-default-fullname2"
                                                                class="input-group-text"></span>
                                                            <input type="text" class="form-control"
                                                                id="basic-icon-default-fullname" placeholder=""
                                                                aria-label="John Doe"
                                                                aria-describedby="basic-icon-default-fullname2"
                                                                name="salt">
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="row mb-3">

                                                    <label class="col-sm-2 col-form-label"
                                                        for="basic-icon-default-companyname">GST (%)</label>
                                                    <div class="col-sm-4">
                                                        <div class="input-group input-group-merge">
                                                            <span id="basic-icon-default-companyname2"
                                                                class="input-group-text"></span>
                                                            <input type="text" class="form-control"
                                                                id="basic-icon-default-companyname" placeholder=""
                                                                aria-label="John Doe"
                                                                aria-describedby="basic-icon-default-companyname2"
                                                                name="gst">
                                                        </div>
                                                    </div>



                                                    <label class="col-sm-2 col-form-label ps-4"
                                                        for="basic-icon-default-companyname">HSN Code</label>
                                                    <div class="col-sm-4">
                                                        <div class="input-group input-group-merge">
                                                            <span id="basic-icon-default-companyname2"
                                                                class="input-group-text"></span>
                                                            <input type="text" class="form-control"
                                                                id="basic-icon-default-companyname" placeholder=""
                                                                aria-label="John Doe"
                                                                aria-describedby="basic-icon-default-companyname2"
                                                                name="hsn">
                                                        </div>
                                                    </div>


                                                </div>


                                                <div class="row mb-2">
                                                    <label class="col-sm-2 col-form-label"
                                                        for="basic-icon-default-address">Unit</label>
                                                    <div class="col-sm-4 me-0">
                                                        <div class="input-group input-group-merge">
                                                            <select class="form-select" id="exampleFormControlSelect1" name="primary"
                                                                aria-label="Default select example">
                                                                <option selected>Primary</option>
                                                                <option value="STP">Strip</option>
                                                                <option value="AMP">AMP (Ampoules)</option>
                                                                <option value="BOX">Box</option>
                                                                <option value="BTL">BTL (Bottle)</option>
                                                                <option value="CAPS">CAP (Capsule)</option>
                                                                <option value="PCS">PCS (Piece)</option>
                                                                <option value="TUBE">TUBE</option>
                                                                <option value="DROP">DROP</option>
                                                                <option value="DRSP">DRSP (Dry Syrup)</option>
                                                                <option value="E/D">E/D (Eye Drop)</option>
                                                                <option value="EAR/D">EAR/D (Ear Drop)</option>
                                                                <option value="INJ">INJ (Injection)</option>
                                                                <option value="INH">INH (Inhaler)</option>
                                                            </select>
                                                        </div>

                                                    </div>

                                                    <div class="col-sm-1 text-center mx-0 p-0">
                                                        <p class="fs-4">-</p>
                                                    </div>

                                                    <div class="col-sm-4 ms-0">
                                                        <div class="input-group input-group-merge">
                                                            <select class="form-select" id="exampleFormControlSelect1" name="secondary"
                                                                aria-label="Default select example">
                                                                <option selected>Secondary</option>
                                                                <option value="TAB">TAB (Tablet)</option>
                                                                <option value="STP">Strip</option>
                                                                <option value="AMP">AMP (Ampoules)</option>
                                                                <option value="BOX">Box</option>
                                                                <option value="BTL">BTL (Bottle)</option>
                                                                <option value="CAPS">CAP (Capsule)</option>
                                                                <option value="PCS">PCS (Piece)</option>
                                                                <option value="TUBE">TUBE</option>
                                                                <option value="DROP">DROP</option>
                                                                <option value="DRSP">DRSP (Dry Syrup)</option>
                                                                <option value="E/D">E/D (Eye Drop)</option>
                                                                <option value="EAR/D">EAR/D (Ear Drop)</option>
                                                                <option value="INJ">INJ (Injection)</option>
                                                                <option value="INH">INH (Inhaler)</option>

                                                            </select>
                                                        </div>

                                                    </div>
                                                </div>
                                                <!-- conversion moved to batches -->
                                                <!-- <div class="row mb-3">

                                                    <label class="col-sm-2 col-form-label"
                                                        for="basic-icon-default-companyname">Conversion</label>

                                                    <div class="col-sm-4">
                                                        <div class="input-group input-group-merge">
                                                            <span class="input-group-text" id="primarypopulate"></span>
                                                            <span class="input-group-text">=</span>
                                                            <input type="number" class="form-control" placeholder=""
                                                                aria-label="" name="conversion"/>
                                                            <span class="input-group-text" id="secondarypopulate"></span>
                                                        </div>
                                                    </div>

                                                </div> -->

                                                <div class="row mb-3">

                                                    <!-- <label class="col-sm-2 col-form-label"
                                                        for="basic-icon-default-companyname">Shelf Label</label>

                                                    <div class="col-sm-4">
                                                        <div class="input-group input-group-merge">
                                                            <span id="basic-icon-default-companyname2"
                                                                class="input-group-text"></span>
                                                            <input type="text" class="form-control"
                                                                id="basic-icon-default-companyname" placeholder=""
                                                                aria-label="John Doe"
                                                                aria-describedby="basic-icon-default-companyname2"
                                                                name="shelflabel">
                                                        </div>
                                                    </div> -->

                                                    <label class="col-sm-2 col-form-label ps-4"
                                                        for="basic-icon-default-companyname">Threshold</label>

                                                    <div class="col-sm-4">
                                                        <div class="input-group input-group-merge">
                                                            <span id="basic-icon-default-companyname2"
                                                                class="input-group-text"></span>
                                                            <input type="text" class="form-control"
                                                                id="basic-icon-default-companyname" placeholder=""
                                                                aria-label="John Doe"
                                                                aria-describedby="basic-icon-default-companyname2"
                                                                name="threshold">
                                                        </div>
                                                    </div>

                                                    
                                                </div>
                                                <!-- <div class="text-center mx-auto">
                                                    <button type="submit" class="btn btn-primary" id="submitproduct">Add</button>
                                                </div> -->
                                            </div>

                                        <!-- </form> -->
                                    </div>

                                    <div class="card mb-4 mx-auto col-md-8">
                                 
                                        <div class="card-body ">
                                            <h4 class="fs-5">Batch Details</h4>
                                            <hr>

                                            <div class="row mb-2">
                                                <div class="row col-sm-6">
                                                    <label class="col-sm-4 col-form-label"
                                                        for="basic-icon-default-companyname">Quantity</label>
                                                    <div class="col-sm-8">
                                                        <div class="input-group input-group-merge">
                                                            <span id="basic-icon-default-companyname2"
                                                                class="input-group-text"></span>
                                                            <input type="number" class="form-control"
                                                                id="basic-icon-default-companyname" placeholder="Qty"
                                                                aria-label="John Doe" name="addqty"
                                                                aria-describedby="basic-icon-default-companyname2">
                                                                <span class="input-group-text" id="getprimaryunit" ></span>
                                                                
                                                            <!-- <select class="form-select" id="unit" name="unit"
                                                                aria-label="unit">
                                                            </select> -->
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="row col-sm-6">
                                                    <label class="col-sm-4 col-form-label"
                                                        for="basic-icon-default-companyname">Batch NO.</label>
                                                    <div class="col-sm-8 ">
                                                        <div class="input-group input-group-merge">
                                                            <input type="text" class="form-control" placeholder=""
                                                                aria-label="" id="batchname"/>
                                                        </div>
                                                    </div>
                                                </div>
                            <!-- conversion moved to batches -->
                                                <div class="row mb-1 mt-3">

                                                    <label class="col-sm-3 col-form-label"
                                                        for="basic-icon-default-companyname">Conversion</label>

                                                    <div class="col-sm-4">
                                                        <div class="input-group input-group-merge">
                                                            <span class="input-group-text" id="primarypopulate"></span>
                                                            <span class="input-group-text">=</span>
                                                            <input type="number" class="form-control" placeholder=""
                                                                aria-label="" id="conversion"/>
                                                            <span class="input-group-text" id="secondarypopulate"></span>
                                                        </div>
                                                    </div>

                                                </div>
                                            </div>

                                            <div class="row mb-3  ">
                                                <div class="row col-sm-6 mb-3">
                                                    <label class="col-sm-4 col-form-label"
                                                        for="basic-icon-default-companyname">MRP</label>
                                                    <div class="col-sm-8">
                                                        <div class="input-group input-group-merge">
                                                            <span id="basic-icon-default-companyname2"
                                                                class="input-group-text"></span>
                                                            <input type="text" class="form-control"
                                                                id="basic-icon-default-companyname" placeholder=""
                                                                aria-label="John Doe" name="addmrp"
                                                                aria-describedby="basic-icon-default-companyname2">
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="row col-sm-7">
                                                    <label class="col-sm-4 col-form-label"
                                                        for="basic-icon-default-companyname">Purchase Rate</label>
                                                    <div class="col-sm-8">
                                                        <div class="input-group input-group-merge">
                                                            <span id="basic-icon-default-companyname2"
                                                                class="input-group-text"></span>
                                                            <input type="text" class="form-control"
                                                                id="basic-icon-default-companyname" placeholder=""
                                                                aria-label="John Doe" name="addpur"
                                                                aria-describedby="basic-icon-default-companyname2">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- <div class="row mb-3">
                                                <div class="row col-sm-6">
                                                    <label class="col-sm-4 col-form-label"
                                                        for="basic-icon-default-companyname">GST %</label>
                                                    <div class="col-sm-8">
                                                        <div class="input-group input-group-merge">
                                                            <span id="basic-icon-default-companyname2"
                                                                class="input-group-text"></span>
                                                            <input type="text" class="form-control"
                                                                id="basic-icon-default-companyname" placeholder=""
                                                                aria-label="John Doe"
                                                                aria-describedby="basic-icon-default-companyname2">
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="row col-sm-6">
                                                    <label class="col-sm-4 col-form-label"
                                                        for="basic-icon-default-companyname">HSN Code</label>
                                                    <div class="col-sm-8">
                                                        <div class="input-group input-group-merge">
                                                            <span id="basic-icon-default-companyname2"
                                                                class="input-group-text"></span>
                                                            <input type="text" class="form-control"
                                                                id="basic-icon-default-companyname" placeholder=""
                                                                aria-label="John Doe"
                                                                aria-describedby="basic-icon-default-companyname2">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div> -->


                                            <div class="row mb-3">
                                                <div class="row col-sm-6">
                                                    <label class="col-sm-4 col-form-label"
                                                        for="basic-icon-default-address">Exp Date</label>
                                                    <div class="col-sm-8">
                                                        <div class="input-group input-group-merge">

                                                            <input class="form-control" type="date"
                                                                id="html5-date-input" name="addexp"/>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="row col-sm-6">
                                                    <label class="col-sm-4 col-form-label"
                                                        for="basic-icon-default-email">Shelf Label</label>
                                                    <div class="col-sm-8">
                                                        <div class="input-group input-group-merge">
                                                            <span class="input-group-text"></span>
                                                            <input type="text" id="basic-icon-default-email"
                                                                class="form-control" placeholder="" name="addshelf"
                                                                aria-label="john.doe"
                                                                aria-describedby="basic-icon-default-email2">
                                                            <span id="basic-icon-default-email2"
                                                                class="input-group-text"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>






                                            <div class="row justify-content-end">
                                                <div class="col-sm-10">
                                                    <button type="submit" class="btn btn-primary" id="submitbatch">Add</button>
                                                </div>
                                            </div>


                                        </div>
                                
                                </div>


                                </div>
                                <!-- / Content -->

                                <div class="content-backdrop fade"></div>
                            </div>
                            <!-- Content wrapper -->
                    </div>
                    <!-- / Layout page -->
            </div>



            <!-- Overlay -->
            <div class="layout-overlay layout-menu-toggle"></div>


        </div>
        <!-- / Layout wrapper -->

        <%- include('../partials/footercode.ejs') %>
        <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
        <script>
            var productId;
            var orgID= '<%= orgId %>';
            $(document).ready(function(){
                if ('caches' in window) {
                    caches.keys().then(name=>{
                      if(name.length == 0){
                        console.log('do something');
                        caches.open('productCache').then((cache) => {
                          cache.add('/api/allsample');
                        })
                      }
                      else{
                        console.log('do nothing');
                      } 
                    })    
                }
// autopopulate product
                    $("input[name='productname']").autocomplete({
                        minLength: 3,
                        source: function(request, response) {
                            if('caches' in  window){
                                caches.match(`/api/allsample`).then(res=>{
                                    if(res){
                                        res.json().then(data=>{
                                            let searchTerm = request.term;
                                            let results = data.result.filter(item =>item.med_name.toLowerCase().includes(searchTerm.toLowerCase())).slice(0,10);
                                            response(results);
                                        })
                                    }
                                });
                            }
                            else{
                                $.get('/api/allsample', function(data, status){
                                    console.log(data);
                                    let searchTerm = request.term;
                                            let results = data.result.filter(item =>item.med_name.toLowerCase().includes(searchTerm.toLowerCase())).slice(0,10);
                                            response(results);
                                })
                              }
                        },
                        select: function(event, ui) {
                            setTimeout(function(){
                                console.log(ui.item);
                                productId=ui.item.sample_id;
                                $("input[name='productname']").val(ui.item.med_name);
                                $("input[name='brand']").val(ui.item["mfd/mkt"]);
                                $("input[name='salt']").val(ui.item.salt_composition);
                            },0)
                        }
                    }).data('ui-autocomplete')._renderItem = function(ul, item) {
                        return $('<li>')
                        .append('<div>' + item.med_name + '</div>')
                        .appendTo(ul);
                    };
//changes in stp and tabs
                    $("select[name='primary'], select[name='secondary']").on("change", function(){
                        //var primaryUnit = $("select[name='primary']").find('option:selected').text();
                        //var secondaryUnit = $("select[name='secondary']").find('option:selected').text();
                        var primaryUnit = $("select[name='primary']").val();
                        var secondaryUnit = $("select[name='secondary']").val();


                        $("#primarypopulate").text(`1 ${primaryUnit}`);
                        $("#secondarypopulate").text(`${secondaryUnit}`);
                        $("#getprimaryunit").text(primaryUnit);
                    })

//submit process after adding batch

                $("#submitbatch").click(function(){
                    var productDetails ={
                         product_id: productId,
                         org_id: orgID,
                         gst : $("input[name='gst']").val(),
                         hsn : $("input[name='hsn']").val(),
                         primary_unit : $("select[name='primary']").val(),
                         secondary_unit : $("select[name='secondary']").val(),
                         threshold: $("input[name='threshold']").val()
                    }
                    console.log('product details', productDetails);
                    $.ajax({
                        url: `/api/createinventory/`,
                        type: 'POST',
                        data: JSON.stringify(productDetails),
                        contentType: 'application/json',
                        success: function(response){
                            //window.location.href='/product_stock'
                            //add the batch to the respective product
                            var batchDetails = {
                                product_id: productId,
                                org_id: orgID,
                                batch_name: $("#batchname").val(),
                                exp_date: $("input[name='addexp']").val(),
                                conversion:$("#conversion").val(),
                                batch_qty: $("input[name='addqty']").val(),
                                purchase_rate: $("input[name='addpur']").val(),
                                mrp: $("input[name='addmrp']").val(),
                                shelf_label: $("input[name='addshelf']").val()
                             }
                             console.log(batchDetails);
                             
                             $.ajax({
                                 url: `/api/addbatch/`,
                                 type: 'POST',
                                 data: JSON.stringify(batchDetails),
                                 contentType: 'application/json',
                                 success: function(response){
                                     //window.location.href='/product_stock'  
                                     //localStorage.setItem('addbatchid', productId);        
                                     window.location.href=`/add_batch/${productId}`          
                                     console.log(response);        
                                 },
                                 error: function(error){
                                     console.log(error);
                                 }
                             })                
                        },
                        error: function(error){
                            console.log(error);
                        }
                    })
                })
                
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            })
        </script>

    </body>


    </html>