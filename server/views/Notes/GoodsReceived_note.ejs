<%- include('../partials/headercode.ejs') %>

<body>
    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar  ">
        <div class="layout-container">

            <!-- sidebar imported -->
            <%- include('../partials/sidebar.ejs') %>

                <!-- Layout container -->
                <div class="layout-page">

                    <!-- navbar imported -->
                    <%- include('../partials/navbar.ejs') %>
                    <div class="content-wrapper">

                        <!-- Content -->

                        <div class="container-xxl flex-grow-1 container-p-y">
                            <h4 class="fw-bold py-3 mb-1">Goods Received Note</h4>
                            <hr class="mb-4">

                            <div class="row">

                                <div class="col-md-6">
                                    <div class="card mb-4">
                                        <h5 class="card-header">Vendor Name</h5>
                                        <div class="card-body" id="vendorname">
                                            <select class="form-select" id="vendorselect"
                                                aria-label="Default select example">
                                                <option selected>Select Vendor</option>
                                                <%vendors.forEach(function(vendor) {%>
                                                    <option value="<%= vendor.vendor_id %>">
                                                        <%= vendor.vendor_name %>
                                                    </option>
                                                    <%});%>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="card mb-4 py-1">

                                        <h6 class="card-header py-1" id="contact"></h6>
                                        <h6 class="card-header py-1" id="email"></h6>
                                        <h6 class="card-header py-1" id="dl_no"></h6>
                                        <h6 class="card-header py-1" id="gstin"></h6>
                                        <h6 class="card-header py-1" id="address"></h6>

                                    </div>
                                </div>
                                <div class="d-flex justify-content-between m-0 p-0">
                                    <h4 class="fw-bold py-3 mb-1"> Add Product To Your Cart</h4>
                                    
                                </div>
                                <hr class="mb-4">
                                <div class="card mb-4 mx-auto col-md-8">

                                    <div class="card-body ">
    
                                        <div class="row mb-3">
                                            <label class="col-sm-2 col-form-label"
                                                for="basic-icon-default-fullname">Product Name</label>
                                            <div class="col-sm-10">
                                                <div class="input-group input-group-merge">
                                                    <span id="basic-icon-default-fullname2"
                                                        class="input-group-text"></span>
                                                    <input type="text" class="form-control"
                                                        id="medicinename" placeholder="Type some letters of the medicine name"
                                                        aria-label="John Doe" 
                                                        aria-describedby="basic-icon-default-fullname2"
                                                        name="productname">
                                                </div>
                                            </div>
                                        </div>
    
                                        <div class="row mb-3">
                                            <label class="col-sm-2 col-form-label"
                                                for="basic-icon-default-fullname">Mfg/Mkt</label>
                                            <div class="col-sm-10">
                                                <div class="input-group input-group-merge">
                                                    <span id="basic-icon-default-fullname2"
                                                        class="input-group-text"></span>
                                                    <input type="text" class="form-control"
                                                        id="basic-icon-default-fullname" placeholder=""
                                                        aria-label="John Doe"
                                                        aria-describedby="basic-icon-default-fullname2"
                                                        name="brand">
                                                </div>
                                            </div>
                                        </div>
    
                                        <div class="row mb-3">
                                            <label class="col-sm-2 col-form-label"
                                                for="basic-icon-default-fullname">Salt Comp.</label>
                                            <div class="col-sm-10">
                                                <div class="input-group input-group-merge">
                                                    <span id="basic-icon-default-fullname2"
                                                        class="input-group-text"></span>
                                                    <input type="text" class="form-control"
                                                        id="basic-icon-default-fullname" placeholder=""
                                                        aria-label="John Doe"
                                                        aria-describedby="basic-icon-default-fullname2" name="salt">
                                                </div>
                                            </div>
                                        </div>
    
                                        <div class="row mb-3">
    
                                            <label class="col-sm-2 col-form-label"
                                                for="basic-icon-default-companyname">GST (%)</label>
                                            <div class="col-sm-4">
                                                <div class="input-group input-group-merge">
                                                    <select class="form-select" name="gst" id="gst">
                                                        <option selected>Select option</option>
                                                        <option value="0">0%</option>
                                                        <option value="5">5%</option>
                                                        <option value="12">12%</option>
                                                        <option value="18">18%</option>
                                                        <option value="28">28%</option>
                                                    </select>
                                                </div>
                                            </div>
    
    
    
                                            <label class="col-sm-2 col-form-label ps-4"
                                                for="basic-icon-default-companyname">HSN Code</label>
                                            <div class="col-sm-4">
                                                <div class="input-group input-group-merge">
                                                    <span id="basic-icon-default-companyname2"
                                                        class="input-group-text"></span>
                                                    <input type="text" class="form-control"
                                                        id="basic-icon-default-companyname" placeholder=""
                                                        aria-label="John Doe"
                                                        aria-describedby="basic-icon-default-companyname2"
                                                        name="hsn">
                                                </div>
                                            </div>
    
    
                                        </div>
    
    
                                        <div class="row mb-2">
                                            <label class="col-sm-2 col-form-label"
                                                for="basic-icon-default-address">Unit</label>
                                            <div class="col-sm-4 me-0">
                                                <div class="input-group input-group-merge">
                                                    <select class="form-select" id="exampleFormControlSelect1"
                                                        name="primary" aria-label="Default select example">
                                                        <option selected>Primary</option>
                                                        <option value="STP">Strip</option>
                                                        <option value="AMP">AMP (Ampoules)</option>
                                                        <option value="BOX">Box</option>
                                                        <option value="BTL">BTL (Bottle)</option>
                                                        <option value="CAPS">CAP (Capsule)</option>
                                                        <option value="PCS">PCS (Piece)</option>
                                                        <option value="TUBE">TUBE</option>
                                                        <option value="DROP">DROP</option>
                                                        <option value="DRSP">DRSP (Dry Syrup)</option>
                                                        <option value="E/D">E/D (Eye Drop)</option>
                                                        <option value="EAR/D">EAR/D (Ear Drop)</option>
                                                        <option value="INJ">INJ (Injection)</option>
                                                        <option value="INH">INH (Inhaler)</option>
                                                    </select>
                                                </div>
    
                                            </div>
    
                                            <div class="col-sm-1 text-center mx-0 p-0">
                                                <p class="fs-4">-</p>
                                            </div>
    
                                            <div class="col-sm-4 ms-0">
                                                <div class="input-group input-group-merge">
                                                    <select class="form-select" id="exampleFormControlSelect1"
                                                        name="secondary" aria-label="Default select example">
                                                        <option selected>Secondary</option>
                                                        <option value="TAB">TAB (Tablet)</option>
                                                        <option value="STP">Strip</option>
                                                        <option value="AMP">AMP (Ampoules)</option>
                                                        <option value="BOX">Box</option>
                                                        <option value="BTL">BTL (Bottle)</option>
                                                        <option value="CAPS">CAP (Capsule)</option>
                                                        <option value="PCS">PCS (Piece)</option>
                                                        <option value="TUBE">TUBE</option>
                                                        <option value="DROP">DROP</option>
                                                        <option value="DRSP">DRSP (Dry Syrup)</option>
                                                        <option value="E/D">E/D (Eye Drop)</option>
                                                        <option value="EAR/D">EAR/D (Ear Drop)</option>
                                                        <option value="INJ">INJ (Injection)</option>
                                                        <option value="INH">INH (Inhaler)</option>
    
                                                    </select>
                                                </div>
    
                                            </div>
                                        </div>
    
                                        <div class="row mb-3">
    
                                            <label class="col-sm-2 col-form-label"
                                                for="basic-icon-default-companyname">Min Order Quantity</label>
    
                                            <div class="col-sm-4">
                                                <div class="input-group input-group-merge">
                                                    <span id="basic-icon-default-companyname2"
                                                        class="input-group-text"></span>
                                                    <input type="text" class="form-control"
                                                        id="basic-icon-default-companyname" placeholder=""
                                                        aria-label="John Doe"
                                                        aria-describedby="basic-icon-default-companyname2"
                                                        name="threshold">
                                                </div>
                                            </div>
    
    
                                        </div>
    
                                    </div>
    
    
                                </div>
                                <div class="card mb-4 mx-auto col-md-8">

                                    <div class="card-body ">
                                        <h4 class="fs-5">Batch Details</h4>
                                        <hr>
    
                                        <div class="row mb-3">
    
    
                                            <label class="col-sm-2 col-form-label "
                                                for="basic-icon-default-companyname">Batch No.</label>
                                            <div class="col-sm-4">
                                                <div class="input-group input-group-merge">
                                                    <span id="basic-icon-default-companyname2"
                                                        class="input-group-text"></span>
                                                    <input type="text" class="form-control" placeholder=""
                                                        aria-label="" id="batchname" />
                                                </div>
                                            </div>
    
                                            <label class="col-sm-2 col-form-label ps-4"
                                                for="basic-icon-default-address">Exp Date</label>
                                            <div class="col-sm-4">
                                                <div class="input-group input-group-merge">
                                                    <input class="form-control" type="date" id="html5-date-input"
                                                        name="addexp" />
                                                </div>
                                            </div>
                                        </div>
    
                                        <div class="row mb-3">
                                            <label class="col-sm-2 col-form-label"
                                                for="basic-icon-default-companyname">Conversion</label>
    
                                            <div class="col-sm-4">
                                                <div class="input-group input-group-merge">
                                                    <span class="input-group-text" id="primarypopulate"></span>
                                                    <span class="input-group-text">=</span>
                                                    <input type="number" class="form-control" placeholder=""
                                                        aria-label="" id="conversion" />
                                                    <span class="input-group-text" id="secondarypopulate"></span>
                                                </div>
                                            </div>
    
                                            <label class="col-sm-2 col-form-label ps-4"
                                                for="basic-icon-default-companyname">Shelf Label</label>
                                            <div class="col-sm-4">
                                                <div class="input-group input-group-merge">
                                                    <span id="basic-icon-default-companyname2"
                                                        class="input-group-text"></span>
                                                    <input type="number" class="form-control" name="addshelf" id="shelflabel">
                                                    <span class="input-group-text" id="getshelfnumber"></span>
                                                </div>
                                            </div>
                                        </div>
    
                                        <div class="row mb-3  ">
    
                                            <label class="col-sm-2 col-form-label"
                                                for="basic-icon-default-companyname">MRP</label>
                                            <div class="col-sm-4">
                                                <div class="input-group input-group-merge">
                                                    <span id="basic-icon-default-companyname2"
                                                        class="input-group-text"></span>
                                                    <input type="text" class="form-control" name="addmrp" id="price">
                                                </div>
                                            </div>
    
    
    
                                            <label class="col-sm-2 col-form-label ps-4"
                                                for="basic-icon-default-companyname">Purchase Rate</label>
                                            <div class="col-sm-4">
                                                <div class="input-group input-group-merge">
                                                    <span id="basic-icon-default-companyname2"
                                                        class="input-group-text"></span>
                                                    <input type="text" class="form-control" id="addpur">
                                                </div>
                                            </div>
    
                                        </div>
    
                                        <div class="row mb-3">
    
                                            <label class="col-sm-2 col-form-label"
                                                for="basic-icon-default-email">P.Unit</label>
                                            <div class="col-sm-4">
                                                <div class="input-group input-group-merge">
                                                    <span class="input-group-text"></span>
                                                    <input type="text" id="basic-icon-default-email"
                                                        class="form-control" placeholder="" id="pUnit" name="primary">
                                                </div>
                                            </div>

                                            <label class="col-sm-2 col-form-label ps-4"
                                                for="basic-icon-default-companyname">S.Unit</label>
                                            <div class="col-sm-4">
                                                <div class="input-group input-group-merge">
                                                    <span id="basic-icon-default-companyname2"
                                                        class="input-group-text"></span>
                                                    <input type="text" class="form-control" id="sUnit" name="secondary">
                                                </div>
                                            </div>
                                          </div>


                                          <div class="row mb-3">
    
                                            <label class="col-sm-2 col-form-label"
                                                for="basic-icon-default-email">Discount</label>
                                            <div class="col-sm-4">
                                                <div class="input-group input-group-merge">
                                                    <span class="input-group-text"></span>
                                                    <input type="text" id="basic-icon-default-email"
                                                        class="form-control" placeholder="" id="discount">
                                                </div>
                                            </div>

                                            <label class="col-sm-2 col-form-label ps-4"
                                                for="basic-icon-default-companyname">Total</label>
                                            <div class="col-sm-4">
                                                <div class="input-group input-group-merge">
                                                    <span id="basic-icon-default-companyname2"
                                                        class="input-group-text"></span>
                                                    <input type="text" class="form-control" id="total" name="total">
                                                </div>
                                            </div>

                                           
                                          </div>  
    
                                        <div class="row justify-content-end">
                                            <div class="col-sm-10">
                                                <button type="submit" class="btn btn-primary"
                                                    id="addtocart">Add to Cart</button>
                                            </div>
                                        </div>
    
    
                                    </div>
                                    
                                    
    
                                </div>
                                <hr class="mb-4">
                                <div class="row mx-3">
                                    <div class="card mx-0">
                                        <h5 class="card-header">Cart</h5>
                                        <div class="card-body">
                                          <div class="table-responsive text-nowrap">
                                            <table class="table table-bordered">
                                              <thead>
                                                <tr>
                                                  <th class="col-1">#</th>
                                                  <th class="col-7">Product name</th>
                                                  <th class="col-7">Batch</th>
                                                  <th class="col-1" id="priqtycart">PQty</th>
                                                  <th class="col-1" id="secqtycart">SQty</th>
                                                  <th class="col-1">MRP/PUnit</th>
                                                  <th class="col-1">Disc %</th>
                                                  <th class="col-1">Total</th>
                                                  <th class="col-1">Action</th>
                      
                                                </tr>
                                              </thead>
                                              <tbody id="cart">
                                               
                                              </tbody>
                                            </table>
                                          </div>
                                        </div>
                                      </div>
                                </div>
                               

                                

                            </div>
                            <hr class="mb-4">
                            
                            <div class="row mx-3">
                                


                                <div class="d-flex row m-0 p-0">
                                    

                                  <h4 class="col-7 fw-bold py-3 mb-4">Order Summary</h4>
                                  <div class="col-5">
                                    <div class="mb-1 row">
                
                                      <label for="reference" class="col-3 form-label mb-0"><span style="font-size: 20px; color: red">*</span>Reference</label>
                                      <div class="col-9 mb-2">
                                        <input class="form-control" type="text" placeholder="Doctor/Hospital" id="reference" />
                                      </div>
                                    </div>
                                  </div>
                                </div>
                
                                <div class="col-md-3">
                                  <div class="card mb-4">
                                    <h5 class="card-header"> Subtotal</h5>
                                    <div class="card-body">
                                      <div>
                
                                        <input type="text" class="form-control" id="subtotal"
                                          aria-describedby="defaultFormControlHelp" />
                
                                      </div>
                                    </div>
                                  </div>
                                </div>
                
                
                                <div class="col-md-3">
                                  <div class="card mb-4">
                                    <h5 class="card-header">Additional Discount (â‚¹)</h5>
                                    <div class="card-body">
                                      <div>
                
                                        <input type="text" class="form-control" id="additionaldiscount"
                                          aria-describedby="defaultFormControlHelp" />
                
                                      </div>
                                    </div>
                                  </div>
                                </div>
                
                                <div class="col-md-3">
                                  <div class="card mb-4">
                                    <div class="d-flex justify-content-between m-0 p-0">
                                      <h5 class="card-header">Final Amount</h5>
                                    </div>
                
                                    <div class="card-body pt-0">
                                      <div>
                
                                        <input type="text" class="form-control" id="finalamount"
                                          aria-describedby="defaultFormControlHelp" />
                
                                      </div>
                                    </div>
                                  </div>
                                </div>
                
                                <div class="col-md-3">
                                  <div class="card mb-4">
                                    <h5 class="card-header">Mode of Payment</h5>
                                    <div class="card-body">
                                      <div>
                                        <select class="form-select" id="mop" name="mop" aria-label="select mop">
                                          <option selected disabled>Select Option</option>
                                          <option value="cash">Cash</option>
                                          <option value="upi">UPI</option>
                                          <option value="debit-card">Debit card</option>
                                          <option value="credit-card">Credit card</option>
                                        </select>
                
                                      </div>
                                    </div>
                                  </div>
                                </div>
                
                              </div>
                              <div class="mb-4">


                                <div class="form-check mt-3">
                                  <div>
                                    <input class="form-check-input mx-auto" type="checkbox" value="" id="defaultCheck1" checked>
                                    <label class="form-check-label mx-1" for="defaultCheck1" >
                                      Disclaimer : Hereby I asure that product details given here is
                                      validated by this pharmacy .
                                    </label>
                                  </div>
                                  
                                </div>
                
                
                              </div>
                              <div class="text-center mb-4">
                                <a>
                                  <div class="btn btn-primary px-5" id="submitorder">Submit</div>
                                </a>
                              </div>
                            </div>
                        </div>
                    </div>
                    </div>
                    </div>
                        
                       
                        
                         
                        
                          
                        
                        
                        
                    <%- include('../partials/footercode.ejs') %>
                    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
                    <script>
                        var productId;
                        var orgID = '<%= orgId %>';
                        var customerData = [];
                        var autoCompleteDataNumber = [];
                        var autoCompleteDataName = [];
                        var primaryUnit;
                        var secondaryUnit;
                        var conversion;
                        var batchIdwhenSelected;
                        var availablePrimaryQty;
                        var availableSecondaryQty;
                        localStorage.removeItem('grnitems');
                        var cartarray = [];
                $(document).ready(function () {
                        $("#contact").text("Contact No :");
                        $("#email").text("Email :");
                        $("#dl_no").text("DL No. :");
                        $("#gstin").text("GSTIN :");
                        $("#address").text("Address :");
                        var vendorId = -1;
                    $('#vendorselect').change(function () {
                            var selectedVendorId = $(this).val();

                            $.get(`/api/getvendor/${selectedVendorId}`, function (data, status) {
                                var vendorDetails = data.data;
                                console.log(vendorDetails);
                                vendorId = vendorDetails.vendor_id;
                                
                                var number = `Contact: ${vendorDetails.vendor_contact}`
                                var email = `Email : ${vendorDetails.vendor_email}`
                                var dl_no = `DL No. : ${vendorDetails.vendor_dl_no_1}`
                                var gstin = `GSTIN : ${vendorDetails.vendor_gstin}`
                                var address = `Address : ${vendorDetails.vendor_address}`
                                $("#contact").text(number);
                                $("#email").text(email);
                                $("#dl_no").text(dl_no);
                                $("#gstin").text(gstin);
                                $("#address").text(address);
                            });
                        });
                    $("input[name='productname']").autocomplete({
                        minLength: 3,
                        source: function (request, response) {
                            if ('caches' in window) {
                                caches.match(`/api/allsample`).then(res => {
                                    if (res) {
                                        res.json().then(data => {
                                            let searchTerm = request.term;
                                            let results = data.result.filter(item => item.med_name.toLowerCase().includes(searchTerm.toLowerCase())).slice(0, 10);

                                            if (results.length === 0) {
                                                results.push({ med_name: null }); // Add a null item for the custom message
                                            }

                                            response(results);
                                        })
                                    }
                                });
                            }
                            else {
                                $.get('/api/allsample', function (data, status) {
                                    let searchTerm = request.term;
                                    let results = data.result.filter(item => item.med_name.toLowerCase().includes(searchTerm.toLowerCase())).slice(0, 10);

                                    if (results.length === 0) {
                                        results.push({ med_name: null }); // Add a null item for the custom message
                                    }
                                    response(results);
                                })
                            }
                        },
                        select: function (event, ui) {
                            setTimeout(function () {
                                console.log(ui.item);
                                productId = ui.item.sample_id;
                                $("input[name='productname']").val(ui.item.med_name);
                                $("input[name='brand']").val(ui.item.mfd_mkt);
                                $("input[name='salt']").val(ui.item.salt_composition);
                            }, 0)
                        }
                    }).data('ui-autocomplete')._renderItem = function (ul, item) {
                        
                            if(item.med_name){

                                return $('<li>')
                                    .append('<div>' + item.med_name + '</div>')
                                    .appendTo(ul);
                            }
                            else{
                                return $('<li>').append('<div>No matching products found</div>').appendTo(ul);
                            }
                         
                    };
                $("select[name='primary'], select[name='secondary']").on("change", function () {
                        //var primaryUnit = $("select[name='primary']").find('option:selected').text();
                        //var secondaryUnit = $("select[name='secondary']").find('option:selected').text();
                        var primaryUnit = $("select[name='primary']").val();
                        var secondaryUnit = $("select[name='secondary']").val();


                        $("#primarypopulate").text(`1 ${primaryUnit}`);
                        $("#secondarypopulate").text(`${secondaryUnit}`);
                        //$("#getprimaryunit").text(primaryUnit);
                    })
                $("input[name='addexp']").on('input', function () {
                        var input = $(this);
                        var exp_date = input.val();
                        if (exp_date < new Date().toJSON().slice(0, 10)) {
                            $("input[name='addexp']").val(null);
                            return alert('PLEASE ADD CORRECT EXPDate FIRST');
                        }
                    });
                $.get(`/api/getbatch?id=${productId}&org=<%=orgId%>`, function(data, status){   
                  batchIdwhenSelected = data.data[0].batch_id;
                  primaryUnit=data.data[0].primary_unit;
                  secondaryUnit=data.data[0].secondary_unit;
                  conversion=data.data[0].conversion;

                  availablePrimaryQty = data.data[0].batch_qty - data.data[0].saled_pri_qty;
                  availableSecondaryQty = (data.data[0].conversion - data.data[0].saled_sec_qty) == data.data[0].conversion?0:data.data[0].conversion - data.data[0].saled_sec_qty;
                  //doubt   $("#primaryunitname span").text(` (${primaryUnit})`);
                  //doubt   $("#secondaryunitname span").text(` (${secondaryUnit})`);

                    
                    });
                    var priQty = $("#pUnit");
                    var secQty = $("#sUnit");
                    var priceInput = $("#price");
                    var discInput = $("#discount");
                    var totalInput = $("#total");  
                    priQty.on("input", calculateTotal);
                    secQty.on("input", calculateTotal);
                    discInput.on("input", calculateTotal); 
                    function calculateTotal() {
                       var primaryqty = parseInt(priQty.val()) || 0;
                       var secondaryqty = parseInt(secQty.val()) || 0;
                       var price = parseFloat(priceInput.val()) || 0;
                       var discount = parseFloat(discInput.val()) || 0;
                       discount = discount / 100;

                     //var total = quantity * price - (quantity * price * discount);
                    var totalQtyBeforeDisc = primaryqty * price + secondaryqty * price/conversion;
                    var totalQtyAfterDisc = totalQtyBeforeDisc - (totalQtyBeforeDisc * discount);
                    totalInput.val(totalQtyAfterDisc.toFixed(2));
                    } 

                    var cartItems = JSON.parse(localStorage.getItem('cartitems')) || [];
                    //var custDataLocal = JSON.parse(localStorage.getItem('custdata')) || [];
                    if (cartItems.length = 0) {
                        $("#subtotal").val(0);
                        $("#additionaldiscount").val(0);
                        $("#finalamount").val(0);
                    }
                    renderRefreshCart(cartItems);

          function renderRefreshCart(items) {
            $('#cart').empty();

            for (var i = 0; i < items.length; i++) {
              cartarray.push(items[i]);

              htmlData = `
              <tr>
                <td class="card_id">${i + 1}</td>
                <td><i class="fab fa-angular fa-lg text-danger me-3"></i> <strong>${items[i].productname}</strong></td>
                <td>${items[i].priQty}</td>
                <td>${items[i].secQty}</td>
                <td>${items[i].mrp}</td>
                <td>${items[i].disc}</td>
                <td>${items[i].total}</td>
                <td>
                  <div class="action-btns">
                    <button type="button" id="edit-button" class="edit-button btn p-0 mx-2"><i class='bx bxs-edit'></i></button>
                    <button type="button" class="delete-button btn p-0 mx-2"><i class="bx bx-trash me-1"></i></button>
                  </div>
                </td>
              </tr>
                        `
              $('#cart').append(htmlData);
            }
          }

          var setLocalData;
          var getLocalData;
          var htmlData;
          $("#addtocart").click(function () {
            if($("#pUnit").val()==''){
              return alert('PLEASE ADD QUANTITY FIRST');
            }

            if($("#batch").val()==''){
              return alert('PLEASE ADD BATCH FIRST');
            }

            if($('[name="addexp"]').val() < new Date().toJSON().slice(0, 10)){
              return alert('PLEASE ADD CORRECT EXP Date FIRST');
            }
            var products = $("#medicinename").val();
            var brand = $('[name="brand"]').val();
            var priCartQty = priQty.val();
            var secCartQty = secQty.val();
            var mrp = priceInput.val();
            var disc = discInput.val();
            var total = totalInput.val();
            var shelflabel = $("#shelflabel").val();
            var batch = $("#batchname").val();
            var exp = $('[name="addexp"]').val();
            var selectedUnit = $("#unit").val();

            cartarray.push({
              batchId: batchIdwhenSelected, 
              productId: productId,
              productname: products,
              brand: brand,
              shelflabel: shelflabel,
              batch: batch,
              //allbatches: batchesMap,
              expdate: exp,
              priQty: priCartQty,
              secQty: secCartQty,
              conversion:conversion,
              selectedUnit:selectedUnit,
              mrp: mrp,
              disc: disc,
              total: total,
              timestamp: new Date().getTime()
            })

            setLocalData = JSON.stringify(cartarray);

            localStorage.setItem("cartitems", setLocalData);

            //also add the customer data to local storage
            var storeVendorData = {
              name: $("#vendorname").val(),
              phone: $("#contact").val()
            };

            localStorage.setItem("vendordata", JSON.stringify(storeVendorData));

            //add the logic for blanking when refreshed
        })

        // logic for redering cart data on addtocart click 
        $("#addtocart").on('click', function () {
            cartItems = JSON.parse(localStorage.getItem('cartitems')) || [];
            renderCart(cartItems);
            getSubTotal();
          });

          //where rendercart and getsubtotal defined ? define that too
          //deletefunctionality
          $("#cart").on("click", ".delete-button", function () {
            var item = $(this).closest("tr");
            var item_id = item.find(".card_id").text().trim();
            var cartItemsinStorage = JSON.parse(localStorage.getItem('cartitems')) || [];
            cartItemsinStorage.splice(item_id - 1, 1);
            cartarray = cartItemsinStorage;
            localStorage.setItem('cartitems', JSON.stringify(cartItemsinStorage));
            renderCart(cartItemsinStorage);
          });
          //endofdeletefunctionality
          //rendercart functionality
          function renderCart(items) {
            $('#cart').empty();

            for (var i = 0; i < items.length; i++) {
              htmlData = `
                          <tr>
                            <td class="card_id">${i + 1}</td>
                            <td><i class="fab fa-angular fa-lg text-danger me-3"></i> <strong>${items[i].productname}</strong></td>
                            <td>${items[i].priQty}</td>
                            <td>${items[i].secQty}</td>
                            <td>${items[i].mrp}</td>
                            <td>${items[i].disc}</td>
                            <td>${items[i].total}</td>
                            <td>
                              <div class="action-btns">
                                <button type="button" id="edit-button" class="edit-button btn p-0 mx-2"><i class='bx bxs-edit'></i></button>
                                <button type="button" class="delete-button btn p-0 mx-2"><i class="bx bx-trash me-1"></i></button>
                              </div>
                            </td>
                          </tr>
                          `
              $('#cart').append(htmlData);
            }
          }
          //end of rendereing data logic

          function checkExpiration() {
            var data = JSON.parse(localStorage.getItem('cartitems')) || [];

            if (data.length != 0) {
              var currentTime = new Date().getTime();
              var last = data[data.length - 1].timestamp;
              if (data && (currentTime - last) >= (60 * 60 * 1000)) {
                console.log("expired");
                localStorage.removeItem('cartitems');
                localStorage.removeItem('vendordata');
              }
            }
          }

          checkExpiration();
          //getting the subtotal when theres change in local storage
          var getAllData = JSON.parse(localStorage.getItem("cartitems")) || [];
          getSubTotal();
          $("#cart").on("click", ".delete-button, .edit-button", function () {
            getSubTotal();
          })

          function getSubTotal() {

                var subtotal = 0;
                getAllData = JSON.parse(localStorage.getItem("cartitems")) || [];

                if (getAllData.length != 0) {

                     for (let i = 0; i < getAllData.length; i++) {
                     subtotal = subtotal + parseFloat(getAllData[i].total);
                    }

                $("#subtotal").val(subtotal.toFixed(2));
                $("#finalamount").val(subtotal.toFixed(0));
                }
                else if (getAllData.length == 0) {
                // console.log("none");
                 $("#subtotal").val(0);
                 $("#finalamount").val(0);
               }}  

               $('#additionaldiscount').on("input", function () {

                 var getSubTotalValue = $("#subtotal").val()
                 var discountInput = $(this).val();
                 var discountprice = getSubTotalValue - discountInput;
               $("#finalamount").val(discountprice.toFixed(0));

               })
//allchanges done for footer total;
               });
                    </script>
                    <script>
                        var addToCart = document.getElementById("addtocart")
                        addToCart.addEventListener("click", displayItems)
                
                        var row = 0
                
                        function displayItems() {
                
                          var medicinename = document.getElementById("medicinename").value
                          var shelflabel = document.getElementsByName("addshelf")[0].value
                          var hsn = document.getElementsByName("hsn")[0].value
                          var batch = document.getElementById("batchname").value
                          var mfgdate = document.getElementById("mfgdate").value
                          var expdate = document.getElementsByName("addexp")[0].value
                          var price = document.getElementById("addmrp").value
                          var pqty = document.getElementById("pUnit").value
                          var sqty = document.getElementById("sUnit").value
                          var discount = document.getElementById("discount").value
                          var gst = document.getElementById("gst").value
                          var total = document.getElementById("total").value
                
                          var cart = document.getElementById("cart");
                
                          var newRow = cart.insertRow(row);
                
                          var cell1 = newRow.insertCell(0);
                          var cell2 = newRow.insertCell(1);
                          var cell3 = newRow.insertCell(2);
                          var cell4 = newRow.insertCell(3);
                          var cell5 = newRow.insertCell(4);
                          var cell6 = newRow.insertCell(5);
                          var cell7 = newRow.insertCell(6);
                          var cell8 = newRow.insertCell(7);
                          var cell9 = newRow.insertCell(8);
                
                          actionHTML = "<div class='action-btns'><button type='button' class='btn p-0 mx-2'><i class='bx bxs-edit'></i></button><button onclick='deleteItem(this)' type='button' class='btn p-0 mx-2'><i class='bx bx-trash me-1'></i></button></div>";
                
                          cell1.innerHTML = row + 1;
                          cell2.innerHTML = medicinename;
                          cell3.innerHTML = batch;
                          cell4.innerHTML = pqty;
                          cell5.innerHTML = sqty;
                          cell6.innerHTML = price;
                          cell7.innerHTML = discount;
                          cell8.innerHTML = total;
                          cell9.insertAdjacentHTML("afterbegin", actionHTML);
                
                          row++;
                        };
                
                        function deleteItem(r) {
                          var i = r.parentNode.parentNode.rowIndex;
                          document.getElementById("cart").deleteRow(i + 1);
                        };
                
                      </script>
</body>
</html>

