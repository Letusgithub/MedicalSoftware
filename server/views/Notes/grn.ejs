<%- include('../partials/headercode.ejs') %>


    <body>
        <!-- Layout wrapper -->
        <div class="layout-wrapper layout-content-navbar  ">
            <div class="layout-container">

                <!-- sidebar imported -->
                <%- include('../partials/sidebar.ejs') %>

                    <!-- Layout container -->
                    <div class="layout-page">

                        <!-- navbar imported -->
                        <%- include('../partials/navbar.ejs') %>
                            <div class="content-wrapper">

                                <!-- Content -->

                                <div class="container-xxl flex-grow-1 container-p-y">



                                    <div class="d-flex justify-content-between m-0 p-0">
                                        <h4 class="fw-bold py-3 mb-1">Purchase Bill</h4>
                                        <div class=" text-center mt-3 d-flex">
                                            <div>
                                                <div class="form-check form-check-inline mt-3">
                                                    <input class="form-check-input" type="radio" name="paymentMethod"
                                                        id="cashRadio" value="CASH" checked>
                                                    <label class="form-check-label" for="cashRadio">Cash</label>
                                                </div>
                                                <div class="form-check form-check-inline mt-3">
                                                    <input class="form-check-input" type="radio" name="paymentMethod"
                                                        id="creditRadio" value="CREDIT">
                                                    <label class="form-check-label" for="creditRadio">Credit</label>
                                                </div>
                                            </div>
                                            <a class="btn btn-primary mx-4" style="color: white;" href="/new_vendor">+
                                                Add Distributor</a>
                                        </div>
                                    </div>

                                    <hr class="mb-4">

                                    <div class="row">

                                        <div class="col-md-6">
                                            <div class="card mb-4">
                                                <h5 class="card-header">Distributor Name</h5>
                                                <div class="card-body" id="vendorname">
                                                    <select class="form-select" id="vendorselect"
                                                        aria-label="Default select example">
                                                        <option selected>Select Distributor</option>
                                                        <%vendors.forEach(function(vendor) {%>
                                                            <option value="<%= vendor.vendor_id %>">
                                                                <%= vendor.vendor_name %>
                                                            </option>
                                                            <%});%>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card mb-4 py-1">

                                                <h6 class="card-header py-1" id="contact"></h6>
                                                <h6 class="card-header py-1" id="email"></h6>
                                                <h6 class="card-header py-1" id="dl_no"></h6>
                                                <h6 class="card-header py-1" id="gstin"></h6>
                                                <h6 class="card-header py-1" id="address"></h6>

                                            </div>
                                        </div>

                                        <div class="col-md-6">
                                            <div class="card mb-4">
                                                <h5 class="card-header">Distributor Invoice Number</h5>
                                                <div class="card-body">
                                                    <input type="text" class="form-control" id="vendorinvoicenumber"
                                                        placeholder="Enter Invoice Number" />
                                                </div>

                                            </div>
                                        </div>

                                        <div class="col-md-6">
                                            <div class="card mb-4">
                                                <div class="card-header d-flex justify-content-between">
                                                    <h5 class="mb-0">Invoice Date </h5>
                                                    <div class="d-flex align-items-center">
                                                        <select class="form-select form-select-sm me-2 mb-0"
                                                            id="creditPeriodInput" style="display: none;">
                                                            <option value="0">0D</option>
                                                            <option value="10">10D</option>
                                                            <option value="15">15D</option>
                                                            <option value="30">30D</option>
                                                        </select>
                                                        <input type="number" class="form-control" id="lessDiscount"
                                                            name="lessDiscount" placeholder="Less Discount in (â‚¹)" />
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                                    <input class="form-control" type="date" id="html5-date-input"
                                                        id="invoiceDate" name="invoiceDate" />
                                                </div>
                                            </div>
                                        </div>




                                        <div class="d-flex justify-content-between m-0 p-0">
                                            <h4 class="fw-bold py-3 mb-1"> Add Product To Your Cart</h4>

                                        </div>
                                        <hr class="mb-4">
                                        <div class="card mb-4 mx-2 col-sm-12">

                                            <div class="card-body ">

                                                <div class="row mb-3">
                                                    <label class="col-sm-2 col-form-label"
                                                        for="basic-icon-default-fullname">Product Name</label>
                                                    <div class="col-sm-10">
                                                        <div class="input-group input-group-merge">
                                                            <span id="basic-icon-default-fullname2"
                                                                class="input-group-text"></span>
                                                            <input type="text" class="form-control" id="medicinename"
                                                                placeholder="Type some letters of the medicine name"
                                                                name="productname">
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="row mb-3">
                                                    <label class="col-sm-2 col-form-label"
                                                        for="basic-icon-default-fullname">Mfg/Mkt</label>
                                                    <div class="col-sm-10">
                                                        <div class="input-group input-group-merge">
                                                            <span id="basic-icon-default-fullname2"
                                                                class="input-group-text"></span>
                                                            <input type="text" class="form-control" id="brand"
                                                                placeholder="" name="brand">
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="row mb-3">
                                                    <label class="col-sm-2 col-form-label"
                                                        for="basic-icon-default-fullname">Salt Comp.</label>
                                                    <div class="col-sm-10">
                                                        <div class="input-group input-group-merge">
                                                            <span id="basic-icon-default-fullname2"
                                                                class="input-group-text"></span>
                                                            <input type="text" class="form-control" id="salt"
                                                                placeholder="" name="salt">
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="row mb-3">

                                                    <label class="col-sm-2 col-form-label"
                                                        for="basic-icon-default-companyname">HSN Code</label>
                                                    <div class="col-sm-4">
                                                        <div class="input-group input-group-merge">
                                                            <input type="number" class="form-control"
                                                                placeholder="Eg- 30049047" id="hsn" name="hsn">
                                                        </div>
                                                    </div>

                                                    <label class="col-sm-2 col-form-label ps-4"
                                                        for="basic-icon-default-companyname">GST (%)</label>
                                                    <div class="col-sm-4">
                                                        <div class="input-group input-group-merge">
                                                            <select class="form-select" name="gst" id="gst">
                                                                <option selected>Select GST %</option>
                                                                <option value="0">0%</option>
                                                                <option value="5">5%</option>
                                                                <option value="12">12%</option>
                                                                <option value="18">18%</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>


                                                <div class="row mb-2">
                                                    <label class="col-sm-2 col-form-label"
                                                        for="basic-icon-default-address">Unit</label>
                                                    <div class="col-sm-4 me-0">
                                                        <div class="input-group input-group-merge">
                                                            <select class="form-select" id="primaryDropdown"
                                                                name="primary" aria-label="Default select example">
                                                                <option selected>Primary</option>
                                                                <option value="STP">STP</option>
                                                                <option value="AMP">AMP</option>
                                                                <option value="BOX">BOX</option>
                                                                <option value="BTL">BTL</option>
                                                                <option value="PCS">PCS</option>
                                                                <option value="TUBE">TUBE</option>
                                                                <option value="DROP">DROP</option>
                                                                <option value="DRSP">DRSP (Dry Syrup)</option>
                                                                <option value="E/D">E/D (Eye Drop)</option>
                                                                <option value="EAR/D">EAR/D (Ear Drop)</option>
                                                                <option value="INJ">INJ (Injection)</option>
                                                                <option value="INH">INH (Inhaler)</option>
                                                            </select>
                                                        </div>

                                                    </div>

                                                    <div class="col-sm-1 text-center mx-0 p-0">
                                                        <p class="fs-4">-</p>
                                                    </div>

                                                    <div class="col-sm-4 ms-0">
                                                        <div class="input-group input-group-merge">
                                                            <select class="form-select" id="secondaryDropdown"
                                                                name="secondary" aria-label="Default select example">
                                                                <option selected>Secondary</option>
                                                            </select>
                                                        </div>

                                                    </div>
                                                </div>

                                                <div class="row mb-3">

                                                    <label class="col-sm-2 col-form-label"
                                                        for="category">Category</label>
                                                    <div class="col-sm-4">
                                                        <div class="input-group input-group-merge">
                                                            <select class="form-select" name="category"
                                                                id="categorySelect">
                                                                <option selected>Select Category</option>
                                                            </select>
                                                        </div>
                                                    </div>

                                                    <label class="col-sm-2 col-form-label ps-4"
                                                        for="basic-icon-default-companyname">Reorder Level</label>

                                                    <div class="col-sm-4">
                                                        <div class="input-group input-group-merge">
                                                            <input type="text" class="form-control"
                                                                id="basic-icon-default-companyname" placeholder=""
                                                                name="threshold">
                                                        </div>
                                                    </div>


                                                </div>

                                            </div>

                                        </div>
                                        <div class="card mb-4 mx-2 col-sm-12">

                                            <div class="card-body ">
                                                <h4 class="fs-5">Batch Details</h4>
                                                <hr>

                                                <div class="row mb-3">

                                                    <label class="col-sm-2 col-form-label "
                                                        for="basic-icon-default-companyname">Batch No.</label>
                                                    <div class="col-sm-4">
                                                        <div class="input-group input-group-merge">
                                                            <input type="text" class="form-control"
                                                                placeholder="Eg- B6AEW8852" id="batchname" />
                                                        </div>
                                                    </div>

                                                    <label class="col-sm-2 col-form-label ps-4"
                                                        for="basic-icon-default-address">Exp Date</label>
                                                    <div class="col-sm-4">
                                                        <div class="input-group input-group-merge">
                                                            <input class="form-control" type="date"
                                                                id="html5-date-input" name="addexp" />
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="row mb-3">
                                                    <label class="col-sm-2 col-form-label"
                                                        for="basic-icon-default-companyname">Conversion</label>

                                                    <div class="col-sm-4">
                                                        <div class="input-group input-group-merge">
                                                            <span class="input-group-text" id="primarypopulate"></span>
                                                            <span class="input-group-text">=</span>
                                                            <input type="number" class="form-control" placeholder=""
                                                                aria-label="" id="conversion" />
                                                            <span class="input-group-text"
                                                                id="secondarypopulate"></span>
                                                        </div>
                                                    </div>

                                                    <label class="col-sm-1 col-form-label  ps-4"
                                                        for="basic-icon-default-email">QTY</label>
                                                    <div class="col-sm-2">
                                                        <div class="input-group input-group-merge">
                                                            <span class="input-group-text"></span>
                                                            <input type="text" id="basic-icon-default-email"
                                                                class="form-control" placeholder="" id="addquantity"
                                                                name="quantity">
                                                        </div>
                                                    </div>

                                                    <label class="col-sm-1 col-form-label  ps-4"
                                                        for="free_scheme">Free</label>
                                                    <div class="col-sm-2">
                                                        <div class="input-group input-group-merge">
                                                            <span id="basic-icon-default-companyname2"
                                                                class="input-group-text"></span>
                                                            <input type="text" class="form-control" name="free_scheme"
                                                                id="free_scheme">
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="row mb-3">

                                                    <label class="col-sm-2 col-form-label"
                                                        for="basic-icon-default-companyname">MRP</label>
                                                    <div class="col-sm-4">
                                                        <div class="input-group input-group-merge">
                                                            <span id="" class="input-group-text"></span>
                                                            <input type="number" class="form-control" name="addmrp"
                                                                placeholder="Eg- 100" id="price">
                                                        </div>
                                                    </div>

                                                    <label class="col-sm-2 col-form-label ps-4"
                                                        for="basic-icon-default-companyname">PTR / Rate</label>
                                                    <div class="col-sm-4">
                                                        <div class="input-group input-group-merge">
                                                            <span id="basic-icon-default-companyname2"
                                                                class="input-group-text"></span>
                                                            <input type="number" class="form-control" id="addpur"
                                                                placeholder="Eg- 78">
                                                        </div>
                                                        <div style="font-size: smaller; color: blue; margin-top: 5px; display: none;"
                                                            id="r_margin">
                                                            Retailer Margin: <span id="retailer_margin"></span>%
                                                        </div>
                                                    </div>

                                                </div>

                                                <div class="row mb-3">
                                                    <label class="col-sm-2 col-form-label" for="bulk_discount">Discount
                                                        (%)</label>
                                                    <div class="col-sm-4">
                                                        <div class="input-group input-group-merge">
                                                            <span id="basic-icon-default-companyname2"
                                                                class="input-group-text"></span>
                                                            <input type="number" class="form-control"
                                                                name="bulk_discount" id="bulk_discount"
                                                                placeholder="Eg- 5%">
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Temporarily Disabled -->
                                                <!-- <div class="row mb-3">
                                                    <label class="col-sm-2 col-form-label"
                                                        for="basic-icon-default-companyname">Shelf Label</label>
                                                    <div class="col-sm-4">
                                                        <div class="input-group input-group-merge">
                                                            <span id="basic-icon-default-companyname2"
                                                                class="input-group-text"></span>
                                                            <input type="text" class="form-control" name="addshelf"
                                                                id="shelflabel">
                                                            <span class="input-group-text" id="getshelfnumber"></span>
                                                        </div>
                                                    </div>
                                                </div> -->



                                                <div class="col-sm-12 text-center">
                                                    <button type="submit" class="btn btn-primary" id="addtocart">Add to
                                                        Cart</button>
                                                    <div>
                                                        <div style=" color: blue; margin-top: 5px; display: none;"
                                                            id="b_price">
                                                            Base price: <span id="base_price"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>


                                        </div>

                                    </div>

                                </div>

                                <hr class="mb-4">

                                <div class="card">
                                    <h5 class="card-header">Cart</h5>
                                    <div class="card-body">
                                        <div class="table-responsive text-nowrap">
                                            <table class="table table-bordered">
                                                <thead>
                                                    <tr>
                                                        <th>#</th>
                                                        <th>Product name</th>
                                                        <th>Batch</th>
                                                        <th>Expiry</th>
                                                        <th>MRP</th>
                                                        <th>PTR</th>
                                                        <th>QTY</th>
                                                        <th>Unit</th>
                                                        <th>GST(%)</th>
                                                        <th>Dis(%)</th>
                                                        <th>Amount</th>
                                                        <th class="col-1">Action</th>

                                                    </tr>
                                                </thead>
                                                <tbody id="cart">

                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>


                                <div class="form-check mt-3">
                                    <div>
                                        <input class="form-check-input mx-auto" type="checkbox" value=""
                                            id="defaultCheck1" checked>
                                        <label class="form-check-label mx-1" for="defaultCheck1">
                                            Disclaimer : Hereby I assure that product details given here is
                                            validated by this pharmacy .
                                        </label>
                                    </div>

                                </div>
                            </div>
                            <div class="text-center mb-4">
                                <a>
                                    <button class="btn btn-primary px-5" id="submitorder">Submit</button>
                                </a>
                            </div>
                    </div>
            </div>
        </div>


        <%- include('../partials/footercode.ejs') %>
            <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
            <script>
                var productId;
                var orgID = '<%= orgId %>';
                var customerData = [];
                var autoCompleteDataNumber = [];
                var autoCompleteDataName = [];
                var primaryUnit;
                var secondaryUnit;
                var batchIdwhenSelected;
                var availablePrimaryQty;
                var availableSecondaryQty;
                localStorage.removeItem('grnitems');
                var cartarray = [];
                $(document).ready(function () {
                    $("#contact").text("Contact No :");
                    $("#email").text("Email :");
                    $("#dl_no").text("DL No. :");
                    $("#gstin").text("GSTIN :");
                    $("#address").text("Address :");

                    // Event listener for changes in the vendor dropdown
                    var vendorId = -1;
                    $('#vendorselect').change(function () {

                        var selectedVendorId = $(this).val();

                        $.get(`/api/getvendor/${selectedVendorId}`, function (data, status) {
                            var vendorDetails = data.data;
                            console.log(vendorDetails);
                            vendorId = vendorDetails.vendor_id;

                            var number = `Contact: ${vendorDetails.vendor_contact}`
                            var email = `Email : ${vendorDetails.vendor_email}`
                            var dl_no = `DL No. : ${vendorDetails.vendor_dl_no_1}, ${vendorDetails.vendor_dl_no_2}`
                            var gstin = `GSTIN : ${vendorDetails.vendor_gstin}`
                            var address = `Address : ${vendorDetails.vendor_address}`

                            $("#contact").text(number);
                            $("#email").text(email);
                            $("#dl_no").text(dl_no);
                            $("#gstin").text(gstin);
                            $("#address").text(address);

                        });
                    });

                    // Event listener for changes in the payment method radio buttons
                    $('input[name="paymentMethod"]').change(function () {
                        // Check if the "Credit" radio button is selected
                        if ($('#creditRadio').is(':checked')) {
                            $('#creditPeriodInput').show();
                            $('#lessDiscount').hide();
                        } else {
                            $('#creditPeriodInput').hide();
                            $('#lessDiscount').show();
                            $('#creditPeriodInput').val('');
                        }
                    });

                    $("input[name='productname']").autocomplete({
                        minLength: 3,
                        source: function (request, response) {
                            let query = request.term;

                            $.ajax({
                                url: `/api/autocomplete?query=${query}`,
                                type: 'GET',
                                success: function (ajaxResponse) {
                                    console.log(ajaxResponse)
                                    let results = ajaxResponse.filter(item => item.med_name.toLowerCase().includes(query.toLowerCase())).slice(0, 10);

                                    if (results.length === 0) {
                                        results.push({ med_name: null }); // Add a null item for the custom message
                                    }
                                    console.log(results);
                                    response(results);
                                },
                                error: function (error) {
                                    console.log(error);
                                }
                            })
                        },
                        select: function (event, ui) {
                            productId = ui.item.id;
                            $.get(`/api/checkbyid?product=${productId}&org=${orgID}`, function (data, status) {
                                console.log('got this data from inventory', data);
                                if (data.data.length == 1) {

                                    var items = data.data[0];
                                    $("select[name = 'gst']").val(items.gst).prop('disabled', true);
                                    $("#hsn").val(items.hsn).prop('disabled', true);
                                    $("select[name='primary']").val(items.primary_unit).prop('disabled', true);
                                    populateSecondaryDropdown();
                                    $("select[name='secondary']").val(items.secondary_unit).prop('disabled', true);
                                    $("input[name='threshold']").val(items.threshold).prop('disabled', true);
                                    $("select[name='category']").val(items.category_id).prop('disabled', true);

                                    var primaryUnit = $("select[name='primary']").val();
                                    var secondaryUnit = $("select[name='secondary']").val();
                                    $("#primarypopulate").text(`1 ${primaryUnit}`);
                                    $("#secondarypopulate").text(`${secondaryUnit}`);
                                }
                            })

                            setTimeout(function () {
                                console.log(ui.item);
                                $("input[name='productname']").val(ui.item.med_name);
                                $("input[name='brand']").val(ui.item.mfd_mkt);
                                $("input[name='salt']").val(ui.item.salt_composition);
                            }, 0)
                        }
                    }).data('ui-autocomplete')._renderItem = function (ul, item) {

                        if (item.med_name) {

                            return $('<li>')
                                .append('<div>' + item.med_name + '</div>')
                                .appendTo(ul);
                        }
                        else {
                            return $('<li>').append('<div>No matching products found</div>').appendTo(ul);
                        }

                    };

                    //HSN-GST autocomplete
                    $("input[name='hsn']").autocomplete({
                        minLength: 3,
                        source: function (request, response) {
                            let query = request.term;

                            $.ajax({
                                url: `/api/search-hsn-gst?query=${query}`,
                                type: 'GET',
                                success: function (ajaxResponse) {
                                    let results = ajaxResponse['data'].filter(item => item.hsn_code);

                                    if (results.length === 0) {
                                        results.push({ hsn_code: null }); // Add a null item for the custom message
                                    }
                                    console.log(results);
                                    response(results);
                                },
                                error: function (error) {
                                    console.log(error);
                                }
                            })
                        },
                        select: function (event, ui) {
                            setTimeout(function () {
                                console.log(ui.item);
                                $("input[name='hsn']").val(ui.item.hsn_code);
                                $("select[name='gst']").val(ui.item.gst_rate);
                            }, 0)
                        }

                    }).data('ui-autocomplete')._renderItem = function (ul, item) {
                        if (item.hsn_code) {
                            return $('<li>')
                                .append('<div>' + item.hsn_code + '</div>')
                                .appendTo(ul);
                        }
                    }

                    // Fetch categories from the API using jQuery
                    $.get("/api/all-category", function (response) {
                        // Get the select element
                        var categorySelect = $("#categorySelect");

                        // Populate the dropdown with options
                        $.each(response.data, function (index, category) {
                            categorySelect.append($('<option>', {
                                value: category.category_id,
                                text: category.category_name
                            }));
                        });
                    }).fail(function (error) {
                        console.error("Error fetching categories:", error);
                    });

                    var secondaryOptions = {
                        STP: ['TAB', 'CAP'],
                        AMP: ['AMP', 'PCS'],
                        BOX: ['BOX', 'TAB', 'CAP', 'PCS', 'BTL', 'TUBE', 'DROP', 'DRSP', 'E/D', 'EAR/D', 'INJ', 'INH'],
                        BTL: ['BTL', 'PCS', 'TAB', 'CAP'],
                        TUBE: ['TUBE', 'PCS'],
                        DROP: ['DROP', 'PCS'],
                        DRSP: ['DRSP', 'PCS'],
                        "E/D": ['E/D', 'PCS'],
                        "EAR/D": ['EAR/D', 'PCS'],
                        INJ: ['INJ', 'PCS'],
                        INH: ['INH', 'PCS']
                    };

                    function populateSecondaryDropdown() {
                        // Clear existing options in the secondary dropdown
                        $('#secondaryDropdown').html('<option selected disabled>Select Secondary</option>');

                        // Get the selected value from the primary dropdown
                        var selectedValue = $('#primaryDropdown').val();

                        // Populate the secondary dropdown with options based on the selected value
                        if (selectedValue in secondaryOptions) {
                            $.each(secondaryOptions[selectedValue], function (index, option) {
                                $('#secondaryDropdown').append('<option value="' + option + '">' + option + '</option>');
                            });
                        }
                    }

                    // Event listener for changes in the primary dropdown
                    $('#primaryDropdown').change(populateSecondaryDropdown);

                    //changes in stp and tabs
                    $("select[name='primary'], select[name='secondary']").on("change", function () {
                        var primaryUnit = $("select[name='primary']").val();
                        var secondaryUnit = $("select[name='secondary']").val();

                        $("#primarypopulate").text(`1 ${primaryUnit}`);
                        $("#secondarypopulate").text(`${secondaryUnit}`);
                    })

                    $("input[name='addexp']").on('input', function () {
                        var input = $(this);
                        var exp_date = input.val();
                        if (exp_date < new Date().toJSON().slice(0, 10)) {
                            $("input[name='addexp']").val(null);
                            return alert('Please add correct Expiry Date');
                        }
                    });

                    // Calculate PTR
                    function calcuatePTR(mrp, gst, retailerMargin) {
                        return (mrp - (mrp * (retailerMargin / 100))) / (1 + (gst / 100));
                    }

                    function calculateRetailerMargin(mrp, ptr, gst) {
                        return ((((mrp - ptr) / mrp) * 100) - ((ptr / mrp) * gst));
                    }

                    // Calcuate Base Price
                    function calcuateBasePrice(mrp, ptr, gst, qty, free, bulkDis) {
                        var free_cf = 1 - (1 / ((1 + (gst / 100)) * (qty + free)));
                        var bulkDis_cf = 1 - (bulkDis / ((1 + (gst / 100)) * 100));

                        if (free == 0) { // Boundary condition
                            return ptr * bulkDis_cf;
                        }
                        return ptr * free_cf * bulkDis_cf;;
                    }

                    // logic for calculating PTR
                    $("select[name='gst']").on("change", function () {
                        $("#price").val(0);
                        $("#addpur").val(0);
                        $("#retailer_margin").text(0);
                        $("#free_scheme").val(0);
                        $("#bulk_discount").val(0);

                        var mrp = parseFloat($("#price").val());
                        var gst = parseFloat($("select[name='gst']").val());
                        var retailerMargin = parseFloat($("#retailer_margin").text());

                        var ptr = calcuatePTR(mrp, gst, retailerMargin);

                        $("#addpur").val(ptr.toFixed(2))
                    });


                    $("#price").on("keyup", function () {
                        $("#r_margin").show();

                        var mrp = parseFloat($("#price").val());
                        var gst = parseFloat($("select[name='gst']").val());
                        var ptr = parseFloat($("#addpur").val());

                        var retailerMargin = calculateRetailerMargin(mrp, ptr, gst);

                        $("#retailer_margin").text(retailerMargin.toFixed(2));
                    });

                    $("#addpur").on("keyup", function () {
                        var mrp = parseFloat($("#price").val());
                        var gst = parseFloat($("select[name='gst']").val());
                        var ptr = parseFloat($("#addpur").val());
                        var qty = parseFloat($("input[name='quantity']").val());
                        var free = parseFloat($("#free_scheme").val());
                        var bulkDis = parseFloat($("#bulk_discount").val());

                        var retailerMargin = calculateRetailerMargin(mrp, ptr, gst);

                        var basePrice = calcuateBasePrice(mrp, ptr, gst, qty, free, bulkDis);

                        $("#retailer_margin").text(retailerMargin.toFixed(2));
                        $("#b_price").show();
                        $("#base_price").text(basePrice.toFixed(2));
                    })

                    // Compute base price on change
                    $("#free_scheme, #bulk_discount, input[name='quantity']").on("keyup", function () {
                        var mrp = parseFloat($("#price").val());
                        var gst = parseFloat($("select[name='gst']").val());
                        var ptr = parseFloat($("#addpur").val());
                        var qty = parseFloat($("input[name='quantity']").val());
                        var free = parseFloat($("#free_scheme").val());
                        var bulkDis = parseFloat($("#bulk_discount").val());

                        var basePrice = calcuateBasePrice(mrp, ptr, gst, qty, free, bulkDis);

                        $("#b_price").show();
                        $("#base_price").text(basePrice.toFixed(2));
                    })

                    //  Clear input fields on product name change
                    $("input[name='productname']").on('input', function () {
                        $("select[name = 'gst']").val('Select option');
                        $("#hsn").val("");
                        $("select[name='primary']").val('Primary');
                        $("select[name='secondary']").val('Secondary');
                        $("input[name='threshold']").val("");
                        $("#brand").val('')
                        $("#salt").val('')
                    })

                    var setLocalData;
                    var getLocalData;
                    var htmlData;

                    var setLocalData;
                    var getLocalData;
                    var htmlData;
                    $("#addtocart").click(function () {

                        if (parseFloat($("#addpur").val()) > parseFloat($("#price").val())) {
                            return alert("Purchase Rate can't be greater than MRP");
                        }
                        $("#r_margin").hide();
                        $("select[name = 'gst']").prop('disabled', false);
                        $("#hsn").prop('disabled', false);
                        $("select[name='primary']").prop('disabled', false);
                        $("select[name='secondary']").prop('disabled', false);
                        $("input[name='threshold']").prop('disabled', false);
                        $("select[name='category']").prop('disabled', false);

                        var products = $("#medicinename").val();
                        var brand = $("#brand").val();
                        var salt = $("#salt").val();
                        var category_id = $("select[name='category']").val();
                        var gst = parseFloat($("select[name = 'gst']").val());
                        var hsn = $("#hsn").val();
                        var Punit = $("select[name='primary']").val();
                        var Sunit = $("select[name='secondary']").val();
                        var moq = $("input[name='threshold']").val();


                        var batch = $("#batchname").val();
                        var exp = $('[name="addexp"]').val();
                        var conversion = $("#conversion").val();
                        var shelflabel = $("#shelflabel").val();
                        var mrp = $("#price").val();
                        var purchase = parseFloat($("#addpur").val());
                        var free = parseFloat($("#free_scheme").val());
                        var bulk_discount = parseFloat($("#bulk_discount").val());
                        var base_price = $("#base_price").text();
                        var quantity = parseFloat($("input[name='quantity']").val());

                        //logic for calculating amount
                        var grossValue = purchase * quantity * (1 - (bulk_discount / 100));
                        var gstValue = grossValue * (gst / 100);
                        var amount = (grossValue + gstValue).toFixed(2);

                        cartarray.push({
                            productId: productId,
                            productname: products,
                            brandname: brand,
                            salt: salt,
                            category_id: category_id,
                            gst: gst,
                            hsn: hsn,
                            punit: Punit,
                            sunit: Sunit,
                            moq: moq,

                            batch: batch,
                            expdate: exp,
                            conversion: conversion,
                            shelflabel: shelflabel,
                            mrp: mrp,
                            purchase: purchase,
                            free: free,
                            bulk_discount: bulk_discount,
                            base_price: base_price,
                            qty: quantity + free,
                            amt: amount,
                        })
                        console.log('cart details', cartarray);

                        setLocalData = JSON.stringify(cartarray);

                        localStorage.setItem("grncartdetails", setLocalData);

                        $("#medicinename").val("");
                        $("select[name = 'gst']").val('Select option');
                        $("#hsn").val("");
                        $("select[name='primary']").val('Primary');
                        $("select[name='secondary']").val('Secondary');
                        $("input[name='threshold']").val("");
                        $("#brand").val('')
                        $("#salt").val('')
                        $("select[name='category']").val('Select Category');

                        $("#batchname").val("");
                        $('[name="addexp"]').val('');
                        $("#conversion").val("");
                        $("#primarypopulate").text("");
                        $("#secondarypopulate").text("");
                        $("#shelflabel").val("");
                        $("#price").val("");
                        $("#addpur").val("");
                        $("#free_scheme").val("");
                        $("#bulk_discount").val("");
                        $("#base_price").text("");
                        $("input[name='quantity']").val("");

                    })

                    // logic for redering cart data on addtocart click 
                    $("#addtocart").on('click', function () {

                        cartItems = JSON.parse(localStorage.getItem('grncartdetails')) || [];
                        renderCart(cartItems);
                    });

                    //deletefunctionality
                    $("#cart").on("click", ".delete-button", function () {
                        var item = $(this).closest("tr");
                        var item_id = item.find(".card_id").text().trim();
                        var cartItemsinStorage = JSON.parse(localStorage.getItem('grncartdetails')) || [];
                        cartItemsinStorage.splice(item_id - 1, 1);
                        cartarray = cartItemsinStorage;
                        localStorage.setItem('grncartdetails', JSON.stringify(cartItemsinStorage));
                        renderCart(cartItemsinStorage);
                    });
                    //endofdeletefunctionality

                    //rendercart functionality
                    function renderCart(items) {
                        $('#cart').empty();

                        for (var i = 0; i < items.length; i++) {
                            htmlData = `
                          <tr>
                            <td class="card_id">${i + 1}</td>
                            <td><i class="fab fa-angular fa-lg text-danger me-3"></i> <strong>${items[i].productname}</strong></td>
                            <td>${items[i].batch}</td>
                            <td>${items[i].expdate}</td>
                            <td>${items[i].mrp}</td>
                            <td>${items[i].purchase}</td>
                            <td>${items[i].qty}</td>
                            <td>${items[i].punit}</td>
                            <td>${items[i].gst}</td>
                            <td>${items[i].bulk_discount}</td>
                            <td>${items[i].amt}</td>
                            <td>
                              <div class="action-btns">
                                <button type="button" class="delete-button btn p-0 mx-2"><i class="bx bx-trash me-1"></i></button>
                              </div>
                            </td>
                          </tr>
                          `

                            $('#cart').append(htmlData);
                        }
                    }
                    //end of rendereing data logic

                    //allchanges done for footer total;


                    var orderDetails;
                    var org = '<%=orgId%>'
                    $("#submitorder").click(function () {
                        if ($("#vendorselect").val() === 'Select Vendor') {
                            return alert('Please fill "Distributor Name"');
                        }
                        if ($("#vendorinvoicenumber").val() == '') {
                            return alert('Please fill "Distributor Invoice number"');
                        }
                        if (!$("#defaultCheck1").prop("checked")) {
                            return alert("Please check the disclaimer before submitting.");
                        }
                        $("#submitorder").prop('disabled', true);
                        var pharmacyDetails = JSON.parse(localStorage.getItem('name'));
                        var cartDetails = JSON.parse(localStorage.getItem("grncartdetails"));
                        var lessDiscount = $("#lessDiscount").val() || 0;
                        var totalPurchase = 0;

                        for (let i in cartDetails) {
                            totalPurchase += parseFloat(cartDetails[i].amt);
                        }

                        totalPurchase = totalPurchase - lessDiscount;

                        $.ajax({
                            url: `/api/creategrn/`,
                            type: 'POST',
                            data: JSON.stringify({
                                pharmacyId: pharmacyDetails.pharmaId,
                                vendor_id: vendorId,
                                vendor_invoice: $("#vendorinvoicenumber").val(),
                                total: totalPurchase,
                                org_id: org,
                                invoice_date: $("input[name='invoiceDate']").val(),
                                credit_period: $("#creditPeriodInput").val(),
                                less_discount: lessDiscount,
                                payment_method: $('input[name="paymentMethod"]').val(),
                            }),
                            contentType: 'application/json',
                            success: function (response) {

                                var GRNid = response.grn_invoice_no;


                                console.log('orderdetails of grn', cartDetails);

                                for (let i in cartDetails) {

                                    if (cartDetails[i].productId == null) {
                                        var customProductDetails = {
                                            org_id: org,
                                            med_name: cartDetails[i].productname,
                                            mfd_mkt: cartDetails[i].brandname,
                                            salt: cartDetails[i].salt,
                                            conversion: cartDetails[i].conversion,
                                        }

                                        $.ajax({
                                            url: '/api/createproduct',
                                            type: 'POST',
                                            data: JSON.stringify(customProductDetails),
                                            contentType: 'application/json',
                                            success: function (response) {
                                                console.log(response);
                                                cartDetails[i].productId = response.product_id;

                                                var productDetails = {
                                                    product_id: cartDetails[i].productId,
                                                    org_id: org,
                                                    category_id: cartDetails[i].category_id,
                                                    gst: cartDetails[i].gst,
                                                    hsn: cartDetails[i].hsn,
                                                    primary_unit: cartDetails[i].punit,
                                                    secondary_unit: cartDetails[i].sunit,
                                                    threshold: cartDetails[i].moq
                                                }

                                                console.log('product details', productDetails);
                                                $.ajax({
                                                    url: `/api/createinventory/`,
                                                    type: 'POST',
                                                    data: JSON.stringify(productDetails),
                                                    contentType: 'application/json',
                                                    success: function (response) {
                                                        var batchDetails = {
                                                            product_id: cartDetails[i].productId,
                                                            org_id: org,
                                                            batch_name: cartDetails[i].batch,
                                                            exp_date: cartDetails[i].expdate,
                                                            conversion: cartDetails[i].conversion,
                                                            batch_qty: cartDetails[i].qty,
                                                            purchase_rate: cartDetails[i].purchase,
                                                            mrp: cartDetails[i].mrp,
                                                            free: cartDetails[i].free,
                                                            bulk_discount: cartDetails[i].bulk_discount,
                                                            base_price: cartDetails[i].base_price,
                                                            shelf_label: cartDetails[i].shelflabel,
                                                            grn_id: GRNid
                                                        }

                                                        $.ajax({
                                                            url: `/api/addbatch/`,
                                                            type: 'POST',
                                                            data: JSON.stringify(batchDetails),
                                                            contentType: 'application/json',
                                                            success: function (response) {
                                                                $.ajax({
                                                                    url: `/api/creategrncarts`,
                                                                    type: 'POST',
                                                                    data: JSON.stringify({
                                                                        grn_id: GRNid,
                                                                        product_id: cartDetails[i].productId,
                                                                        gst: cartDetails[i].gst,
                                                                        category_id: cartDetails[i].category_id,
                                                                        hsn: cartDetails[i].hsn,
                                                                        punit: cartDetails[i].punit,
                                                                        sunit: cartDetails[i].sunit,
                                                                        moq: cartDetails[i].moq,
                                                                        batch_name: cartDetails[i].batch,
                                                                        exp: cartDetails[i].expdate,
                                                                        conversion: cartDetails[i].conversion,
                                                                        shelf_label: cartDetails[i].shelflabel,
                                                                        purchase: cartDetails[i].purchase,
                                                                        mrp: cartDetails[i].mrp,
                                                                        free: cartDetails[i].free,
                                                                        bulk_discount: cartDetails[i].bulk_discount,
                                                                        base_price: cartDetails[i].base_price,
                                                                        qty: cartDetails[i].qty,

                                                                    }),
                                                                    contentType: 'application/json',
                                                                    success: function (response) {
                                                                        console.log('grn done', response);
                                                                    },
                                                                    error: function (error) {
                                                                        console.log('error in grn', error);
                                                                        return alert("not Created", error)
                                                                    }
                                                                })
                                                                console.log(response);

                                                            },
                                                            error: function (error) {
                                                                console.log(error);
                                                                return alert("not Created", error)
                                                            }
                                                        })
                                                    },
                                                    error: function (error) {
                                                        console.log(error);
                                                        return alert("not Created", error)
                                                    }
                                                })

                                            },
                                        })
                                    }

                                    else {
                                        // If productId fetched (Product is in Master Database)
                                        $.get(`/api/checkbyid?product=${cartDetails[i].productId}&org=${orgID}`, function (data, status) {
                                            console.log(data.data);
                                            if (data.data.length === 0) {

                                                var productDetails = {
                                                    product_id: cartDetails[i].productId,
                                                    org_id: org,
                                                    category_id: cartDetails[i].category_id,
                                                    gst: cartDetails[i].gst,
                                                    hsn: cartDetails[i].hsn,
                                                    primary_unit: cartDetails[i].punit,
                                                    secondary_unit: cartDetails[i].sunit,
                                                    threshold: cartDetails[i].moq
                                                }


                                                $.ajax({
                                                    url: `/api/createinventory/`,
                                                    type: 'POST',
                                                    data: JSON.stringify(productDetails),
                                                    contentType: 'application/json',
                                                    success: function (response) {

                                                        var batchDetails = {
                                                            product_id: cartDetails[i].productId,
                                                            org_id: org,
                                                            batch_name: cartDetails[i].batch,
                                                            exp_date: cartDetails[i].expdate,
                                                            conversion: cartDetails[i].conversion,
                                                            batch_qty: cartDetails[i].qty,
                                                            purchase_rate: cartDetails[i].purchase,
                                                            mrp: cartDetails[i].mrp,
                                                            free: cartDetails[i].free,
                                                            bulk_discount: cartDetails[i].bulk_discount,
                                                            base_price: cartDetails[i].base_price,
                                                            shelf_label: cartDetails[i].shelflabel,
                                                            grn_id: GRNid
                                                        }
                                                        //console.log(batchDetails);

                                                        $.ajax({
                                                            url: `/api/addbatch/`,
                                                            type: 'POST',
                                                            data: JSON.stringify(batchDetails),
                                                            contentType: 'application/json',
                                                            success: function (response) {


                                                                $.ajax({
                                                                    url: `/api/creategrncarts`,
                                                                    type: 'POST',
                                                                    data: JSON.stringify({
                                                                        grn_id: GRNid,
                                                                        product_id: cartDetails[i].productId,
                                                                        gst: cartDetails[i].gst,
                                                                        category_id: cartDetails[i].category_id,
                                                                        hsn: cartDetails[i].hsn,
                                                                        punit: cartDetails[i].punit,
                                                                        sunit: cartDetails[i].sunit,
                                                                        moq: cartDetails[i].moq,
                                                                        batch_name: cartDetails[i].batch,
                                                                        exp: cartDetails[i].expdate,
                                                                        conversion: cartDetails[i].conversion,
                                                                        shelf_label: cartDetails[i].shelflabel,
                                                                        purchase: cartDetails[i].purchase,
                                                                        mrp: cartDetails[i].mrp,
                                                                        free: cartDetails[i].free,
                                                                        bulk_discount: cartDetails[i].bulk_discount,
                                                                        base_price: cartDetails[i].base_price,
                                                                        qty: cartDetails[i].qty,

                                                                    }),
                                                                    contentType: 'application/json',
                                                                    success: function (response) {
                                                                        console.log('grn done', response);
                                                                    },
                                                                    error: function (error) {
                                                                        console.log('error in grn', error);
                                                                        return alert("not Created", error)
                                                                    }
                                                                })
                                                                console.log(response);
                                                            },
                                                            error: function (error) {
                                                                console.log(error);
                                                                return alert("not Created", error)
                                                            }
                                                        })
                                                        console.log(response);
                                                    },
                                                    error: function (error) {
                                                        console.log(error);
                                                        return alert("not Created", error)
                                                    }
                                                })
                                            } else {
                                                var batchDetails = {
                                                    product_id: cartDetails[i].productId,
                                                    org_id: org,
                                                    batch_name: cartDetails[i].batch,
                                                    exp_date: cartDetails[i].expdate,
                                                    conversion: cartDetails[i].conversion,
                                                    batch_qty: cartDetails[i].qty,
                                                    purchase_rate: cartDetails[i].purchase,
                                                    mrp: cartDetails[i].mrp,
                                                    free: cartDetails[i].free,
                                                    bulk_discount: cartDetails[i].bulk_discount,
                                                    base_price: cartDetails[i].base_price,
                                                    shelf_label: cartDetails[i].shelflabel,
                                                    grn_id: GRNid
                                                }
                                                //console.log(batchDetails);

                                                $.ajax({
                                                    url: `/api/addbatch/`,
                                                    type: 'POST',
                                                    data: JSON.stringify(batchDetails),
                                                    contentType: 'application/json',
                                                    success: function (response) {

                                                        $.ajax({
                                                            url: `/api/creategrncarts`,
                                                            type: 'POST',
                                                            data: JSON.stringify({
                                                                grn_id: GRNid,
                                                                product_id: cartDetails[i].productId,
                                                                gst: cartDetails[i].gst,
                                                                hsn: cartDetails[i].hsn,
                                                                punit: cartDetails[i].punit,
                                                                sunit: cartDetails[i].sunit,
                                                                moq: cartDetails[i].moq,
                                                                batch_name: cartDetails[i].batch,
                                                                exp: cartDetails[i].expdate,
                                                                conversion: cartDetails[i].conversion,
                                                                shelf_label: cartDetails[i].shelflabel,
                                                                purchase: cartDetails[i].purchase,
                                                                mrp: cartDetails[i].mrp,
                                                                free: cartDetails[i].free,
                                                                bulk_discount: cartDetails[i].bulk_discount,
                                                                base_price: cartDetails[i].base_price,
                                                                qty: cartDetails[i].qty,

                                                            }),
                                                            contentType: 'application/json',
                                                            success: function (response) {
                                                                console.log('grn done', response);
                                                            },
                                                            error: function (error) {
                                                                console.log('error in grn', error);
                                                                return alert("Not Created", error)
                                                            }
                                                        })
                                                        console.log(response);
                                                    },
                                                    error: function (error) {
                                                        console.log(error);
                                                        return alert("Not Created", error)
                                                    }
                                                })
                                            }
                                        })

                                    }

                                }

                                setTimeout(() => {

                                    window.location.href = `/grn_receipt/${GRNid}`
                                }, 3000);

                            },
                            error: function (error) {
                                alert("Not Created", error)
                            }


                        })


                    })

                });





            </script>

    </body>

    </html>