<%- include('../partials/headercode.ejs') %>

  <body>

    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar  ">
      <div class="layout-container">

        <!-- sidebar imported -->
        <%- include('../partials/sidebar.ejs') %>


          <!-- Layout container -->
          <div class="layout-page">

            <!-- navbar imported -->
            <%- include('../partials/navbar.ejs') %>

              <!-- Content wrapper -->
              <div class="content-wrapper">


                <!-- Content -->

                <div class="container-xxl flex-grow-1 container-p-y">
                  <h4 class="fw-bold py-3 mb-1"> Sale Invoice</h4>
                  <hr class="mb-4">
                  <form>
                    <div class="row">

                      <tr>
                        <th>
                          <div class="col-md-6">
                            <div class="card mb-4">
                              <h5 class="card-header">Customer Mobile</h5>
                              <div class="card-body">
                                <div>

                                  <input type="text" class="form-control" id="phonenumber"
                                    aria-describedby="defaultFormControlHelp" placeholder="10-digit number" />

                                </div>
                              </div>
                            </div>
                          </div>
                        </th>

                        <th>

                          <div class="col-md-6">

                            <div class="card mb-4">
                              <div class="d-flex justify-content-between m-0 p-0">
                                <h5 class="card-header">Customer Name</h5>
                                <div class=" text-center mt-3 ">
                                  <a class="btn btn-primary mx-4" style="color: white;" id="addnewcustomer">Add Customer</a>
                                </div>
                              </div>
                              <div class="card-body pt-0">
                                <div>

                                  <input type="text" class="form-control" id="customername"
                                    aria-describedby="defaultFormControlHelp" placeholder="Customer name" />

                                </div>
                              </div>

                            </div>
                          </div>
                        </th>

                      </tr>
                    </div>
                
                  </form>
                </div>
              </div>




                <!-- Content

                <div class="container-xxl flex-grow-1 container-p-y">
                  <h4 class="fw-bold py-3 mb-1"> Sale Invoice</h4>
                  <hr class="mb-4">
                  <form>
                    <div class="row">

                      <tr>
                        <th>

                          <div class="col-md-6">

                            <div class="card mb-4">
                              <div class="d-flex justify-content-between m-0 p-0">
                                <h5 class="card-header">Customer Name</h5>
                                <div class=" text-center mt-3 ">
                                  <a class="btn btn-primary mx-4" style="color: white;" href="/new_customer">Add New
                                    Customer</a>
                                </div>
                              </div>
                              <div class="card-body pt-0">
                                <div>

                                  <input type="text" class="form-control" id="customername"
                                    aria-describedby="defaultFormControlHelp" placeholder="Customer name" />

                                </div>
                              </div>

                            </div>
                          </div>
                        </th>
                        <th>
                          <div class="col-md-6">
                            <div class="card mb-4">
                              <h5 class="card-header">Mobile Number</h5>
                              <div class="card-body">
                                <div>

                                  <input type="text" class="form-control" id="phonenumber"
                                    aria-describedby="defaultFormControlHelp" placeholder="10-digit number" />

                                </div>
                              </div>
                            </div>
                          </div>
                        </th>

                      </tr>
                    </div>

                    <div class="row">
                      <tr>
                        <th>
                          <div class="col-md-6">
                            <div class="card mb-4">
                              <h5 class="card-header">Date</h5>
                              <div class="card-body">
                                <div>

                                  <input class="form-control" type="date" id="date" />

                                </div>
                              </div>
                            </div>
                          </div>
                        </th>

                        <th>
                          <div class="col-md-6">
                            <div class="card mb-4">
                              <h5 class="card-header">Mode of Payment</h5>
                              <div class="card-body">
                                <div>

                                  <select class="form-select" id="mop" name="mop" aria-label="select mop">
                                    <option selected disabled>Select Option</option>
                                    <option value="cash">Cash</option>
                                    <option value="upi">UPI</option>
                                    <option value="debit-card">Debit card</option>
                                    <option value="credit-card">Credit card</option>

                                  </select>

                                </div>
                              </div>
                            </div>
                          </div>
                        </th>

                      </tr>
                    </div>

                  </form>
                </div>
              </div> -->


              <div class="row mx-3">
                <h4 class="fw-bold mb-4">Add Items</h4>

                <!-- Bordered Table -->
                <div class="bordered-table card mb-4 mx-0">

                  <form class="form-main">
                    <div class="card-body form-block">
                      <div class="table-responsive text-nowrap ">

                        <table class="table table-bordered">
                          <thead>
                            <tr>
                              <th class="col-6">Product Name</th>
                              <th class="col-5">Mfg / Mkt</th>
                              <th class="col-1">Shelf Label</th>
                            </tr>

                          </thead>
                          <tbody>
                            <tr>
                              <td>
                                <input type="text" class="form-control" id="medicinename" placeholder="Medicine Name" />
                              </td>
                              <td>
                                <input type="text" class="form-control" id="mfg/mkt" placeholder="Brand Name" />
                              </td>
                              <td>
                                <input type="text" class="form-control" id="shelflabel" placeholder="" />
                              </td>
                            </tr>
                          </tbody>

                        </table>


                        <table class="table table-bordered">
                          <thead>
                            <tr>
                              <th>Batch</th>
                              <th>Exp Date</th>
                              <th>Unit</th>
                              <th>MRP</th>
                              <th>QTY</th>
                              <th>Disc %</th>
                              <th>Total</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr>

                              <td>
                                <input type="text" class="form-control" id="batch" placeholder="" />
                              </td>

                              <td>
                                <input class="form-control" type="date" id="expdate" />
                              </td>

                              <td>
                                <select class="form-select" id="unit" name="unit" aria-label="unit">
                                  <option>TABS</option>
                                  <option>STP</option>
                                </select>
                                <p class="unit">1 strip = 20 tabs </p>
                              </td>

                              <td>
                                <input type="text" class="form-control" id="price" placeholder="" />
                              </td>

                              <td>
                                <input type="text" class="form-control" id="qty" placeholder="" />
                              </td>

                              <td>
                                <input type="text" class="form-control" id="discount" placeholder="" />
                              </td>

                              <td>
                                <input type="text" class="form-control" id="total" placeholder="" />
                              </td>
                            </tr>




                          </tbody>

                        </table>
                      </div>
                    </div>
                    <div class="buttonBox text-center pb-3">
                      <btn class="btn btn-primary" style="color: white;" id="addtocart">Add to
                        Cart</btn>
                      <input type="reset" class="btn btn-primary" style="color: white;" value="Clear" />
                    </div>
                  </form>
                </div>

                <!--/ Bordered Table -->


                <!-- Product Cart -->
                <div class="card mx-0">
                  <h5 class="card-header">Cart</h5>
                  <div class="card-body">
                    <div class="table-responsive text-nowrap">
                      <table class="table table-bordered">
                        <thead>
                          <tr>
                            <th class="col-1">#</th>
                            <th class="col-7">Product name</th>
                            <th class="col-1">Qty</th>
                            <th class="col-1">MRP</th>
                            <th class="col-1">Disc %</th>
                            <th class="col-1">Total</th>
                            <th class="col-1">Action</th>

                          </tr>
                        </thead>
                        <tbody id="cart">
                          <!-- <tr>
                            <td>1</td>
                            <td><i class="fab fa-angular fa-lg text-danger me-3"></i> <strong>Calpol 1000mg
                                Tablet</strong></td>
                            <td>3</td>
                            <td>35</td>
                            <td>5</td>
                            <td>115</td>
                            <td>
                              <div class="action-btns">
                                <button type="button" class="btn p-0 mx-2"><i class='bx bxs-edit'></i></button>
                                <button type="button" class="btn p-0 mx-2"><i class="bx bx-trash me-1"></i></button>
                              </div>
                            </td>
                          </tr> -->


                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <!-- / Product Cart -->
              </div>

              <hr>

              <div class="row mx-3">



                <div class="d-flex row m-0 p-0">
                  <h4 class="col-7 fw-bold py-3 mb-4">Order Summary</h4>
                  <div class="col-5">
                    <div class="mb-1 row">
                      <label for="html5-text-input" class="col-2 col-form-label">Reference</label>
                      <div class="col-10">
                        <input class="form-control" type="text" placeholder="Doctor/Hospital" id="html5-text-input" />
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-md-3">
                  <div class="card mb-4">
                    <h5 class="card-header"> Subtotal</h5>
                    <div class="card-body">
                      <div>

                        <input type="text" class="form-control" id="defaultFormControlInput"
                          aria-describedby="defaultFormControlHelp" />

                      </div>
                    </div>
                  </div>
                </div>


                <div class="col-md-3">
                  <div class="card mb-4">
                    <h5 class="card-header">Add Discount (%)</h5>
                    <div class="card-body">
                      <div>

                        <input type="text" class="form-control" id="defaultFormControlInput"
                          aria-describedby="defaultFormControlHelp" />

                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-md-3">
                  <div class="card mb-4">
                    <div class="d-flex justify-content-between m-0 p-0">
                      <h5 class="card-header">Final Amount</h5>
                      <div class="text-center m-3">
                        <a class="btn btn-primary btn-sm" style="color: white;">Round Off</a>
                      </div>
                    </div>

                    <div class="card-body pt-0">
                      <div>

                        <input type="text" class="form-control" id="defaultFormControlInput"
                          aria-describedby="defaultFormControlHelp" />

                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-md-3">
                  <div class="card mb-1">
                    <h5 class="card-header">Paid Amount</h5>
                    <div class="card-body">
                      <div>

                        <input type="text" class="form-control" id="defaultFormControlInput"
                          aria-describedby="defaultFormControlHelp" />

                      </div>
                    </div>
                  </div>
                  <p class="card-header py-2 px-3">Change: </p>
                </div>






              </div>
              <!-- / Content -->



              <div class="text-center mb-4">
                <a href="/invoice_template">
                  <div class="btn btn-primary px-5">Submit</div>
                </a>
              </div>




              <div class="content-backdrop fade"></div>
          </div>
          <!-- Content wrapper -->
      </div>
      <!-- / Layout page -->
    </div>



    <!-- Overlay -->
    <div class="layout-overlay layout-menu-toggle"></div>


    </div>
    <!-- / Layout wrapper -->

    <%- include('../partials/footercode.ejs') %>
      <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
      <script>
        
        var customerPhones =[];
        var customerData = [];
        var customerName =[];
        var cartarray =[];
        var selectedCustomer;
        var selectedTelephone;

        $(document).ready(function () {

// get customer data and show it in the autocomplete function
          $.get('/api/cust/', function (data, status) {

            for (let i in data.data) {
             
              customerData.push({phone: JSON.stringify(data.data[i].cust_telephone), name: data.data[i].cust_name});

            //if want customer phone to autopopulate->
            // var options = `${data.data[i].cust_name} (${data.data[i].cust_telephone})`;
            // customerName.push(options)
            }

            $("#phonenumber").autocomplete({
              //source: customerData.map(function(customer) {
              //        return customer.name + ' (' + customer.phone + ')';
              //        }),
              source: customerData.map(function(customer){
                return customer.phone;
              }),
              select: function(event, ui) {
                selectedCustomerNumber = JSON.parse(ui.item.value);
                selectedCustomerName = customerData.find(c => c.phone == selectedCustomerNumber);
                $("#customername").val(selectedCustomerName.name);
                
//if wanted to populate customer number through name->
                //var name = selectedCustomer.split(' ')[0];
                //var number = selectedCustomer.match(/\(([^)]+)\)/)[1];
                //console.log("selected", selectedCustomer);

               // $("#customername").val(selectedCustomer.split(' ')[0]);
               // $("#phonenumber").val(number);
              
              }
            })
            $("#phonenumber").change(function(){
              
              var phone = $(this).val();
              
              if(customerData.find(c => c.phone != phone)){
                
                var newCustomerName;
                
                $("#customername").keyup(function(){
                  newCustomerName = $(this).val();
                  console.log(newCustomerName);
                })
                

               

                $("#addnewcustomer").click(function(){
                  var addCustomerData ={
                    cust_name: newCustomerName,
                    cust_telephone :phone
                  }
                  console.log(addCustomerData);

                  $.ajax({
                    url: '/api/cust/',
                    type:'POST',
                    data: JSON.stringify(addCustomerData),
                    contentType: 'application/json',
                    success: function(response){
                      location.reload();
                    },
                    error: function(error){
                      alert("not Created", error )
                    }
                  })

                  
                })

              }

            })
          })
      //end of autocomplete function

      //start of product cart 
          var product=[];
          var i=0;
          $.get('/api/cust/', function (data, status) {

            for(let i in data.data){
              product.push(data.data[i].cust_name);
            }

            $("#medicinename").autocomplete({
              source: product
            })
          })

          //var productname = $("medicinename").val();
          var quantityInput = $("#qty");
          var priceInput = $("#price");
          var discInput = $("#discount");
          var totalInput = $("#total");

          quantityInput.on("input", calculateTotal);
          priceInput.on("input", calculateTotal);
          discInput.on("input", calculateTotal);


          function calculateTotal() {
            var quantity = parseInt(quantityInput.val()) || 0;
            var price = parseFloat(priceInput.val()) || 0;
            var discount = parseFloat(discInput.val()) || 0;
            discount = discount/100;
            var total = quantity * price - (quantity * price* discount) ;

        
            totalInput.val(total.toFixed(2));
          }

          //getting data when referesh
          var cartItems = JSON.parse(localStorage.getItem('cartitems')) || [];
          renderRefreshCart(cartItems);

          function renderRefreshCart(items) {
            $('#cart').empty();
            for (var i = 0; i < items.length; i++) {
              cartarray.push(items[i]);

              htmlData = `
                        <tr>
                          <td class="card_id">${i+1}</td>
                          <td><i class="fab fa-angular fa-lg text-danger me-3"></i> <strong>${items[i].productname}</strong></td>
                          <td>${items[i].qty}</td>
                          <td>${items[i].mrp}</td>
                          <td>${items[i].disc}</td>
                          <td>${items[i].total}</td>
                          <td>
                            <div class="action-btns">
                              <button type="button" class="edit-button btn p-0 mx-2"><i class='bx bxs-edit'></i></button>
                              <button type="button" class="delete-button btn p-0 mx-2"><i class="bx bx-trash me-1"></i></button>
                            </div>
                          </td>
                        </tr>
                        `
              $('#cart').append(htmlData);
            }
          }
          //end of logic for referesh data

            
            var setLocalData;
            var getLocalData;
            var htmlData;
            $("#addtocart").click(function(){
                      var products = $("#medicinename").val();  
                      var qty = quantityInput.val();
                      var mrp =priceInput.val();
                      var disc =discInput.val();
                      var total = totalInput.val();

                cartarray.push({productname: products, qty: qty, mrp: mrp, disc: disc, total:total, timestamp: new Date().getTime()})
                      console.log("object", cartarray);
                      setLocalData = JSON.stringify(cartarray);
                      
                      localStorage.setItem("cartitems", setLocalData);

                      $("#medicinename").val("");
                      $("#qty").val("");
                      $("#price").val("");
                      $("#discount").val("");
                      $("#total").val("");
             
                    })
     
                  

          // logic for redering cart data on addtocart click 
            $("#addtocart").on('click', function(event) {              
              cartItems = JSON.parse(localStorage.getItem('cartitems')) || [];
              renderCart(cartItems);
            });

//deletefunctionality
            $("#cart").on("click", ".delete-button", function() {
              var item = $(this).closest("tr");
              var item_id =item.find(".card_id").text().trim();
              var cartItemsinStorage = JSON.parse(localStorage.getItem('cartitems')) || [];
              cartItemsinStorage.splice(item_id - 1,1);
            //  console.log("objectclicked", cartItemsinStorage);
              cartarray = cartItemsinStorage;
            // console.log("cartarray", cartarray);
              localStorage.setItem('cartitems', JSON.stringify(cartItemsinStorage));
              renderCart(cartItemsinStorage);
            });
//endofdeletefunctionality


//edit functionalituy  
            $("#cart").on("click", ".edit-button", function(){
              var item = $(this).closest("tr");
              var item_id =item.find(".card_id").text().trim();
              var UpdatecartItemsinStorage = JSON.parse(localStorage.getItem('cartitems')) || [];
              var selectedItem = UpdatecartItemsinStorage[item_id-1];
    
                $("#medicinename").val(selectedItem.productname);
                $("#qty").val(selectedItem.qty);
                $("#price").val(selectedItem.mrp);
                $("#discount").val(selectedItem.disc);
                $("#total").val(selectedItem.total);

                UpdatecartItemsinStorage.splice(item_id - 1,1);
                cartarray = UpdatecartItemsinStorage;
                localStorage.setItem('cartitems', JSON.stringify(UpdatecartItemsinStorage));
                renderCart(UpdatecartItemsinStorage);

            })
//end of edit functionality


            function renderCart(items) {
              $('#cart').empty();

              for (var i = 0; i < items.length; i++) {
                console.log(items[i]);
                htmlData = `
                          <tr>
                            <td class="card_id">${i+1}</td>
                            <td><i class="fab fa-angular fa-lg text-danger me-3"></i> <strong>${items[i].productname}</strong></td>
                            <td>${items[i].qty}</td>
                            <td>${items[i].mrp}</td>
                            <td>${items[i].disc}</td>
                            <td>${items[i].total}</td>
                            <td>
                              <div class="action-btns">
                                <button type="button" class="edit-button btn p-0 mx-2"><i class='bx bxs-edit'></i></button>
                                <button type="button" class="delete-button btn p-0 mx-2"><i class="bx bx-trash me-1"></i></button>
                              </div>
                            </td>
                          </tr>
                          `
                $('#cart').append(htmlData);
              }
            }
            //end of rendereing data logic
         

//implementing time after which cart clears itself
            function checkExpiration() {
              var data = JSON.parse(localStorage.getItem('cartitems'));
              var currentTime = new Date().getTime();
              if (data && (currentTime - data[data.length-1].timestamp) >= ( 60 * 60 * 1000)) {
                console.log("expired");
                localStorage.removeItem('cartitems');
              }
            }

            setTimeout(function() {
              console.log("checking");
              checkExpiration();
            }, 3600000);

//end of this function
/*
              var newRow = $("<tr>");
              newRow.addClass("cart-item");

                var index = $("<td>").addClass("index").text(i);
                var productName = $("<td>").addClass("updateproduct").text(products);
                  var qtys = $("<td>").addClass("updateqty").text(qty);
                  var mrps = $("<td>").addClass("updateprice").text(mrp);
                  var discs = $("<td>").addClass("updatedisc").text(disc);
                  var totals = $("<td>").addClass("updatetotal").text(total);
                 
               
                  var actionButtons = $("<div>").addClass("action-btns");
                  var editButton = $("<button>").addClass("edit-button btn p-0 mx-2").attr("type", "button").html("<i class='bx bxs-edit'></i>");
                  var deleteButton = $("<button>").addClass("delete-button btn p-0 mx-2").attr("type", "button").html("<i class='bx bx-trash me-1'></i>");

                  actionButtons.append(editButton, deleteButton);

                newRow.append(index, productName, qtys,mrps, discs, totals, $("<script>").append(actionButtons));
                $("#cart").append(newRow);
*/ 


 

                //deleting an item
              
                
                  //item.remove();
/*
                $("#cart").on("click", ".edit-button", function(){
                    var updateElement = $(this).closest("tr")
                    var productName = updateElement.find(".updateproduct").text().trim();
                    var qtyUpdate = updateElement.find(".updateqty").text().trim();
                    var priceUpdate = updateElement.find(".updateprice").text().trim();
                    var discUpdate = updateElement.find(".updatedisc").text().trim();
                    var totalUpdate = updateElement.find(".updatetotal").text().trim();
                    
                $("#medicinename").val(productName);
                $("#qty").val(qtyUpdate);
                $("#price").val(priceUpdate);
                $("#discount").val(discUpdate);
                $("#total").val(totalUpdate);
                
                
                updateElement.remove();
              }) 
              */
              
              
              
        
        
              
              
              
              
              
              
              
              
            })

          </script>
      <script>
        var addToCart = document.getElementById("addtocart")
        addToCart.addEventListener("click", displayItems)

        var row = 0

        function displayItems() {

          var medicinename = document.getElementById("medicinename").value
          var shelflabel = document.getElementById("shelflabel").value
          var hsn = document.getElementById("hsn").value
          var batch = document.getElementById("batch").value
          var mfgdate = document.getElementById("mfgdate").value
          var expdate = document.getElementById("expdate").value
          var price = document.getElementById("price").value
          var qty = document.getElementById("qty").value
          var discount = document.getElementById("discount").value
          var gst = document.getElementById("gst").value
          var total = document.getElementById("total").value

          var cart = document.getElementById("cart");

          var newRow = cart.insertRow(row);

          var cell1 = newRow.insertCell(0);
          var cell2 = newRow.insertCell(1);
          var cell3 = newRow.insertCell(2);
          var cell4 = newRow.insertCell(3);
          var cell5 = newRow.insertCell(4);
          var cell6 = newRow.insertCell(5);
          var cell7 = newRow.insertCell(6);

          actionHTML = "<div class='action-btns'><button type='button' class='btn p-0 mx-2'><i class='bx bxs-edit'></i></button><button onclick='deleteItem(this)' type='button' class='btn p-0 mx-2'><i class='bx bx-trash me-1'></i></button></div>";

          cell1.innerHTML = row + 1;
          cell2.innerHTML = medicinename;
          cell3.innerHTML = qty;
          cell4.innerHTML = price;
          cell5.innerHTML = discount;
          cell6.innerHTML = total;
          cell7.insertAdjacentHTML("afterbegin", actionHTML);

          row++;
        };

        function deleteItem(r) {
          var i = r.parentNode.parentNode.rowIndex;
          document.getElementById("cart").deleteRow(i + 1);
        };

      </script>







  </body>


  </html>























